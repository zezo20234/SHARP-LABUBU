<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Login, Report, Shop & Credits Sender with Signature</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2b4c7e" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<!-- Viewport for mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 30px auto;
    padding: 10px;
    background: linear-gradient(135deg, #f0f4f9, #d9e4f5);
    color: #333;
    font-size: 1rem;
    line-height: 1.4;
}

@media (max-width: 700px) {
  body {
    max-width: 100%;
    margin: 10px;
    padding: 10px 15px;
  }
}

h2, h3 { 
    color: #2b4c7e; 
    margin-bottom: 10px; 
}

button, input, select {
    width: 100%;
    max-width: 100%;
    padding: 12px;
    margin-top: 6px;
    font-size: 1.1rem;
    box-sizing: border-box;
    border-radius: 6px;
    border: 1px solid #ccc;
    touch-action: manipulation;
}

button {
    background: #2b4c7e;
    color: white;
    cursor: pointer;
    user-select: none;
}

button:hover {
    background: #1f3557;
}

#user-info {
    position: fixed; 
    top: 10px; 
    left: 10px;
    background: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: bold;
    display: none;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: calc(100vw - 20px);
    word-wrap: break-word;
}

@media (max-width: 500px) {
    #user-info {
      font-size: 0.9rem;
      padding: 8px 10px;
      top: auto;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 95vw;
      text-align: center;
    }
}

#logoutBtn {
    background: #e74c3c;
    margin-top: 8px;
    font-size: 0.9rem;
    padding: 8px;
}

#logoutBtn:hover {
    background: #c0392b;
}

#login-form, #report-form {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

label {
    font-weight: bold;
    margin-top: 15px;
    display: block;
}

.rules-list {
    margin-top: 10px;
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #fafafa;
}

.rule-item {
    padding: 8px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.rule-item:hover {
    background: #e6f0ff;
}
.rule-item.selected {
    background: #d20e0e;
    color: white;
    animation: bounceForward 0.45s ease; /* Slower, smoother bounce */
}

.rule-details {
    font-size: 0.9rem;
    color: inherit;
    margin-top: 4px;
    flex-basis: 100%;
}

.rule-qty {
    width: 50px;
    margin-left: 10px;
    font-size: 1rem;
}

.action-buttons {
    margin-top: 20px;
    text-align: center;
}
.action-buttons button {
    width: auto;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1rem;
    user-select: none;
}
.action-buttons button:nth-child(1) {
    background: #27ae60;
}
.action-buttons button:nth-child(1):hover {
    background: #1e8449;
}
.action-buttons button:nth-child(2) {
    background: #2980b9;
}
.action-buttons button:nth-child(2):hover {
    background: #1f6391;
}

#shopContainer, #creditsSenderContainer {
    border: 1px solid #ccc;
    padding: 15px;
    margin-top: 15px;
    border-radius: 8px;
    background: white;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: scaleY(0.9);
    transition: all 0.4s ease;
}
#shopContainer.show, #creditsSenderContainer.show {
    max-height: 800px;
    overflow-y: auto;
    opacity: 1;
    transform: scaleY(1);
}

#welcomeOverlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(80, 80, 80, 0.7);
  color: white;
  font-size: 2rem;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  cursor: pointer;
  text-align: center;
  padding: 20px;
}
#welcomeOverlay small {
  font-size: 1.2rem;
  margin-top: 15px;
  opacity: 0.8;
}

/* === NEW ANIMATIONS === */

/* Button bounce backward (away) */
@keyframes bounceBack {
  0%   { transform: scale(1); }
  30%  { transform: scale(0.92); }
  60%  { transform: scale(1.02); }
  100% { transform: scale(1); }
}
button:active {
  animation: bounceBack 0.25s ease;
}

/* Rule bounce forward (towards) */
@keyframes bounceForward {
  0%   { transform: scale(1); }
  30%  { transform: scale(1.08); }
  60%  { transform: scale(0.98); }
  100% { transform: scale(1); }
}
.rule-item.bounce {
  animation: bounceForward 0.25s ease;
}

</style>
</head>
<body>

<!-- Welcome Overlay -->
<div id="welcomeOverlay">
  <div id="welcomeText"></div>
  <small>Click to continue</small>
</div>
<audio id="welcomeAudio" src="header-39344.mp3"></audio>

<div id="user-info">
    Days: <span id="days-count">0</span> | LAZUZU <img src="LAZUZU.jpg" style="width:1em;height:1em;vertical-align:middle;">: <span id="credits-count">0</span> | Signature Days Left: <span id="sig-days-left">0</span>
    <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="login-form">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <label><input type="checkbox" id="keepSignedIn"> Keep me signed in</label>
    <button id="loginBtn">Login</button>
</div>

<div id="report-form" style="display:none;">
    <h2>Report Form</h2>
    <form id="reportForm">
        <label>Your Username</label>
        <input type="text" id="reporter" readonly />
        <label>Who is this report on?</label>
        <select id="reportedUser" required></select>
        <label>Rules broken:</label>
        <div class="rules-list" id="rulesList"></div>
        <div id="total-days">Total Days Penalty: 0</div>
        <button type="submit" style="margin-top:20px;">Submit Report</button>
    </form>
</div>

<div class="action-buttons" id="action-buttons" style="display:none;">
    <hr>
    <button onclick="togglePanel('shopContainer')">Toggle Shop</button>
    <button onclick="togglePanel('creditsSenderContainer')">Toggle Send LAZUZU <img src="LAZUZU.jpg" style="width:1em;height:1em;vertical-align:middle;"></button>
</div>

<div id="shopContainer">
    <h3>- Days Shop (Spend LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> to reduce days)</h3>
     <button onclick="buyItem(150, 1)">Buy: 150 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 1 day</button><br>
    <button onclick="buyItem(500, 5)">Buy: 500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 5 days</button><br>
    <button onclick="buyItem(1500, 15)">Buy: 1500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 15 days</button><br>
    <button onclick="buyItem(2500, 25)">Buy: 2500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 25 days</button><br>
    <button onclick="buyItem(3500, 35)">Buy: 3500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 35 days</button><br>
    <button onclick="buyItem(4500, 45)">Buy: 4500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 45 days</button><br><br>
    <button onclick="buyItem(5500, 55)">Buy: 5500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 55 days</button><br><br>
    <button onclick="buyItem(6500, 65)">Buy: 6500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 65 days</button><br><br>
    <button onclick="buyItem(7500, 75)">Buy: 7500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 75 days</button><br><br>
    <button onclick="buyItem(9000, 85)">Buy: 9000 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 85 days</button><br><br>
    <button onclick="buyItem(10500, 100)">Buy: 10500 LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"> → Remove 100 days</button><br><br>
</div>


<div id="creditsSenderContainer">
    <h3>Send LAZUZU <img src="LAZUZU.jpg" style="width:2em;height:2em;vertical-align:middle;"></h3>
    <label>Send to:</label>
    <select id="sendToUser"></select>
    <label>Amount:</label>
    <input type="number" id="sendAmount" min="1" />
    <button onclick="sendCredits()">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null, currentUserData = null;
const daysSpan = document.getElementById("days-count");
const creditsSpan = document.getElementById("credits-count");
const sigDaysLeftSpan = document.getElementById("sig-days-left");
const reportedUserSelect = document.getElementById("reportedUser");
const sendToUserSelect = document.getElementById("sendToUser");
const reporterInput = document.getElementById("reporter");
const logoutBtn = document.getElementById("logoutBtn");

const welcomeOverlay = document.getElementById("welcomeOverlay");
const welcomeText = document.getElementById("welcomeText");
const welcomeAudio = document.getElementById("welcomeAudio");

const rules = [
    { id: 'no_hit', title: 'No hit', days: 1, details: 'Do not physically hurt anyone, as a joke is ok +1 days.' },
    { id: 'no_scream', title: 'No scream', days: 5, details: 'Speak calmly, only when you are excited or angry +5 days.' },
    { id: 'no_cry', title: 'No cry', days: 1, details: 'Crying is not allowed +1 days.' },
    { id: 'zeyad_devices', title: 'Zeyad can no longer make you play with devices when you have days.', days: 20, details: 'If Zeyad makes you play with devices when you have days, +20 days to Zeyad!' },
    { id: 'no_fetn', title: 'No fetn', days: 100, details: 'Don\'t make FETN. If someone tells you “blip” please don’t tell or repeat it to anyone. +100 days.' },
    { id: 'no_bother', title: 'No bother', days: 5, details: 'Respect others. Don’t annoy them. +5 days.' },
    { id: 'respect', title: 'You have to respect', days: 10, details: 'Treat everyone kindly and with respect, always. +10 days.' },
    { id: 'cute', title: 'CUTE +50 DAYS', days: 50, details: 'Be cute for 5 minutes = +50 days!' },
    { id: 'no_listen', title: 'No listen', days: 50, details: 'You have to listen! If not, +50 days.' },
    { id: 'play_zezo', title: 'Play with Zezo', days: 50, details: 'You must play with Zezo. If not, +50 days.' },
    { id: 'no_sad', title: 'No sad', days: 10, details: 'Don’t be sad or +10 days.' },
    { id: 'no_devices', title: 'No devices when u have days each minute = 5 days', days: 5, details: 'When you have days, don’t use devices. Each minute = +5 days!' },
    { id: 'no_copy', title: 'No copy', days: 100, details: 'You need proof (note, message) that someone gave you permission to copy them.' },
    { id: 'no_angry', title: 'No angry', days: 5, details: 'Don’t be mad +5 days.' },
    { id: 'dont_ask_zeyad', title: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS', days: 50, details: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS +50 DAYS' },
    { id: 'no_lie', title: 'No lie', days: 30, details: 'Do not lie, always tell the truth. +30 days.' },
    { id: 'no_pause', title: 'No pause', days: 10, details: 'No pauses. +10 days.' }
     { id: 'no_push', title: 'No push', days: 5, details: 'no push +5 days.' }
];

// Render rules list
function renderRules() {
    const container = document.getElementById('rulesList');
    container.innerHTML = '';
    rules.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'rule-item';
        div.dataset.id = r.id;
        div.dataset.days = r.days;

        const textContainer = document.createElement('div');
        textContainer.style.flex = "1";
        textContainer.innerHTML = `<strong>${r.title}</strong><div class="rule-details">${r.details}</div>`;

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.min = 0;
        qtyInput.value = 0;
        qtyInput.className = 'rule-qty';
        qtyInput.addEventListener('input', updateTotalDays);

        div.appendChild(textContainer);
        div.appendChild(qtyInput);

        div.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'input') {
                div.classList.toggle('selected');
                if (div.classList.contains('selected') && qtyInput.value == 0) qtyInput.value = 1;
                else if (!div.classList.contains('selected')) qtyInput.value = 0;
                updateTotalDays();
            }
        });

        container.appendChild(div);
        if (i < rules.length - 1) container.appendChild(document.createElement('hr'));
    });
}

renderRules();

function updateTotalDays() {
    let total = 0;
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        const daysPerOffense = parseInt(item.dataset.days);
        total += daysPerOffense * qty;
    });
    document.getElementById('total-days').textContent = `Total Days Penalty: ${total}`;
}

async function loadUsersDropdowns() {
    const snap = await get(ref(db, "users"));
    if (snap.exists()) {
        reportedUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
        sendToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
        Object.keys(snap.val()).forEach(user => {
            reportedUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
            if (user !== currentUser) sendToUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
        });
    }
}
async function login(username, password, keep) {
  const userRef = ref(db, `users/${username}`);
  const snap = await get(userRef);
  if (!snap.exists()) return alert("User not found");
  const data = snap.val();
  if (data.password !== password) return alert("Incorrect password");

  currentUser = username;
  currentUserData = data;

  // Get signature expiry and last login time
  const signature = data.signature || null;
  const expiry = signature?.expiry || 0;
  const lastLogin = data.lastLogin || 0;

  // Check if signature exists and not expired (expiry is timestamp in ms)
  if (!signature || expiry <= Date.now()) {
    // Signature expired or missing, reset days, credits, signature and redirect
    await update(userRef, {
      days: 0,
      credits: 0,
      signature: null,
      lastLogin: Date.now()
    });
    alert("Your signature expired or not found. You need to create a new signature now.");
    window.location.href = "signature.html?user=" + encodeURIComponent(username);
    return;
  }

  // Calculate how many midnights passed since last login
  const now = new Date();
  const lastLoginDate = new Date(lastLogin);

  // Function to get the midnight (00:00:00) time for a given date
  function getMidnight(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  const nowMidnight = getMidnight(now);
  const lastLoginMidnight = getMidnight(lastLoginDate);

  // Calculate full days passed between last login midnight and now midnight
  // This is the number of midnights passed
  const msPerDay = 1000 * 60 * 60 * 24;
  let daysPassed = Math.floor((nowMidnight - lastLoginMidnight) / msPerDay);

  // If user is logging in for the first time, lastLogin might be 0, handle that
  if (!lastLogin || lastLogin === 0) {
    daysPassed = 0; // no days to subtract
  }

  // Subtract daysPassed from current days, but don't go below 0
  let updatedDays = (data.days || 0) - daysPassed;
  if (updatedDays < 0) updatedDays = 0;

  // Also check signature expiry days left (full days remaining from expiry timestamp)
  const msLeft = expiry - Date.now();
  const sigDaysLeft = Math.ceil(msLeft / msPerDay);
  const displayDaysLeft = sigDaysLeft > 0 ? sigDaysLeft : 0;

  // Save the updated days and lastLogin time to Firebase
  await update(userRef, {
    days: updatedDays,
    lastLogin: Date.now()
  });

  // Update local data
  currentUserData.days = updatedDays;
  currentUserData.lastLogin = Date.now();

  // Show welcome overlay
  welcomeText.textContent = `Welcome back, ${username}!`;
  welcomeOverlay.style.display = "flex";

  // Wait for user click, play audio, then continue
  await new Promise(resolve => {
    function onClick() {
      welcomeOverlay.removeEventListener("click", onClick);
      welcomeAudio.play();
      // Hide overlay with fade out
      welcomeOverlay.style.transition = "opacity 0.7s ease";
      welcomeOverlay.style.opacity = 0;
      setTimeout(() => {
        welcomeOverlay.style.display = "none";
        welcomeOverlay.style.opacity = 1;
        resolve();
      }, 700);
    }
    welcomeOverlay.addEventListener("click", onClick);
  });

  // Show user info and main forms
  document.getElementById("login-form").style.display = "none";
  document.getElementById("report-form").style.display = "block";
  document.getElementById("action-buttons").style.display = "block";
  document.getElementById("user-info").style.display = "block";
  logoutBtn.style.display = "inline-block";
  reporterInput.value = username;
  daysSpan.textContent = updatedDays;
  creditsSpan.textContent = data.credits || 0;
  sigDaysLeftSpan.textContent = displayDaysLeft;

  await loadUsersDropdowns();
}


logoutBtn.onclick = () => {
    currentUser = null;
    currentUserData = null;
    document.getElementById("login-form").style.display = "block";
    document.getElementById("report-form").style.display = "none";
    document.getElementById("action-buttons").style.display = "none";
    document.getElementById("user-info").style.display = "none";
    logoutBtn.style.display = "none";
};

// === KEEP ME SIGNED IN LOGIC ===

// When the login button is clicked
document.getElementById("loginBtn").onclick = () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const keep = document.getElementById("keepSignedIn").checked;
    if (!username || !password) return alert("Please enter username and password.");

    // Save credentials depending on keep setting
    if (keep) {
        localStorage.setItem("loginData", JSON.stringify({ username, password }));
        sessionStorage.removeItem("loginData");
    } else {
        sessionStorage.setItem("loginData", JSON.stringify({ username, password }));
        localStorage.removeItem("loginData");
    }

    login(username, password, keep);
};

// When logout is clicked
logoutBtn.onclick = () => {
    currentUser = null;
    currentUserData = null;
    localStorage.removeItem("loginData");
    sessionStorage.removeItem("loginData");
    document.getElementById("login-form").style.display = "block";
    document.getElementById("report-form").style.display = "none";
    document.getElementById("action-buttons").style.display = "none";
    document.getElementById("user-info").style.display = "none";
    logoutBtn.style.display = "none";
};

// Auto-login if saved credentials exist
window.addEventListener("load", () => {
    let saved = localStorage.getItem("loginData") || sessionStorage.getItem("loginData");
    if (saved) {
        try {
            const { username, password } = JSON.parse(saved);
            // Silent = true will skip welcome overlay on page load
            login(username, password, true, true);
        } catch (e) {
            console.error("Failed to parse saved login:", e);
        }
    }
});


document.getElementById("reportForm").onsubmit = async e => {
    e.preventDefault();
    if (!currentUser) return alert("Please login first.");
    const reportedUser = reportedUserSelect.value;
    if (!reportedUser) return alert("Please select the user you want to report.");

    // Collect selected rules and total days
    const selectedRules = [];
    let totalDays = 0;
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        if (qty > 0) {
            selectedRules.push({
                id: item.dataset.id,
                title: item.querySelector('strong').textContent,
                qty: qty,
                daysPerOffense: parseInt(item.dataset.days)
            });
            totalDays += qty * parseInt(item.dataset.days);
        }
    });

    if (selectedRules.length === 0) return alert("Please select at least one rule broken.");

    // Create report object
    const report = {
        reporter: currentUser,
        reportedUser,
        rules: selectedRules,
        totalDays,
        timestamp: Date.now()
    };

    // Push report to Firebase
   try {
  const autoAcceptSnap = await get(ref(db, "settings/autoAcceptReports"));
  const autoAccept = autoAcceptSnap.exists() && autoAcceptSnap.val() === true;

  if (autoAccept) {
    // Auto accept: directly update user's days
    const userRef = ref(db, `users/${reportedUser}`);
    const userSnap = await get(userRef);
    if (!userSnap.exists()) return alert("Reported user does not exist.");

    const userData = userSnap.val();
    const newDays = (Number(userData.days || 0) + Number(totalDays));

    await update(userRef, { days: newDays });
    alert("Report auto accepted: days added directly.");

  } else {
    // Auto accept OFF: push report for manual approval
    const newReportRef = push(ref(db, "reports"));
    await update(newReportRef, {
      reporter: currentUser,
      reportedUser,
      rules: selectedRules,
      totalDays,
      timestamp: Date.now()
    });
    alert("Report submitted for manual approval.");
  }

  // Reset form and UI
  document.getElementById("reportForm").reset();
  renderRules();
  updateTotalDays();

} catch (error) {
  console.error("Error submitting report:", error);
  alert("Failed to submit report: " + error.message);
}


    // Reset form
    document.getElementById("reportForm").reset();
    renderRules();
    updateTotalDays();
};

// Toggle panels (shop, send credits)
function togglePanel(id) {
    const el = document.getElementById(id);
    el.classList.toggle("show");
}
window.togglePanel = togglePanel;

async function buyItem(cost, daysToRemove) {
    if (!currentUser) return alert("Please login first.");
    if ((currentUserData.credits || 0) < cost) return alert("Not enough credits.");
    if ((currentUserData.days || 0) < daysToRemove) return alert(`You don't have enough days to remove (${daysToRemove} required).`);

    // 🔊 Play Apple Pay sound immediately
    const applePayAudio = document.getElementById("applePayAudio");
    let audioPromise = Promise.resolve();
    if (applePayAudio) {
        applePayAudio.currentTime = 0;
        audioPromise = applePayAudio.play().catch(err => {
            console.error("Audio play failed:", err);
        });
    }

    // Update Firebase while sound plays
    await update(ref(db, `users/${currentUser}`), {
        credits: (currentUserData.credits || 0) - cost,
        days: (currentUserData.days || 0) - daysToRemove
    });

    currentUserData.credits -= cost;
    currentUserData.days -= daysToRemove;

    creditsSpan.textContent = currentUserData.credits;
    daysSpan.textContent = currentUserData.days;

    // Wait for the audio to finish (if it started)
    if (applePayAudio && applePayAudio.duration > 0) {
        await new Promise(resolve => {
            applePayAudio.onended = resolve;
        });
    } else {
        await audioPromise; // In case duration isn't loaded yet
    }

    alert(`Bought item for ${cost} credits. Removed ${daysToRemove} days.`);
}

window.buyItem = buyItem;


async function buyInfiniteCredits() {
    if (!currentUser) return alert("Please login first.");
    // Add 16000 credits and charge 2.5 seconds = 2.5 days?
    // You may want to adjust this logic
    await update(ref(db, `users/${currentUser}`), {
        credits: (currentUserData.credits || 0) + 16000,
        days: (currentUserData.days || 0) + 3
    });
    currentUserData.credits += 16000;
    currentUserData.days += 3;
    creditsSpan.textContent = currentUserData.credits;
    daysSpan.textContent = currentUserData.days;
    alert("Bought infinite credits (2.5s) for 16,000 credits.");
}
window.buyInfiniteCredits = buyInfiniteCredits;

async function sendCredits() {
    if (!currentUser) return alert("Please login first.");
    const toUser = sendToUserSelect.value;
    const amount = parseInt(document.getElementById("sendAmount").value);
    if (!toUser) return alert("Select a user to send credits to.");
    if (!amount || amount <= 0) return alert("Enter a valid amount.");

    if ((currentUserData.credits || 0) < amount) return alert("Not enough credits.");

    // Update sender and receiver credits
    const senderRef = ref(db, `users/${currentUser}`);
    const receiverRef = ref(db, `users/${toUser}`);

    // Atomic update
    const updates = {};
    updates[`users/${currentUser}/credits`] = currentUserData.credits - amount;

    // Fetch receiver credits first
    const receiverSnap = await get(receiverRef);
    if (!receiverSnap.exists()) return alert("Receiver user not found.");
    const receiverCredits = receiverSnap.val().credits || 0;

    updates[`users/${toUser}/credits`] = receiverCredits + amount;

    await update(ref(db), updates);

    currentUserData.credits -= amount;
    creditsSpan.textContent = currentUserData.credits;

    alert(`Sent ${amount} credits to ${toUser}.`);
}
window.sendCredits = sendCredits;

</script>

<audio id="saveSignatureAudio" src="welcome.mp3" preload="auto"></audio>
<audio id="applePayAudio" src="applepay.mp3" preload="auto"></audio>
<!-- EVENTS SECTION -->
<hr>
<div id="eventsSection">
  <h2>Events</h2>
  <div id="eventsList">Loading events...</div>
</div>

<script type="module">
import { getDatabase, ref, onValue, remove } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

// Get the already initialized app and database
const app = getApp();
const db = getDatabase(app);

function formatCountdown(msLeft) {
  if (msLeft <= 0) return "Expired";
  
  const totalSeconds = Math.floor(msLeft / 1000);
  const days = Math.floor(totalSeconds / (24 * 3600));
  const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  let parts = [];
  if (days > 0) parts.push(`${days}d`);
  if (hours > 0 || days > 0) parts.push(`${hours}h`);
  if (minutes > 0 || hours > 0 || days > 0) parts.push(`${minutes}m`);
  parts.push(`${seconds}s`);
  
  return parts.join(" ");
}

const eventsListEl = document.getElementById("eventsList");
const eventsRef = ref(db, "events");

function renderEvents(events) {
  eventsListEl.innerHTML = "";
  const now = Date.now();
  let hasEvents = false;

  Object.entries(events || {}).forEach(([eventId, ev]) => {
    if (!ev.endTime || now > ev.endTime) {
      remove(ref(db, `events/${eventId}`));
      return;
    }
    hasEvents = true;

    const div = document.createElement("div");
    div.className = "event-item";
    div.style.border = "1px solid #ccc";
    div.style.padding = "10px";
    div.style.margin = "10px 0";
    div.style.borderRadius = "5px";
    div.style.background = "#f9f9f9";

    const titleEl = document.createElement("h3");
    titleEl.textContent = ev.title;

    const descEl = document.createElement("p");
    descEl.textContent = ev.description;

    const countdownEl = document.createElement("small");
    countdownEl.style.fontWeight = "bold";

    div.appendChild(titleEl);
    div.appendChild(descEl);
    div.appendChild(countdownEl);
    eventsListEl.appendChild(div);

    function updateCountdown() {
      const msLeft = ev.endTime - Date.now();
      if (msLeft <= 0) {
        countdownEl.textContent = "Expired";
        remove(ref(db, `events/${eventId}`));
        div.remove();
        return;
      }
      countdownEl.textContent = `Ends in ${formatCountdown(msLeft)}`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
  });

  if (!hasEvents) {
    eventsListEl.textContent = "No active events.";
  }
}

onValue(eventsRef, snap => {
  if (snap.exists()) {
    renderEvents(snap.val());
  } else {
    eventsListEl.textContent = "No active events.";
  }
});
</script>
<style>
  #refreshBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
    border: none;
    background: none;
    transition: transform 1s ease;
    z-index: 1000; /* ensures it's above other elements */
  }
  #refreshBtn.spin {
    transform: rotate(360deg);
  }
</style>

<button id="refreshBtn" title="Refresh 🔄">🔄 Refresh</button>

<script>
  const btn = document.getElementById('refreshBtn');
  btn.addEventListener('click', () => {
    btn.classList.add('spin');
    setTimeout(() => {
      location.reload();
    }, 1000);
  });

  
</script>
<script>
document.getElementById("reportForm").addEventListener("submit", function(e) {
    e.preventDefault(); // stop form refresh

    const webhookURL = "https://discordapp.com/api/webhooks/1404606217346875483/XRsgBkh2jdg7NgOgH77wnmDB5sxtYwEHzMRMy-SDHeC1x-NX8n4y2pv1Y3mZvK92a9LL";
    const reporter = document.getElementById("reporter").value.trim();
    const reportedUser = document.getElementById("reportedUser").value.trim();
    
    // Get the total days penalty from the correct element (which is a div)
    const totalDaysText = document.getElementById("total-days").textContent;
    const totalDays = totalDaysText.match(/\d+/)[0] || "0"; 

    // Create a list of the rules that were broken, including the penalty days and quantity
    const brokenRules = [];
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        if (qty > 0) {
            const title = item.querySelector('strong').textContent;
            const daysPer = parseInt(item.dataset.days);
            brokenRules.push(`- ${title} (x${qty}) for ${qty * daysPer} days`);
        }
    });
    const rulesList = brokenRules.join('\n') || "No rules specified.";


    // Map reported users to Discord mentions
    const mentionMap = {
        "layan": "<@1367185737446985738>", // Replace with actual user IDs
        "zezo": "<@1388958062500647064>", // Replace with actual user IDs
        "asser": "<@1367187821542117558>" // Replace with actual user IDs
    };

    const mention = mentionMap[reportedUser.toLowerCase()] || "";

    const message = `📢 **New Report Submitted**\n`
                  + `**Reporter:** ${reporter}\n`
                  + `**Reported User:** ${reportedUser} ${mention}\n`
                  + `**Broken Rules:**\n${rulesList}\n`
                  + `**Total Days:** ${totalDays}`;

    fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: message })
    })
    .then(res => {
        if (res.ok) {
            alert("Report sent successfully!");
        } else {
            alert("Failed to send report.");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error sending report.");
    });
});
</script>
<button onclick="window.location.href='https://zezo20234.github.io/problem/'">
  Open Problem Page
</button>
</body>
</html>


