<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Island Firebase App</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }
    .dynamic-island {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 40px;
      background: #000;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: width 0.3s ease, height 0.3s ease;
      overflow: hidden;
    }
    .dynamic-island.open {
      width: 300px;
      height: 150px;
      border-radius: 30px;
    }
    .login-form, .report-form, .shop, .notifications {
      margin: 100px auto;
      max-width: 400px;
      padding: 20px;
      background: #222;
      border-radius: 10px;
      display: none;
    }
    .visible {
      display: block;
    }
    button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
    }
    input, select {
      width: 100%;
      margin: 5px 0 10px;
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="dynamic-island" id="island">Tap / Slide</div>

  <div class="login-form visible" id="loginForm">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Enter Username">
    <button id="loginBtn">Login</button>
  </div>

  <div class="report-form" id="reportFormContainer">
    <h2>Report</h2>
    <form id="reportForm">
      <input type="text" id="reporter" placeholder="Reporter Username" required>
      <input type="text" id="reported" placeholder="Reported Username" required>
      <input type="number" id="totalDays" placeholder="Total Days" required>
      <select id="autoAccept">
        <option value="yes">Auto Accept</option>
        <option value="no">Manual</option>
      </select>
      <button type="submit">Submit Report</button>
    </form>
  </div>

  <div class="shop" id="shopContainer">
    <h2>Shop</h2>
    <p>Spend your points here!</p>
  </div>

  <div class="notifications" id="notificationsContainer">
    <h2>Notifications</h2>
    <div id="notificationsList"></div>
  </div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, update, push, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elements
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const usernameInput = document.getElementById("username");
    const reportFormContainer = document.getElementById("reportFormContainer");
    const reportForm = document.getElementById("reportForm");
    const island = document.getElementById("island");
    const shopContainer = document.getElementById("shopContainer");
    const notificationsContainer = document.getElementById("notificationsContainer");

    let currentUser = null;

    // Login
    loginBtn.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      if (!username) return alert("Enter username");

      const userRef = ref(db, "users/" + username);
      const snap = await get(userRef);
      if (!snap.exists()) {
        await set(userRef, { username, points: 0, days: 0, balance: 0 });
      }
      currentUser = username;
      loginForm.classList.remove("visible");
      reportFormContainer.classList.add("visible");
    });

    // Report Form
    reportForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const reporter = document.getElementById("reporter").value.trim();
      const reported = document.getElementById("reported").value.trim();
      const totalDays = document.getElementById("totalDays").value.trim();
      const autoAccept = document.getElementById("autoAccept").value;

      if (!reporter || !reported || !totalDays) {
        return alert("Fill all fields");
      }

      const reporterRef = ref(db, "users/" + reporter);
      const reportedRef = ref(db, "users/" + reported);

      const reporterSnap = await get(reporterRef);
      const reportedSnap = await get(reportedRef);

      if (!reporterSnap.exists() || !reportedSnap.exists()) {
        return alert("User not found");
      }

      const reporterUserData = reporterSnap.val();
      const reportedUserData = reportedSnap.val();

      // Auto accept updates
      if (autoAccept === "yes") {
        const newReportedDays = (Number(reportedUserData.days||0) + Number(totalDays));
        const newReporterPoints = (Number(reporterUserData.points||0) + Num
      const updates = {};
      updates[`users/${reportedUser}/days`] = newReportedDays;
      updates[`users/${currentUser}/points`] = newReporterPoints;
      await update(ref(db), updates);
      currentUserData.points = newReporterPoints; pointsSpan.textContent = currentUserData.points;
      alert(`Report auto accepted: ${totalDays} days added to ${reportedUser}, and you received ${totalPoints} points.`);
    } else {
      const newReportRef = push(ref(db, 'reports'));
      await update(newReportRef, report);
      alert('Report submitted for manual approval. You will receive points upon approval.');
    }

    document.getElementById('reportForm').reset(); renderRules(); updateTotalDays();
  }catch(error){ console.error('Error submitting report:', error); alert('Failed to submit report: ' + error.message); }
}

// --- DYNAMIC ISLAND ROTATION (still rotates metrics every 5s) ---
const metrics = ['days','credits','points','sig'];
let metricIndex = 0;
const islandDisplay = document.getElementById('islandDisplay');
function showMetric(index){ 
  const items = islandDisplay.querySelectorAll('.island-metric');
  items.forEach(it=> it.style.display = 'none');
  const m = items[index % items.length]; if(m) m.style.display = 'flex';
}
showMetric(metricIndex);
setInterval(()=>{ metricIndex = (metricIndex + 1) % metrics.length; showMetric(metricIndex); }, 5000);

// === AUTO LOGIN ON PAGE LOAD & button wiring ===
window.addEventListener('load', ()=>{
  let saved = localStorage.getItem('loginData') || sessionStorage.getItem('loginData');
  if(saved){ try{ const { username, password } = JSON.parse(saved); login(username, password, true, true); }catch(e){ console.error('Failed to parse saved login:', e); } }
});

// wire login button
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const keep = document.getElementById('keepSignedIn').checked;
  if(!u||!p) return alert('Enter username and password');
  if(keep) localStorage.setItem('loginData', JSON.stringify({ username: u, password: p })); else sessionStorage.setItem('loginData', JSON.stringify({ username: u, password: p }));
  await login(u,p,keep,false);
});

// wire send credits/points buttons
document.getElementById('sendBtn').addEventListener('click', ()=> sendCredits());
document.getElementById('sendPointsBtn').addEventListener('click', ()=> sendPoints());

// expose logout to window (in case needed elsewhere)
window.logout = logout;

</script>
<script>
document.getElementById("reportForm").addEventListener("submit", function(e) {
    e.preventDefault(); // stop form refresh

    const webhookURL = "https://discordapp.com/api/webhooks/1404606217346875483/XRsgBkh2jdg7NgOgH77wnmDB5sxtYwEHzMRMy-SDHeC1x-NX8n4y2pv1Y3mZvK92a9LL";
    const reporter = document.getElementById("reporter").value.trim();
    const reportedUser = document.getElementById("reportedUser").value.trim();
   
    // Get the total days penalty from the correct element (which is a div)
    const totalDaysText = document.getElementById("total-days").textContent;
    const totalDays = totalDaysText.match(/\d+/)[0] || "0";

    // Create a list of the rules that were broken, including the penalty days and quantity
    const brokenRules = [];
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        if (qty > 0) {
            const title = item.querySelector('strong').textContent;
            const daysPer = parseInt(item.dataset.days);
            brokenRules.push(`- ${title} (x${qty}) for ${qty * daysPer} days`);
        }
    });
    const rulesList = brokenRules.join('\n') || "No rules specified.";


    // Map reported users to Discord mentions
    const mentionMap = {
        "layan": "<@1367185737446985738>", // Replace with actual user IDs
        "zezo": "<@1388958062500647064>", // Replace with actual user IDs
        "asser": "<@1367187821542117558>" // Replace with actual user IDs
    };

    const mention = mentionMap[reportedUser.toLowerCase()] || "";

    const message = `ðŸ“¢ **New Report Submitted**\n`
                  + `**Reporter:** ${reporter}\n`
                  + `**Reported User:** ${reportedUser} ${mention}\n`
                  + `**Broken Rules:**\n${rulesList}\n`
                  + `**Total Days:** ${totalDays}`;

    fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: message })
    })
    .then(res => {
        if (res.ok) {
            alert("Report sent successfully!");
        } else {
            alert("Failed to send report.");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error sending report.");
    });
});
</script>

</body>
</html>
