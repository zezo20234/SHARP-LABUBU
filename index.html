<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3-Team Tournament — Realtime (mobile friendly)</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#f7fafc;
    --panel:#ffffff;
    --muted:#6b7280;
    --accent:#06b6d4;
    --accent-2:#7c3aed;
    --radius:14px;
    --shadow: 0 12px 30px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef2ff 0%, #ffffff 45%);color:#0f1724;-webkit-font-smoothing:antialiased}
  a{color:inherit}
  button{font-family:inherit}

  /* App container */
  .app {
    max-width:1100px;
    margin:18px auto;
    padding:16px;
  }

  /* Header */
  header.appHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;box-shadow:0 8px 20px rgba(99,102,241,0.12)}
  .title{font-size:18px;font-weight:800}
  .subtitle{font-size:13px;color:var(--muted)}

  /* Controls */
  .controlsTop{display:flex;gap:8px;align-items:center}
  .btn { padding:10px 12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700; cursor:pointer }
  .btn.ghost { background:#fff;border:1px solid rgba(15,23,42,0.06);color:var(--muted) }

  /* Pages */
  .pages { display:block; }

  /* Layout: large screens two-column, mobile stacked */
  .layout {
    display:grid;
    grid-template-columns:1fr 420px;
    gap:18px;
    align-items:start;
  }
  @media (max-width:920px) {
    .layout { grid-template-columns:1fr; }
    .logo{width:48px;height:48px}
    .btn{padding:10px 14px}
  }

  /* Card/panel */
  .panel {
    background:var(--panel);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:var(--shadow);
    border:1px solid rgba(15,23,42,0.03);
  }

  /* Matches */
  .matchList{display:flex;flex-direction:column;gap:12px;margin-top:8px}
  .matchCard{
    display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(90deg,rgba(14,165,164,0.03),transparent);
    transition: transform .22s ease, box-shadow .22s ease;
  }
  .matchCard:active, .matchCard:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(2,6,23,0.08) }
  .teams{display:flex;gap:10px;align-items:center}
  .teamBadge{display:flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:10px;background:rgba(15,23,42,0.02);min-width:110px;font-weight:700}
  .scoreBox{font-weight:900;font-size:18px;min-width:84px;text-align:center}

  /* Final panel */
  .finalBox { margin-top:8px;padding:12px;border-radius:12px;background:linear-gradient(90deg,rgba(124,58,237,0.03),rgba(6,182,212,0.02));display:flex;align-items:center;justify-content:space-between }

  /* Leaderboard */
  .leaderboardList{display:flex;flex-direction:column;gap:12px;margin-top:6px}
  .pill{
    display:flex;align-items:center;gap:12px;padding:12px;border-radius:999px;background:linear-gradient(90deg,rgba(124,58,237,0.04),rgba(6,182,212,0.03));transition:transform .22s, box-shadow .22s;box-shadow:0 10px 24px rgba(2,6,23,0.04)
  }
  .pill:hover{ transform:translateY(-8px); box-shadow:0 26px 60px rgba(2,6,23,0.08) }
  .pill img{width:64px;height:64px;border-radius:12px;object-fit:cover;border:2px solid rgba(255,255,255,0.6)}
  .pill .info{flex:1}
  .pill .name{font-weight:800}
  .pill .small{color:var(--muted);margin-top:4px;font-size:13px}
  .pill .stats{text-align:right;min-width:120px;font-weight:800}

  /* Modal */
  .modalCover{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:80;background:rgba(2,6,23,0.45)}
  .modalCover.show{display:flex}
  .modalCard{width:320px;background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 24px 60px rgba(2,6,23,0.22)}
  .modalRow{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px}

  input[type=number]{width:120px;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:16px}
  label.fileLabel{display:inline-block;padding:6px 8px;border-radius:8px;background:#111;color:#fff;font-size:13px;cursor:pointer}

  /* Small */
  .smallFoot{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  pre { margin:0; font-family:inherit; color:var(--muted) }
</style>
</head>
<body>

<div class="app">
  <header class="appHeader">
    <div class="brand">
      <div class="logo">3T</div>
      <div>
        <div class="title">3-Team Tournament</div>
        <div class="subtitle">Round-robin → Final • Win = 3 • Draw = 1</div>
      </div>
    </div>

    <div class="controlsTop">
      <button id="navHome" class="btn.ghost btn">Home</button>
      <button id="navLeaderboard" class="btn">Leaderboard</button>
    </div>
  </header>

  <main class="pages">
    <section class="layout">

      <!-- LEFT: Home / Matches -->
      <div class="panel" id="homePanel">
        <h3 style="margin:0 0 6px">Group Matches</h3>
        <div style="color:var(--muted);margin-bottom:12px">Each team plays 2 group matches (round-robin). Enter scores to update the leaderboard live. Final is created automatically once all group matches have scores.</div>

        <div id="matches" class="matchList"></div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="resetBtn" style="background:#111;color:#fff;padding:10px 12px;border-radius:10px">Reset</button>
        </div>

        <div class="smallFoot">Tip: Use the Leaderboard button to switch views. Works well on mobile — large touch targets included.</div>
      </div>

      <!-- RIGHT: Final + Snapshot -->
      <aside class="panel">
        <h4 style="margin:0 0 8px">Final</h4>
        <div id="finalPanel" style="min-height:120px;display:flex;align-items:center;justify-content:center;color:var(--muted)">Final will appear when group matches are complete.</div>

        <div style="height:12px"></div>

        <h4 style="margin:0 0 8px">Snapshot</h4>
        <pre id="snapshot" style="background:transparent;border:none;padding:0;margin:6px 0 0;color:var(--muted)"></pre>
      </aside>

    </section>

    <!-- Leaderboard page (separate area) -->
    <section id="leaderboardPanel" class="panel" style="margin-top:18px;display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div>
          <div style="font-weight:900;font-size:18px">Leaderboard</div>
          <div style="font-size:13px;color:var(--muted)">Best → Worst</div>
        </div>
        <div>
          <button id="backBtn" class="btn.ghost btn">Back</button>
        </div>
      </div>

      <div id="leaderboardList" class="leaderboardList"></div>

      <div class="smallFoot">You can upload a photo (saved as base64 to Firebase) or use a relative filename like <code>1.png</code> placed next to this HTML.</div>
    </section>

  </main>
</div>

<!-- Modal -->
<div id="modalCover" class="modalCover" aria-hidden="true">
  <div class="modalCard">
    <div style="font-weight:800;font-size:16px" id="modalTitle">Record score</div>
    <div style="margin-top:8px;color:var(--muted)" id="modalTeams">FALCONS — TEAM ORANGE</div>

    <div class="modalRow">
      <input id="score1" type="number" min="0" value="0" />
      <div style="font-weight:700;color:var(--muted)">:</div>
      <input id="score2" type="number" min="0" value="0" />
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="closeModal" style="background:#eee;border:none;padding:8px 12px;border-radius:10px">Cancel</button>
      <button id="submitScore" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
/* ================= Firebase config (user provided) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
  authDomain: "sharplabubu.firebaseapp.com",
  databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
  projectId: "sharplabubu",
  storageBucket: "sharplabubu.firebasestorage.app",
  messagingSenderId: "596148393481",
  appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
  measurementId: "G-4M25R3BF08"
};
firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('tourney3');

/* ================= Default data (relative filenames ok) ================= */
const defaultState = {
  teams: {
    A: { name: 'team falcons', pic: '1.png' },
    B: { name: 'team orange', pic: '2.png' },
    C: { name: 'team lilly', pic: '3.png' }
  },
  matches: {
    AB: { id:'AB', t1:'A', t2:'B', s1:null, s2:null, stage:'group' },
    AC: { id:'AC', t1:'A', t2:'C', s1:null, s2:null, stage:'group' },
    BC: { id:'BC', t1:'B', t2:'C', s1:null, s2:null, stage:'group' }
  },
  final: null
};

/* Seed DB if empty */
dbRef.once('value').then(snap=>{
  if(!snap.exists()) dbRef.set(defaultState);
}).catch(e=>console.error('seed error', e));

/* ================= UI refs ================= */
const matchesEl = document.getElementById('matches');
const finalPanel = document.getElementById('finalPanel');
const leaderList = document.getElementById('leaderboardList');
const snapshotEl = document.getElementById('snapshot');
const leaderboardPanel = document.getElementById('leaderboardPanel');
const resetBtn = document.getElementById('resetBtn');
const navLeaderboard = document.getElementById('navLeaderboard');
const navHome = document.getElementById('navHome');
const backBtn = document.getElementById('backBtn');

const modalCover = document.getElementById('modalCover');
const modalTitle = document.getElementById('modalTitle');
const modalTeams = document.getElementById('modalTeams');
const score1 = document.getElementById('score1');
const score2 = document.getElementById('score2');
const submitScore = document.getElementById('submitScore');
const closeModal = document.getElementById('closeModal');

let currentMatchId = null;

/* ================= Realtime updates ================= */
dbRef.on('value', snap => {
  const data = snap.val();
  if(!data) return;
  renderAll(data);
  autoCreateFinalIfReady(data);
});

/* ================= Render functions ================= */
function getImgSrc(pic){
  if(!pic) return 'https://via.placeholder.com/160x160.png?text=?';
  const s = String(pic).trim();
  if(s.startsWith('data:')) return s;
  if(s.startsWith('http://') || s.startsWith('https://')) return s;
  return s; // relative filename like 1.png
}

function renderAll(state){
  renderMatches(state);
  renderFinal(state);
  renderLeaderboard(state);
  renderSnapshot(state);
}

function renderMatches(state){
  const order = ['AB','AC','BC'];
  matchesEl.innerHTML = '';
  order.forEach(id=>{
    const m = state.matches && state.matches[id];
    if(!m) return;
    const t1 = state.teams[m.t1].name;
    const t2 = state.teams[m.t2].name;
    const scoreText = (m.s1 === null || m.s2 === null) ? '- : -' : `${m.s1} : ${m.s2}`;

    const card = document.createElement('div');
    card.className = 'matchCard';
    card.innerHTML = `
      <div class="teams">
        <div class="teamBadge">${t1}</div>
        <div style="color:var(--muted);margin-left:6px;margin-right:6px">vs</div>
        <div class="teamBadge">${t2}</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="scoreBox">${scoreText}</div>
        <button class="addScoreBtn" data-id="${id}" style="padding:8px 10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none">Add</button>
      </div>`;
    matchesEl.appendChild(card);
  });

  // attach
  matchesEl.querySelectorAll('.addScoreBtn').forEach(b=>{
    b.addEventListener('click', ()=> openModal(b.dataset.id));
  });
}

function renderFinal(state){
  if(!state.final){
    finalPanel.innerHTML = '<div style="color:var(--muted)">Final will be scheduled automatically after all group matches are played.</div>';
    return;
  }
  const f = state.final;
  const t1 = state.teams[f.t1].name;
  const t2 = state.teams[f.t2].name;
  const scoreText = (f.s1 === null || f.s2 === null) ? '- : -' : `${f.s1} : ${f.s2}`;
  finalPanel.innerHTML = `
    <div class="finalBox">
      <div style="display:flex;gap:10px;align-items:center"><div style="font-weight:800">${t1}</div><div style="color:var(--muted)">vs</div><div style="font-weight:800">${t2}</div></div>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="font-weight:900">${scoreText}</div>
        <button id="finalAdd" style="padding:8px 10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none">Add</button>
      </div>
    </div>`;
  const btn = document.getElementById('finalAdd');
  if(btn) btn.addEventListener('click', ()=> openModal('final'));
}

function renderLeaderboard(state){
  // compute stats from group matches only
  const stats = {};
  Object.keys(state.teams).forEach(k=> stats[k] = { pts:0, gf:0, ga:0, played:0 });
  Object.values(state.matches || {}).forEach(m=>{
    if(m.s1 === null || m.s2 === null) return;
    const a = Number(m.s1), b = Number(m.s2);
    stats[m.t1].gf += a; stats[m.t1].ga += b; stats[m.t1].played++;
    stats[m.t2].gf += b; stats[m.t2].ga += a; stats[m.t2].played++;
    if(a > b) stats[m.t1].pts += 3;
    else if(b > a) stats[m.t2].pts += 3;
    else { stats[m.t1].pts += 1; stats[m.t2].pts += 1; }
  });

  const arr = Object.keys(stats).map(k=>({
    key:k, name: state.teams[k].name, pic: state.teams[k].pic, ...stats[k]
  }));
  arr.sort((x,y)=>{
    if(y.pts !== x.pts) return y.pts - x.pts;
    const gdx = x.gf - x.ga, gdy = y.gf - y.ga;
    if(gdy !== gdx) return gdy - gdx;
    if(y.gf !== x.gf) return y.gf - x.gf;
    return x.key.localeCompare(y.key);
  });

  leaderList.innerHTML = '';
  arr.forEach((t,i) => {
    const pill = document.createElement('div');
    pill.className = 'pill';
    pill.innerHTML = `
      <img src="${getImgSrc(t.pic)}" alt="${t.name}">
      <div class="info">
        <div class="name">${i+1}. ${t.name}</div>
        <div class="small">Pts: ${t.pts} • GF: ${t.gf} • GA: ${t.ga}</div>
        <div style="height:8px"></div>
        <label class="fileLabel">Change photo
          <input type="file" accept="image/*" style="display:none" data-team="${t.key}">
        </label>
      </div>
      <div class="stats">GD: ${t.gf - t.ga}<div class="small">Played: ${t.played}</div></div>
    `;
    leaderList.appendChild(pill);

    const input = pill.querySelector('input[type=file]');
    if(input){
      input.addEventListener('change', function(){ handleFileUpload(t.key, this.files[0]); });
    }
  });
}

function renderSnapshot(state){
  const stats = {};
  Object.keys(state.teams).forEach(k=> stats[k] = { pts:0, gf:0, ga:0 });
  Object.values(state.matches || {}).forEach(m=>{
    if(m.s1 === null || m.s2 === null) return;
    const a = Number(m.s1), b = Number(m.s2);
    stats[m.t1].gf += a; stats[m.t1].ga += b;
    stats[m.t2].gf += b; stats[m.t2].ga += a;
    if(a > b) stats[m.t1].pts += 3;
    else if(b > a) stats[m.t2].pts += 3;
    else { stats[m.t1].pts++; stats[m.t2].pts++; }
  });
  const lines = Object.keys(stats).map(k=> `${state.teams[k].name}: ${stats[k].pts} pts — ${stats[k].gf} GF, ${stats[k].ga} GA`);
  snapshotEl.textContent = lines.join('\n');
}

/* ================= Helper: get image src (relative names fine) ================= */
function getImgSrc(pic){
  if(!pic) return 'https://via.placeholder.com/160x160.png?text=?';
  const s = String(pic).trim();
  if(s.startsWith('data:')) return s;
  if(s.startsWith('http://') || s.startsWith('https://')) return s;
  return s;
}

/* ================= Auto-final creation (ONLY automatic) ================= */
async function autoCreateFinalIfReady(state){
  const matches = state.matches || {};
  const allPlayed = Object.values(matches).every(m=> m.s1 !== null && m.s2 !== null);
  if(allPlayed && !state.final){
    // compute standings from group matches
    const stats = {};
    Object.keys(state.teams).forEach(k=> stats[k] = { pts:0, gf:0, ga:0 });
    Object.values(matches).forEach(m=>{
      const a = Number(m.s1), b = Number(m.s2);
      stats[m.t1].gf += a; stats[m.t1].ga += b;
      stats[m.t2].gf += b; stats[m.t2].ga += a;
      if(a > b) stats[m.t1].pts += 3;
      else if(b > a) stats[m.t2].pts += 3;
      else { stats[m.t1].pts++; stats[m.t2].pts++; }
    });
    const arr = Object.keys(stats).map(k=>({ key:k, ...stats[k] }));
    arr.sort((x,y)=>{
      if(y.pts !== x.pts) return y.pts - x.pts;
      const gdx = x.gf - x.ga, gdy = y.gf - y.ga;
      if(gdy !== gdx) return gdy - gdx;
      if(y.gf !== x.gf) return y.gf - x.gf;
      return x.key.localeCompare(y.key);
    });
    const t1 = arr[0].key, t2 = arr[1].key;
    await dbRef.child('final').set({ t1, t2, s1: null, s2: null, stage:'final' });
  }
}

/* ================= Modal control & saving scores ================= */
function openModal(matchId){
  currentMatchId = matchId;
  if(matchId === 'final'){
    dbRef.child('final').once('value').then(snap=>{
      const f = snap.val(); if(!f) return;
      modalTitle.textContent = 'Record Final Score';
      modalTeams.textContent = `${f.t1} — ${f.t2}`;
      score1.value = f.s1 === null ? 0 : f.s1;
      score2.value = f.s2 === null ? 0 : f.s2;
      modalCover.classList.add('show');
    });
  } else {
    dbRef.child('matches').child(matchId).once('value').then(snap=>{
      const m = snap.val(); if(!m) return;
      modalTitle.textContent = 'Record Match Score';
      modalTeams.textContent = `${m.t1} — ${m.t2}`;
      score1.value = m.s1 === null ? 0 : m.s1;
      score2.value = m.s2 === null ? 0 : m.s2;
      modalCover.classList.add('show');
    });
  }
}

closeModal.addEventListener('click', ()=> { modalCover.classList.remove('show'); currentMatchId = null; });

submitScore.addEventListener('click', async ()=>{
  const s1 = Number(score1.value), s2 = Number(score2.value);
  if(isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0){ alert('Enter valid non-negative scores'); return; }
  if(currentMatchId === 'final'){
    await dbRef.child('final').update({ s1, s2 });
  } else {
    await dbRef.child('matches').child(currentMatchId).update({ s1, s2 });
  }
  modalCover.classList.remove('show');
  currentMatchId = null;
});

/* ================= File upload handler (store base64) ================= */
async function handleFileUpload(teamKey, file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    const dataUrl = e.target.result;
    await dbRef.child('teams').child(teamKey).child('pic').set(dataUrl);
  };
  reader.readAsDataURL(file);
}

/* ================= Attach dynamic file input events through delegation ================= */
document.addEventListener('change', function(e){
  const el = e.target;
  if(el && el.tagName === 'INPUT' && el.type === 'file' && el.dataset && el.dataset.team){
    handleFileUpload(el.dataset.team, el.files[0]);
  }
});

/* ================= Navigation (Home <-> Leaderboard) ================= */
navLeaderboard.addEventListener('click', ()=> {
  document.getElementById('homePanel').style.display = 'none';
  document.querySelector('.layout').style.display = 'none';
  leaderboardPanel.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
navHome.addEventListener('click', ()=> {
  leaderboardPanel.style.display = 'none';
  document.querySelector('.layout').style.display = '';
  document.getElementById('homePanel').style.display = '';
});
backBtn.addEventListener('click', ()=> navHome.click());

/* ================= Reset button ================= */
resetBtn.addEventListener('click', async ()=>{
  if(!confirm('Reset tournament? This will clear all scores and final.')) return;
  await dbRef.set(defaultState);
});

/* ================= Safety listener to surface errors in console ================= */
dbRef.on('child_removed', ()=>{});

/* Done. */
</script>
</body>
</html>
