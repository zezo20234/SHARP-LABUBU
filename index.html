<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Login, Report, Shop & Credits Sender with Dynamic Island + Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b4c7e">
<link rel="apple-touch-icon" href="LABUBU3.jpg">

<style>
  .pointcoin { width: 50px; height: 50px; vertical-align: middle; }
  .island-time .label, .island-welcome .label { font-size:0.75rem; opacity:0.9; color: var(--island-text); margin-right:6px; }
  .island-time .value, .island-welcome .value { font-weight:700; font-size:1rem; color: var(--island-text); min-width:70px; text-align:right; }
  #islandWelcome { transition: opacity 220ms ease, transform 220ms cubic-bezier(.2,.9,.3,1); }
  #islandWelcome.hidden { opacity: 0; transform: translateY(-6px); pointer-events: none; }
  :root{ --island-bg: #000; --island-text: #fff; --island-radius: 28px; --island-padding: 10px 14px; }
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 30px auto; padding: 10px; background: linear-gradient(135deg, #f0f4f9, #d9e4f5); color: #333; font-size: 1rem; line-height: 1.4; }
  @media (max-width: 700px) { body { max-width: 100%; margin: 10px; padding: 10px 15px; } }
  h2, h3 { color: #2b4c7e; margin-bottom: 10px; }
  button, input, select { width: 100%; max-width: 100%; padding: 12px; margin-top: 6px; font-size: 1.1rem; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; touch-action: manipulation; }
  button { background: #2b4c7e; color: white; cursor: pointer; user-select: none; }
  button:hover { background: #1f3557; }
  img[src$="EGP.png"], .coin-icon, .island-icon { width: 25px !important; height: 25px !important; vertical-align: middle; }
  .coin-icon { display: inline-block; }
  #dynamic-island { position: fixed; left: 50%; top: 8px; transform: translateX(-50%); z-index: 99999; display: flex; align-items: center; gap: 10px; background: var(--island-bg); color: var(--island-text); padding: var(--island-padding); border-radius: var(--island-radius); box-shadow: 0 8px 30px rgba(0,0,0,0.25); min-width: 180px; max-width: 92vw; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); cursor: pointer; user-select: none; transition: width 260ms cubic-bezier(.2,.9,.3,1), border-radius 200ms ease, background 180ms ease; }
  #notifyDot { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius:50%; background: transparent; box-shadow: 0 0 6px rgba(0,0,0,0.3); pointer-events: none; }
  #notifyDot.active { background: red; box-shadow: 0 0 10px rgba(255,0,0,0.9); animation: notify-blink 1.6s infinite; }
  @keyframes notify-blink { 0% { opacity: 1; } 50% { opacity: 0.35; } 100% { opacity: 1; } }
  .island-display { display:flex; align-items:center; gap:8px; min-width:160px; }
  .island-metric { display:flex; align-items:center; gap:8px; white-space:nowrap; }
  .island-metric .label { font-size:0.75rem; opacity:0.9; color: var(--island-text); }
  .island-metric .value { font-weight:700; font-size:1rem; color: var(--island-text); }
  .island-icon { display:inline-block; vertical-align:middle; }
  #islandMenuBtn { background: rgba(255,255,255,0.06); color: inherit; border: none; border-radius: 10px; padding: 6px 8px; cursor:pointer; }
  #islandMenuBtn:active { transform: scale(0.98); }
  #islandMenu { position: fixed; z-index: 99998; background: var(--island-bg); color: var(--island-text); border-radius: 18px; box-shadow: 0 14px 40px rgba(0,0,0,0.3); transform-origin: top center; overflow: hidden; transition: transform 220ms ease, opacity 200ms ease, height 250ms ease, top 200ms ease, left 200ms ease; opacity: 0; transform: scaleY(0.95); pointer-events: none; }
  #islandMenu.open { opacity: 1; transform: scaleY(1); pointer-events: auto; }
  #islandMenu .menu-inner { padding: 12px; display: flex; flex-direction: column; gap: 10px; max-height: 70vh; overflow:auto; }
  .menu-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .menu-actions button { flex:1 1 120px; background: transparent; border: 1px solid rgba(255,255,255,0.08); color: var(--island-text); padding: 10px; border-radius: 10px; font-weight: 700; }
  .menu-actions button.active { outline: 2px solid rgba(255,255,255,0.15); }
  .menu-panel { display:none; background: transparent; color: var(--island-text); }
  .menu-panel.show { display:block; }
  .menu-panel .panel-inner { margin-top: 8px; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.2); }
  .menu-panel label { color: var(--island-text); font-weight:600; display:block; margin-bottom:6px; }
  .menu-panel input, .menu-panel select { background: rgba(255,255,255,0.03); color: var(--island-text); border: 1px solid rgba(255,255,255,0.06); }
  .menu-panel button { background: rgba(255,255,255,0.06); color: var(--island-text); border:1px solid rgba(255,255,255,0.06); }
  .notification-item { padding: 8px; border-radius:8px; margin-bottom:8px; background: rgba(255,255,255,0.03); border:1px solid rgba(0,0,0,0.06); cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .notification-item.unread { border-left: 4px solid #ff4b4b; }
  .notification-meta { font-size:0.85rem; opacity:0.85; margin-top:6px; }
  .notification-actions { display:flex; gap:8px; margin-top:8px; }
  .notification-actions button { flex:0 0 auto; padding:8px 10px; }
  #login-form, #report-form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
  label { font-weight: bold; margin-top: 15px; display: block; }
  .rules-list { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #fafafa; }
  .rule-item { padding: 8px; border-radius: 5px; cursor: pointer; transition: background 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
  .rule-item:hover { background: #e6f0ff; }
  .rule-item.selected { background: #2b4c7e; color: white; }
  .rule-details { font-size: 0.9rem; color: inherit; margin-top: 4px; flex-basis: 100%; }
  .rule-qty { width: 50px; margin-left: 10px; font-size: 1rem; }
  #eventsSection { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
  .event-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; background: #f9f9f9; }
  @media (max-width: 420px) { .menu-actions button { font-size: 0.9rem; padding: 8px; } #dynamic-island { padding: 8px 10px; } }
  /* small visual inside-page notifications */
  #messageContainer > div { color: white; font-weight:700; position:relative; padding-right:44px; }
  /* tiny delete button style for messages and notifications */
  .tiny-del { position:absolute; right:8px; top:8px; background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:0.8rem; }
  .tiny-del:hover { opacity:0.9; transform:scale(0.98); }
</style>
</head>
<body>

<div id="welcomeOverlay" style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100000;">
  <div id="welcomeText" style="color:white; font-weight:700; font-size:1.2rem;"></div>
  <small style="color:white; display:block; margin-top:8px;">Click to continue</small>
</div>
<audio id="welcomeAudio" src="header-39344.mp3"></audio>

<div id="dynamic-island" role="region" aria-label="User status island" title="Tap to open">
  <div class="island-display" id="islandDisplay">
    <div id="islandTime" class="island-metric island-time" aria-hidden="false">
      <span class="label">Local time</span>
      <span class="value" id="islandLocalTime">--:--:--</span>
    </div>
    <div class="island-metric" data-type="days">
      <span class="label">Days</span>
      <span class="value" id="days-count">0</span>
    </div>
    <div class="island-metric" data-type="credits">
      <span class="label"><img src="EGP.png" alt="coin" class="island-icon coin-icon"></span>
      <span class="value" id="credits-count">0</span>
    </div>
    <div class="island-metric" data-type="points">
      <span class="label"><img src="POINTS.png" alt="POINTS" class="pointcoin"></span>
      <span class="value" id="points-count">0</span>
    </div>
    <div class="island-metric" data-type="sig">
      <span class="label">Signature</span>
      <span class="value" id="sig-days-left">0</span>
    </div>
  </div>
  <button id="islandMenuBtn" aria-hidden="true">≡</button>
  <span id="notifyDot" aria-hidden="true"></span>
</div>

<div id="islandMenu" aria-hidden="true" role="dialog" aria-label="Island menu">
  <div class="menu-inner">
    <div class="menu-actions" role="tablist" aria-label="Island actions">
      <button id="menuLogoutBtn">Logout</button>
      <button id="menuShopBtn">Shop</button>
      <button id="menuSendCreditsBtn">Send <img src="EGP.png" alt="coin" class="coin-icon"></button>
      <button id="menuExchangeBtn">Exchange</button>
      <button id="menuSendPointsBtn">Send <img src="POINTS.png" alt="POINTS" class="pointcoin"></button>
      <button id="menuCustomizeBtn">Customize</button>
      <button id="menuNotificationsBtn">Notifications</button>
      <button id="menuSendNotificationBtn">Send Notification</button>
      <!-- SECRET button added -->
      <button id="menuSecretBtn">Secret</button>
    </div>

    <div id="panelShop" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Days Shop (Spend <img src="EGP.png" alt="coin" class="coin-icon"> to remove days)</h4>
        <div id="shopItems"></div>
        <div style="margin-top:12px;">
          <div id="secretInfo" style="display:none;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);">
            <strong>Secret Mode Enabled</strong>
            <div id="secretModeDetails" style="font-size:0.9rem;margin-top:6px;"></div>
            <button id="clearSecretBtn" style="margin-top:8px;">Clear Secret</button>
          </div>
        </div>
      </div>
    </div>

    <div id="panelSendCredits" class="menu-panel">
      <div class="panel-inner">
        <label>Send to:</label>
        <select id="sendToUser"></select>
        <label>Amount:</label>
        <input type="number" id="sendAmount" min="1" />
        <button id="sendBtn">Send <img src="EGP.png" alt="coin" class="coin-icon"></button>
      </div>
    </div>

    <div id="panelExchange" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;"><img src="POINTS.png" alt="POINTS" class="pointcoin"> Exchange</h4>
        <div id="pointsExchangeItems"></div>
      </div>
    </div>

    <div id="panelSendPoints" class="menu-panel">
      <div class="panel-inner">
        <label>Send <img src="POINTS.png" alt="POINTS" class="pointcoin"> to:</label>
        <select id="sendPointsToUser"></select>
        <label><img src="POINTS.png" alt="POINTS" class="pointcoin"> amount:</label>
        <input type="number" id="sendPointsAmount" min="1" />
        <button id="sendPointsBtn">Send <img src="POINTS.png" alt="POINTS" class="pointcoin"></button>
      </div>
    </div>

    <div id="panelNotifications" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Your Notifications</h4>
        <div id="notificationsList">No notifications.</div>
      </div>
    </div>

    <div id="panelSendNotification" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Send Notification</h4>
        <label>To:</label>
        <select id="notifyToUser"><option disabled selected>Select user</option></select>
        <label>Title</label>
        <input id="notifyTitle" placeholder="Short title" />
        <label>Description</label>
        <input id="notifyDescription" placeholder="Longer description" />
        <button id="sendNotificationBtn">Send Notification</button>
      </div>
    </div>

    <div id="panelCustomize" class="menu-panel">
      <div class="panel-inner" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-weight:700;">Choose island color</div>
        <div class="palette" id="colorPalette" style="display:flex; gap:8px; flex-wrap:wrap;">
          <div class="sw" data-color="black" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#000,#000);cursor:pointer;"></div>
          <div class="sw" data-color="red" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff4b4b,#c0392b);cursor:pointer;"></div>
          <div class="sw" data-color="orange" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff8a00,#ff5e00);cursor:pointer;"></div>
          <div class="sw" data-color="yellow" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ffd54a,#ffb300);cursor:pointer;"></div>
          <div class="sw" data-color="purple" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#9b59b6,#6a2a89);cursor:pointer;"></div>
          <div class="sw" data-color="pink" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff7eb6,#ff4d94);cursor:pointer;"></div>
          <div class="sw" data-color="green" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#2ecc71,#27ae60);cursor:pointer;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="login-form">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <label><input type="checkbox" id="keepSignedIn"> Keep me signed in</label>
  <button id="loginBtn">Login</button>
</div>

<div id="report-form" style="display:none;">
  <h2>Report Form</h2>
  <form id="reportForm">
    <label>Your Username</label>
    <input type="text" id="reporter" readonly />
    <label>Who is this report on?</label>
    <select id="reportedUser" required ></select>
    <label>Rules broken:</label>
    <div class="rules-list" id="rulesList"></div>
    <div id="total-days">Total Days Penalty: 0</div>
    <button type="submit" style="margin-top:20px;">Submit Report</button>
  </form>
</div>

<hr>
<div id="eventsSection">
  <h2>Events</h2>
  <div id="eventsList">Loading events...</div>
</div>

<audio id="saveSignatureAudio" src="welcome.mp3" preload="auto"></audio>
<audio id="applePayAudio" src="applepay.mp3" preload="auto"></audio>

<div id="messageContainer" 
     style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
            display:flex;flex-direction:column;align-items:center;gap:10px;
            z-index:9999;max-width:80%;"></div>

<!-- Firebase v10 modules -->
<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
  authDomain: "sharplabubu.firebaseapp.com",
  databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
  projectId: "sharplabubu",
  storageBucket: "sharplabubu.firebasestorage.app",
  messagingSenderId: "596148393481",
  appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
  measurementId: "G-4M25R3BF08"
};

let app;
try { app = getApp(); } catch (e) { app = initializeApp(firebaseConfig); }
const db = getDatabase(app);

// === GLOBALS ===
let currentUser = null, currentUserData = null;
const daysSpan = document.getElementById("days-count");
const creditsSpan = document.getElementById("credits-count");
const pointsSpan = document.getElementById("points-count");
const sigDaysLeftSpan = document.getElementById("sig-days-left");
const reportedUserSelect = document.getElementById("reportedUser");
const sendToUserSelect = document.getElementById("sendToUser");
const sendPointsToUserSelect = document.getElementById("sendPointsToUser");
const notifyToUserSelect = document.getElementById("notifyToUser");
const reporterInput = document.getElementById("reporter");
const welcomeOverlay = document.getElementById("welcomeOverlay");
const welcomeText = document.getElementById("welcomeText");
const welcomeAudio = document.getElementById("welcomeAudio");
const notifyDot = document.getElementById('notifyDot');

let currentSecretCode = null; // holds code object when secret is active

// clock
const islandLocalTimeEl = document.getElementById('islandLocalTime');
let _islandClockInterval = null;
function startIslandClock() {
  function render() { islandLocalTimeEl.textContent = new Date().toLocaleTimeString(); }
  render(); if (_islandClockInterval) clearInterval(_islandClockInterval);
  _islandClockInterval = setInterval(render, 1000);
}
startIslandClock();

// DATA arrays (unchanged)
const rules = [
  { id: 'no_hit', title: 'No hit', days: 1, points: 12.5, details: 'Do not physically hurt anyone, as a joke is ok +1 days.' },
  { id: 'no_scream', title: 'No scream', days: 5, points: 12.5, details: 'Speak calmly, only when you are excited or angry +5 days.' },
  { id: 'no_cry', title: 'No cry', days: 1, points: 12.5, details: 'Crying is not allowed +1 days.' },
  { id: 'zeyad_devices', title: 'Zeyad can no longer make you play with devices when you have days.', days: 20, points: 15, details: 'If Zeyad makes you play with devices when you have days, +20 days to Zeyad!' },
  { id: 'no_fetn', title: 'No fetn', days: 25, points: 15, details: "Don't make FETN. If someone tells you “blip” please don’t tell or repeat it to anyone. +25 days." },
  { id: 'no_bother', title: 'No bother', days: 5, points: 12.5, details: 'Respect others. Don’t annoy them. +5 days.' },
  { id: 'respect', title: 'You have to respect', days: 10, points: 12.5, details: 'Treat everyone kindly and with respect, always. +10 days.' },
  { id: 'no_listen', title: 'No listen', days: 25, points: 15, details: 'You have to listen! If not, +25 days.' },
  { id: 'play_zezo', title: 'Play with Zezo', days: 25, points: 15, details: 'You must play with Zezo. If not, +25 days.' },
  { id: 'no_sad', title: 'No sad', days: 10, points: 12.5, details: 'Don’t be sad or +10 days.' },
  { id: 'no_devices', title: 'No devices when u have days = 5 days', days: 5, points: 12.5, details: 'When you have days, don’t use devices. Each minute = +5 days!' },
  { id: 'no_copy', title: 'No copy', days: 10, points: 15, details: 'You need proof (note, message) that someone gave you permission to copy them.' },
  { id: 'no_angry', title: 'No angry', days: 5, points: 12.5, details: 'Don’t be mad +5 days.' },
  { id: 'no_askzezo', title: 'dont asks zezo', days: 15, points: 12.5, details: 'Don’t ask zezo about any events or discord all instructions are put +15 days.' },
  { id: 'dont_ask_zeyad', title: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS', days: 25, points: 15, details: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS +50 DAYS' },
  { id: 'no_lie', title: 'No lie', days: 25, points: 15, details: 'Do not lie, always tell the truth. +25 days.' },
  { id: 'no_pause', title: 'No pause', days: 10, points: 12.5, details: 'No pauses. +10 days.' },
  { id: 'no_funny', title: 'No funny', days: -1, points: 1, details: 'No funny' },
  { id: 'no_shetema', title: 'No shetema', days: 10, points: 12.5, details: 'No shetema. +10 days.' },
  { id: 'no_pullhair', title: 'No pull hair', days: 10, points: 12.5, details: 'No pull hair. +10 days.' },
  { id: 'no_pinch', title: 'No pinch', days: 15, points: 12.5, details: 'No pinch. +15 days.' },
  { id: 'no_push', title: 'No push', days: 10, points: 12.5, details: 'No push. +10 days.' },
  { id: 'no_scare', title: 'No scare', days: 10, points: 12.5, details: 'No scare. +10 days.' },
  { id: 'no_dumb', title: 'No dumb', days: 15, points: 15, details: 'No dumb. +15 days.' },
  { id: 'no_discord', title: 'no discord', days: 25, points: 12.5, details: 'if you dont see discord labubu messgaes +25 days.' },
  { id: 'no_3ADY', title: 'No 3ADY', days: 25, points: 15, details: 'No 3ADY or he can reort on you 3ADY. +25 days.' }
];

const shopItems = [{cost:100,days:1},{cost:450,days:5},{cost:1450,days:15},{cost:2450,days:25},{cost:3450,days:35},{cost:4450,days:45},{cost:5450,days:55},{cost:6450,days:65},{cost:7450,days:75},{cost:8950,days:85,points:60},{cost:10450,days:100,points:75}];

const pointsExchangeItems = [{points:100,credits:500},{points:300,credits:2000},{points:500,credits:5500},{points:1000,credits:12000},{points:2000,credits:24000},{points:3000,credits:37000},{points:4000,credits:50000}];

// render rules (unchanged)
function renderRules() {
  const container = document.getElementById('rulesList');
  container.innerHTML = '';
  rules.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'rule-item';
    div.dataset.id = r.id; div.dataset.days = r.days; div.dataset.points = r.points;
    const textContainer = document.createElement('div');
    textContainer.style.flex = '1';
    textContainer.innerHTML = `<strong>${escapeHtml(r.title)}</strong><div class="rule-details">${escapeHtml(r.details)}</div>`;
    const qtyInput = document.createElement('input'); qtyInput.type='number'; qtyInput.min=0; qtyInput.value=0; qtyInput.className='rule-qty'; qtyInput.addEventListener('input', updateTotalDays);
    div.appendChild(textContainer); div.appendChild(qtyInput);
    div.addEventListener('click',(e)=>{ if(e.target.tagName.toLowerCase() !== 'input'){ div.classList.toggle('selected'); if(div.classList.contains('selected') && qtyInput.value==0) qtyInput.value = 1; else if(!div.classList.contains('selected')) qtyInput.value = 0; updateTotalDays(); } });
    container.appendChild(div);
    if(i < rules.length -1){ const hr = document.createElement('hr'); hr.style.margin='5px 0'; container.appendChild(hr); }
  });
}
renderRules();

function updateTotalDays(){
  let total = 0;
  document.querySelectorAll('.rule-item').forEach(item=>{
    const qty = parseInt(item.querySelector('input').value)||0;
    const daysPer = parseInt(item.dataset.days) || 0;
    total += daysPer * qty;
  });
  document.getElementById('total-days').textContent = `Total Days Penalty: ${total}`;
}

// USERS DROPDOWNS
async function loadUsersDropdowns(){
  const snap = await get(ref(db, "users"));
  if(snap.exists()){
    reportedUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    sendToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    sendPointsToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    notifyToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    Object.keys(snap.val()).forEach(user=>{
      reportedUserSelect.innerHTML += `<option value="${escapeHtml(user)}">${escapeHtml(user)}</option>`;
      if(user !== currentUser) {
        sendToUserSelect.innerHTML += `<option value="${escapeHtml(user)}">${escapeHtml(user)}</option>`;
        sendPointsToUserSelect.innerHTML += `<option value="${escapeHtml(user)}">${escapeHtml(user)}</option>`;
        notifyToUserSelect.innerHTML += `<option value="${escapeHtml(user)}">${escapeHtml(user)}</option>`;
      }
    });
  }
}

// LOGIN / LOGOUT (unchanged)
async function login(username, password, keep, isAutoLogin = false){
  const userRef = ref(db, `users/${username}`);
  const snap = await get(userRef);
  if(!snap.exists()) return alert("User not found");
  const data = snap.val();
  if(data.password !== password) return alert("Incorrect password");

  currentUser = username; currentUserData = data;

  const signature = data.signature || null; const expiry = signature?.expiry || 0;
  if(!signature || expiry <= Date.now()){
    await update(userRef, { days: 0, credits: 0, points: 0, signature: null, lastLogin: Date.now() });
    alert("Your signature expired or not found. You need to create a new signature now.");
    window.location.href = "signature.html?user=" + encodeURIComponent(username);
    return;
  }

  const now = new Date(); const lastLogin = data.lastLogin || 0;
  function getMidnight(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  const nowMidnight = getMidnight(now); const lastLoginMidnight = getMidnight(new Date(lastLogin));
  const msPerDay = 1000*60*60*24; let daysPassed = 0;
  if(lastLogin) daysPassed = Math.floor((nowMidnight - lastLoginMidnight) / msPerDay);
  let updatedDays = (data.days || 0) - daysPassed; if(updatedDays < 0) updatedDays = 0;
  const msLeft = expiry - Date.now(); const sigDaysLeft = Math.ceil(msLeft / msPerDay); const displayDaysLeft = sigDaysLeft > 0 ? sigDaysLeft : 0;

  await update(userRef, { days: updatedDays, lastLogin: Date.now() });
  currentUserData.days = updatedDays; currentUserData.lastLogin = Date.now();

  if(!isAutoLogin){
    welcomeText.textContent = `Welcome back, ${username}!`;
    welcomeOverlay.style.display = "flex";
    await new Promise(resolve=>{ function onClick(){ welcomeOverlay.removeEventListener('click', onClick); try{ welcomeAudio.play(); }catch(e){} welcomeOverlay.style.transition = 'opacity 0.7s ease'; welcomeOverlay.style.opacity = 0; setTimeout(()=>{ welcomeOverlay.style.display = 'none'; welcomeOverlay.style.opacity = 1; resolve(); },700); } welcomeOverlay.addEventListener('click', onClick); });
  }

  document.getElementById("login-form").style.display = "none";
  document.getElementById("report-form").style.display = "block";
  reporterInput.value = username;
  daysSpan.textContent = updatedDays;
  creditsSpan.textContent = data.credits || 0;
  pointsSpan.textContent = data.points || 0;
  sigDaysLeftSpan.textContent = displayDaysLeft;

  await loadUsersDropdowns();

  // start listening to notifications for this user
  listenToNotifications();
}

function logout(){ currentUser = null; currentUserData = null; localStorage.removeItem('loginData'); sessionStorage.removeItem('loginData'); document.getElementById('login-form').style.display='block'; document.getElementById('report-form').style.display='none'; closeIslandMenu(); updateNotifyDot(0); clearSecretMode(); }

// SHOP / POINTS RENDER (unchanged)
function renderShopItems(){
  const shopContainer = document.getElementById('shopItems');
  shopContainer.innerHTML = '';
  shopItems.forEach((item, idx)=>{
    if(currentSecretCode){
      const remaining = (currentSecretCode.purchasesLimit != null) ? Math.max(0, currentSecretCode.purchasesLimit - (currentSecretCode.used||0)) : '∞';
      const html = `<div style="margin-bottom:8px;"><div>Remove ${item.days} days — <strong>FREE</strong></div>
        <div style="font-size:0.85rem;margin-top:6px;">Secret code: ${escapeHtml(currentSecretCode.code)} • Uses left: ${remaining}</div>
        <button onclick="buyItemSecret('${currentSecretCode.code}', ${item.days})">Take for free</button></div>`;
      shopContainer.innerHTML += html;
    } else {
      shopContainer.innerHTML += `<div style="margin-bottom:8px;"><div>Remove ${item.days} days — Cost: ${item.cost} <img src="EGP.png" class="coin-icon" alt="coin"></div>
        <button onclick="buyItem(${item.cost}, ${item.days})">Buy: ${item.cost} <img src="EGP.png" class="coin-icon" alt="coin"></button></div>`;
    }
  });
}
renderShopItems();

function renderPointsExchangeItems(){
  const exchangeContainer = document.getElementById('pointsExchangeItems');
  exchangeContainer.innerHTML = '';
  pointsExchangeItems.forEach(item=>{
    exchangeContainer.innerHTML += `<button onclick="exchangePoints(${item.points}, ${item.credits})">Exchange ${item.points} Points → ${item.credits} <img src="EGP.png" class="coin-icon" alt="coin"></button><br>`;
  });
}
renderPointsExchangeItems();

// ISLAND MENU BEHAVIOR (unchanged)
const islandEl = document.getElementById('dynamic-island');
const islandMenu = document.getElementById('islandMenu');

function positionIslandMenu(){
  const rect = islandEl.getBoundingClientRect();
  let maxAllowed = Math.min(window.innerWidth - 20, 520);
  if(window.innerWidth <= 420) maxAllowed = Math.min(window.innerWidth - 20, 380);
  const menuWidth = Math.max(Math.min(maxAllowed, 520), 320);
  const left = Math.round((window.innerWidth - menuWidth) / 2);
  const top = Math.round(rect.bottom + 8);
  islandMenu.style.left = `${left}px`;
  islandMenu.style.top = `${top}px`;
  islandMenu.style.width = `${menuWidth}px`;
  islandMenu.style.borderTopLeftRadius = '20px';
  islandMenu.style.borderTopRightRadius = '20px';
  islandMenu.style.borderBottomLeftRadius = '22px';
  islandMenu.style.borderBottomRightRadius = '22px';
  return menuWidth;
}

let islandOpen = false;
function showMenuPanel(panelId, buttonId){
  document.querySelectorAll('.menu-panel').forEach(p => p.classList.remove('show'));
  const panel = document.getElementById(panelId);
  if(panel) panel.classList.add('show');
  document.querySelectorAll('.menu-actions button').forEach(b => b.classList.remove('active'));
  if(buttonId) {
    const btn = document.getElementById(buttonId);
    if(btn) btn.classList.add('active');
  }
  positionIslandMenu();
}

function openIslandMenu(){
  const rect = islandEl.getBoundingClientRect();
  const closedWidth = rect.width;
  islandEl.dataset.closedWidth = closedWidth;
  const menuWidth = positionIslandMenu();
  islandEl.style.width = `${menuWidth}px`;
  islandEl.style.borderBottomLeftRadius = '14px';
  islandEl.style.borderBottomRightRadius = '14px';
  const bg = getComputedStyle(document.documentElement).getPropertyValue('--island-bg');
  islandEl.style.background = bg;
  islandMenu.style.background = bg;
  islandMenu.classList.add('open');
  islandMenu.setAttribute('aria-hidden', 'false');
  islandOpen = true;
  showMenuPanel('panelShop', 'menuShopBtn');
}

function closeIslandMenu(){
  islandMenu.classList.remove('open');
  islandMenu.setAttribute('aria-hidden', 'true');
  islandOpen = false;
  const closedWidth = islandEl.dataset.closedWidth || '';
  if(closedWidth){
    islandEl.style.width = `${closedWidth}px`;
    islandEl.style.borderBottomLeftRadius = '';
    islandEl.style.borderBottomRightRadius = '';
    const reset = () => { islandEl.style.width = ''; islandEl.removeEventListener('transitionend', reset); };
    islandEl.addEventListener('transitionend', reset);
    setTimeout(()=>{ if(islandEl.style.width !== ''){ islandEl.style.width = ''; } }, 400);
  }
  document.querySelectorAll('.menu-actions button').forEach(b => b.classList.remove('active'));
}

islandEl.addEventListener('click', (e)=>{
  if(islandOpen && islandMenu.contains(e.target)) return;
  if(!islandOpen) openIslandMenu(); else closeIslandMenu();
});
window.addEventListener('resize', ()=>{ if(islandOpen) positionIslandMenu(); });
window.addEventListener('scroll', ()=>{ if(islandOpen) positionIslandMenu(); });
document.addEventListener('click', (e)=>{ if(!islandEl.contains(e.target) && !islandMenu.contains(e.target)) closeIslandMenu(); });

document.getElementById('menuShopBtn').addEventListener('click', ()=> showMenuPanel('panelShop','menuShopBtn'));
document.getElementById('menuSendCreditsBtn').addEventListener('click', ()=> showMenuPanel('panelSendCredits','menuSendCreditsBtn'));
document.getElementById('menuExchangeBtn').addEventListener('click', ()=> showMenuPanel('panelExchange','menuExchangeBtn'));
document.getElementById('menuSendPointsBtn').addEventListener('click', ()=> showMenuPanel('panelSendPoints','menuSendPointsBtn'));
document.getElementById('menuCustomizeBtn').addEventListener('click', ()=> showMenuPanel('panelCustomize','menuCustomizeBtn'));
document.getElementById('menuNotificationsBtn').addEventListener('click', ()=> showMenuPanel('panelNotifications','menuNotificationsBtn'));
document.getElementById('menuSendNotificationBtn').addEventListener('click', ()=> showMenuPanel('panelSendNotification','menuSendNotificationBtn'));

// SECRET button wiring
document.getElementById('menuSecretBtn').addEventListener('click', async ()=> {
  const code = prompt("Enter 5-digit secret code:");
  if(!code) return;
  await tryActivateSecretCode(code.trim());
});

document.getElementById('clearSecretBtn').addEventListener('click', ()=> { clearSecretMode(); renderShopItems(); });

// color palette
const colorPalette = document.getElementById('colorPalette');
colorPalette.querySelectorAll('.sw').forEach(sw=>{
  sw.addEventListener('click', ()=>{
    const c = sw.dataset.color;
    applyIslandColor(c);
    localStorage.setItem('islandColor', c);
  });
});
function applyIslandColor(name){
  let css = '';
  switch(name){
    case 'black': css = '#000'; break;
    case 'red': css = 'linear-gradient(90deg,#ff4b4b,#c0392b)'; break;
    case 'orange': css = 'linear-gradient(90deg,#ff8a00,#ff5e00)'; break;
    case 'yellow': css = 'linear-gradient(90deg,#ffd54a,#ffb300)'; break;
    case 'purple': css = 'linear-gradient(90deg,#9b59b6,#6a2a89)'; break;
    case 'pink': css = 'linear-gradient(90deg,#ff7eb6,#ff4d94)'; break;
    case 'green': css = 'linear-gradient(90deg,#2ecc71,#27ae60)'; break;
    default: css = '#000';
  }
  document.documentElement.style.setProperty('--island-bg', css);
  islandEl.style.background = css;
  islandMenu.style.background = css;
}
const savedColor = localStorage.getItem('islandColor'); if(savedColor) applyIslandColor(savedColor);

// BUY / EXCHANGE / SEND FUNCTIONS (unchanged)
async function buyItem(cost, daysToRemove){
  if(!currentUser) return alert('Please login first.');
  if((currentUserData.credits||0) < cost) return alert('Not enough credits.');
  if((currentUserData.days||0) < daysToRemove) return alert(`You don't have enough days to remove (${daysToRemove} required).`);
  try{
    try{ document.getElementById('applePayAudio').play(); }catch(e){}
    const bankAmount = Math.floor(cost * 0.90); const zezoAmount = cost - bankAmount;
    const updates = {};
    updates[`users/${currentUser}/credits`] = (currentUserData.credits||0) - cost;
    updates[`users/${currentUser}/days`] = (currentUserData.days||0) - daysToRemove;

    const bankSnap = await get(ref(db, `users/bank`));
    const zezoSnap = await get(ref(db, `users/zezo`));
    const bankAmtNow = bankSnap.exists() ? (bankSnap.val().credits||0) : 0;
    const zezoAmtNow = zezoSnap.exists() ? (zezoSnap.val().credits||0) : 0;
    updates[`users/bank/credits`] = bankAmtNow + bankAmount;
    updates[`users/zezo/credits`] = zezoAmtNow + zezoAmount;

    await update(ref(db), updates);
    currentUserData.credits -= cost; currentUserData.days -= daysToRemove;
    creditsSpan.textContent = currentUserData.credits; daysSpan.textContent = currentUserData.days;
    alert(`Bought item for ${cost} credits. Removed ${daysToRemove} days. 90% went to Bank and remainder to Zezo.`);
  }catch(err){ console.error(err); alert('Failed to complete purchase: '+err.message); }
}
window.buyItem = buyItem;

async function buyItemSecret(code, daysToRemove){
  if(!currentUser) return alert('Please login first.');
  if(!code) return alert('No secret code active.');
  const codeRef = ref(db, `secretCodes/${code}`);
  const snap = await get(codeRef);
  if(!snap.exists()) return alert('Invalid secret code.');
  const codeData = snap.val();
  const now = Date.now();
  if(codeData.expiry && now > codeData.expiry) return alert('This secret code has expired.');
  if(codeData.purchasesLimit != null && (codeData.used||0) >= codeData.purchasesLimit) return alert('This secret code has reached its maximum number of purchases.');
  try{
    const userRef = ref(db, `users/${currentUser}`);
    const userSnap = await get(userRef);
    const userData = userSnap.exists()? userSnap.val() : {};
    const newDays = Math.max(0, (userData.days||0) - daysToRemove);
    const updates = {};
    updates[`users/${currentUser}/days`] = newDays;
    updates[`secretCodes/${code}/used`] = (codeData.used||0) + 1;
    updates[`secretCodes/${code}/usedBy/${currentUser}`] = { when: Date.now() };
    await update(ref(db), updates);

    currentUserData.days = newDays;
    daysSpan.textContent = currentUserData.days;

    alert(`Secret purchase successful. ${daysToRemove} days removed (free).`);
    if(codeData.purchasesLimit != null && (codeData.used||0) + 1 >= codeData.purchasesLimit){
      alert('This secret code has now reached its purchase limit and is no longer valid.');
      clearSecretMode();
      renderShopItems();
    } else {
      currentSecretCode = { ...codeData, used: (codeData.used||0) + 1 };
      updateSecretUI();
      renderShopItems();
    }
  }catch(err){ console.error(err); alert('Failed secret purchase: '+err.message); }
}
window.buyItemSecret = buyItemSecret;

async function exchangePoints(pointsToExchange, creditsToReceive){
  if(!currentUser) return alert('Please login first.');
  if((currentUserData.points||0) < pointsToExchange) return alert('Not enough points to make this exchange.');
  const newPoints = (currentUserData.points||0) - pointsToExchange; const newCredits = (currentUserData.credits||0) + creditsToReceive;
  try{
    const userRef = ref(db, `users/${currentUser}`);
    await update(userRef, { points: newPoints, credits: newCredits });
    currentUserData.points = newPoints; currentUserData.credits = newCredits;
    pointsSpan.textContent = currentUserData.points; creditsSpan.textContent = currentUserData.credits;
    alert(`Exchanged ${pointsToExchange} points for ${creditsToReceive} credits!`);
  }catch(err){ console.error(err); alert('Failed to complete exchange.'); }
}
window.exchangePoints = exchangePoints;

async function sendCredits(){
  if(!currentUser) return alert('Please login first.');
  const toUser = sendToUserSelect.value; const amount = parseInt(document.getElementById('sendAmount').value);
  if(!toUser) return alert('Select a user to send credits to.');
  if(!amount || amount<=0) return alert('Enter a valid amount.');
  if((currentUserData.credits||0) < amount) return alert('Not enough credits.');
  const senderRef = ref(db, `users/${currentUser}`); const receiverRef = ref(db, `users/${toUser}`);
  try{
    const receiverSnap = await get(receiverRef); if(!receiverSnap.exists()) return alert('Receiver user not found.');
    const receiverCredits = receiverSnap.val().credits||0;
    const updates = {};
    updates[`users/${currentUser}/credits`] = (currentUserData.credits||0) - amount;
    updates[`users/${toUser}/credits`] = receiverCredits + amount;
    await update(ref(db), updates);
    currentUserData.credits -= amount; creditsSpan.textContent = currentUserData.credits; alert(`Sent ${amount} credits to ${toUser}.`);
  }catch(err){ console.error(err); alert('Failed to send credits.'); }
}
window.sendCredits = sendCredits;

async function sendPoints(){
  if(!currentUser) return alert('Please login first.');
  const toUser = sendPointsToUserSelect.value; const amount = parseInt(document.getElementById('sendPointsAmount').value);
  if(!toUser) return alert('Select a user to send points to.');
  if(!amount || amount<=0) return alert('Enter a valid amount.');
  if((currentUserData.points||0) < amount) return alert('Not enough points.');
  try{
    const receiverRef = ref(db, `users/${toUser}`);
    const receiverSnap = await get(receiverRef); if(!receiverSnap.exists()) return alert('Receiver user not found.');
    const receiverPoints = receiverSnap.val().points||0;
    const updates = {};
    updates[`users/${currentUser}/points`] = (currentUserData.points||0) - amount;
    updates[`users/${toUser}/points`] = receiverPoints + amount;
    await update(ref(db), updates);
    currentUserData.points -= amount; pointsSpan.textContent = currentUserData.points; alert(`Sent ${amount} points to ${toUser}.`);
  }catch(err){ console.error(err); alert('Failed to send points.'); }
}
window.sendPoints = sendPoints;

// NOTIFICATIONS (sendNotification unchanged; forwarding done by compat script below)
async function sendNotification(){
  if(!currentUser) return alert('Please login first.');
  const to = notifyToUserSelect.value; const title = document.getElementById('notifyTitle').value.trim(); const description = document.getElementById('notifyDescription').value.trim();
  if(!to) return alert('Select a recipient'); if(!title) return alert('Enter a title');
  const nref = push(ref(db, 'notifications'));
  const notif = { from: currentUser, to, title, description, timestamp: Date.now(), read: false };
  try{ await update(nref, notif); document.getElementById('notifyTitle').value=''; document.getElementById('notifyDescription').value=''; alert('Notification sent'); }catch(err){ console.error(err); alert('Failed to send notification'); }
}
document.getElementById('sendNotificationBtn').addEventListener('click', sendNotification);

// notification UI + delete button wiring
let notificationsCache = {};
function listenToNotifications(){
  const notificationsRef = ref(db, 'notifications');
  onValue(notificationsRef, (snap)=>{
    const all = snap.exists() ? snap.val() : {};
    const myNotifs = [];
    Object.entries(all).forEach(([id, n])=>{
      if(n && n.to === currentUser){ myNotifs.push({ id, ...n }); }
    });
    myNotifs.sort((a,b)=> b.timestamp - a.timestamp);
    notificationsCache = {};
    myNotifs.forEach(n => notificationsCache[n.id] = n);
    renderNotificationsList(myNotifs);
    const unread = myNotifs.filter(n=>!n.read).length;
    updateNotifyDot(unread);
  });
}
function updateNotifyDot(count){ if(count && count > 0){ notifyDot.classList.add('active'); } else { notifyDot.classList.remove('active'); } }
function formatWhen(ts){ const d = new Date(ts); return d.toLocaleString(); }
function renderNotificationsList(list){
  const container = document.getElementById('notificationsList');
  if(!list || list.length === 0){ container.innerHTML = 'No notifications.'; return; }
  container.innerHTML = '';
  list.forEach(n=>{
    const div = document.createElement('div');
    div.className = 'notification-item' + (n.read? '' : ' unread');
    div.dataset.id = n.id;
    const left = document.createElement('div');
    left.style.flex = '1';
    left.innerHTML = `<strong>${escapeHtml(n.title)}</strong><div class="notification-meta">From: ${escapeHtml(n.from)} • ${formatWhen(n.timestamp)}</div>`;
    div.appendChild(left);
    // clicking left area shows details
    left.addEventListener('click', ()=> showNotificationDetails(n.id));
    // delete button
    const del = document.createElement('button');
    del.className = 'tiny-del';
    del.textContent = 'Delete';
    del.addEventListener('click', async (ev)=>{ ev.stopPropagation(); await deleteNotification(n.id); });
    div.appendChild(del);
    container.appendChild(div);
  });
}
async function showNotificationDetails(id){
  const n = notificationsCache[id]; if(!n) return alert('Notification not found');
  const details = `From: ${n.from}\nTitle: ${n.title}\nWhen: ${formatWhen(n.timestamp)}\n\n${n.description || ''}`;
  alert(details);
  if(!n.read){ try{ const nr = ref(db, `notifications/${id}`); await update(nr, { read: true }); }catch(err){ console.error(err); } }
}
async function deleteNotification(id){ if(!confirm('Delete this notification?')) return; try{ await remove(ref(db, `notifications/${id}`)); alert('Deleted'); }catch(err){ console.error(err); alert('Failed to delete'); } }

// EVENTS SECTION (unchanged)
function formatCountdown(msLeft){ if(msLeft <= 0) return 'Expired'; const totalSeconds = Math.floor(msLeft/1000); const days = Math.floor(totalSeconds/(24*3600)); const hours = Math.floor((totalSeconds%(24*3600))/3600); const minutes = Math.floor((totalSeconds%3600)/60); const seconds = totalSeconds%60; let parts = []; if(days>0) parts.push(`${days}d`); if(hours>0||days>0) parts.push(`${hours}h`); if(minutes>0||hours>0||days>0) parts.push(`${minutes}m`); parts.push(`${seconds}s`); return parts.join(' '); }
const eventsRef = ref(db, 'events');
function renderEvents(events){ const eventsListEl = document.getElementById('eventsList'); eventsListEl.innerHTML = ''; const now = Date.now(); let hasEvents = false; Object.entries(events||{}).forEach(([eventId,ev])=>{
  if(!ev.endTime || now > ev.endTime){ remove(ref(db, `events/${eventId}`)); return; }
  hasEvents = true;
  const div = document.createElement('div'); div.className = 'event-item';
  const titleEl = document.createElement('h4'); titleEl.textContent = ev.title; div.appendChild(titleEl);
  const detailsEl = document.createElement('p'); detailsEl.textContent = ev.description; div.appendChild(detailsEl);
  const countdownEl = document.createElement('p'); countdownEl.className = 'countdown'; div.appendChild(countdownEl);
  function updateCountdown(){ const msLeft = ev.endTime - Date.now(); if(msLeft <= 0){ countdownEl.textContent = 'Time left: Expired'; remove(ref(db, `events/${eventId}`)); return; } countdownEl.textContent = `Time left: ${formatCountdown(msLeft)}`; }
  updateCountdown(); setInterval(updateCountdown,1000);
  eventsListEl.appendChild(div);
});
if(!hasEvents) eventsListEl.textContent = 'No active events at this time.'; }
onValue(eventsRef, (snapshot)=>{ renderEvents(snapshot.val() || {}); });

// REPORT SUBMIT (unchanged)
document.getElementById('reportForm').onsubmit = async e => {
  e.preventDefault(); if(!currentUser) return alert('Please login first.'); const reportedUser = reportedUserSelect.value; if(!reportedUser) return alert('Please select the user you want to report.');
  const selectedRules = []; let totalDays = 0; let totalPoints = 0;
  document.querySelectorAll('.rule-item').forEach(item=>{ const qty = parseInt(item.querySelector('input').value)||0; if(qty>0){ const daysPer = parseInt(item.dataset.days); const pointsPer = parseInt(item.dataset.points); selectedRules.push({ id: item.dataset.id, title: item.querySelector('strong').textContent, qty, daysPerOffense: daysPer, pointsPerOffense: pointsPer }); totalDays += daysPer * qty; totalPoints += pointsPer * qty; } });
  if(selectedRules.length === 0) return alert('Please select at least one rule broken.');
  const report = { reporter: currentUser, reportedUser, rules: selectedRules, totalDays, totalPoints, timestamp: Date.now() };

  try{
    const autoAcceptSnap = await get(ref(db, 'settings/autoAcceptReports'));
    const autoAccept = autoAcceptSnap.exists() && autoAcceptSnap.val() === true;

    if(autoAccept){
      const reportedUserRef = ref(db, `users/${reportedUser}`);
      const reporterUserRef = ref(db, `users/${currentUser}`);
      const [reportedUserSnap, reporterUserSnap] = await Promise.all([ get(reportedUserRef), get(reporterUserRef) ]);
      const reportedUserData = reportedUserSnap.val(); const reporterUserData = reporterUserSnap.val();
      const newReportedDays = (Number(reportedUserData.days||0) + Number(totalDays));
      const newReporterPoints = (Number(reporterUserData.points||0) + Number(totalPoints));
      const updates = {};
      updates[`users/${reportedUser}/days`] = newReportedDays;
      updates[`users/${currentUser}/points`] = newReporterPoints;
      await update(ref(db), updates);
      currentUserData.points = newReporterPoints; pointsSpan.textContent = currentUserData.points;
      alert(`Report auto accepted: ${totalDays} days added to ${reportedUser}, and you received ${totalPoints} points.`);
    } else {
      const newReportRef = push(ref(db, 'reports'));
      await update(newReportRef, report);
      alert('Report submitted for manual approval. You will receive points upon approval.');
    }

    document.getElementById('reportForm').reset(); renderRules(); updateTotalDays();
  }catch(error){ console.error('Error submitting report:', error); alert('Failed to submit report: ' + error.message); }
}

// island metric rotation (unchanged)
const metrics = ['days','credits','points','sig'];
let metricIndex = 0;
const islandDisplay = document.getElementById('islandDisplay');
function showMetric(index){
  const items = islandDisplay.querySelectorAll('.island-metric');
  items.forEach(it=> it.style.display = 'none');
  const m = items[index % items.length]; if(m) m.style.display = 'flex';
}
showMetric(metricIndex);
setInterval(()=>{ metricIndex = (metricIndex + 1) % metrics.length; showMetric(metricIndex); }, 1500);

// AUTO LOGIN & button wiring
window.addEventListener('load', ()=>{
  let saved = localStorage.getItem('loginData') || sessionStorage.getItem('loginData');
  if(saved){ try{ const { username, password } = JSON.parse(saved); login(username, password, true, true); }catch(e){ console.error('Failed to parse saved login:', e); } }
});

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const keep = document.getElementById('keepSignedIn').checked;
  if(!u||!p) return alert('Enter username and password');
  if(keep) localStorage.setItem('loginData', JSON.stringify({ username: u, password: p })); else sessionStorage.setItem('loginData', JSON.stringify({ username: u, password: p }));
  await login(u,p,keep,false);
});

document.getElementById('sendBtn').addEventListener('click', ()=> sendCredits());
document.getElementById('sendPointsBtn').addEventListener('click', ()=> sendPoints());
document.getElementById('menuLogoutBtn').addEventListener('click', () => { logout(); });

// helper escape
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]; }); }

// ---------- SECRET CODE LOGIC (unchanged) ----------
async function tryActivateSecretCode(code){
  code = String(code).trim();
  if(!/^\d{5}$/.test(code)) { alert('Code must be 5 digits.'); return; }
  const codeRef = ref(db, `secretCodes/${code}`);
  const snap = await get(codeRef);
  if(!snap.exists()){ alert('Secret code not found'); return; }
  const data = snap.val();
  const now = Date.now();
  if(data.expiry && now > data.expiry){ alert('This code has expired.'); return; }
  if(data.purchasesLimit != null && (data.used||0) >= data.purchasesLimit){ alert('This code has reached its purchase limit.'); return; }
  currentSecretCode = { ...data };
  updateSecretUI();
  renderShopItems();
  showMenuPanel('panelShop', 'menuShopBtn');
  alert('Secret code accepted — secret shop unlocked (free purchases while valid).');
}

function updateSecretUI(){
  const secretInfo = document.getElementById('secretInfo');
  if(!currentSecretCode){ secretInfo.style.display = 'none'; return; }
  const details = [];
  if(currentSecretCode.expiry) details.push(`Expires: ${new Date(currentSecretCode.expiry).toLocaleString()}`);
  if(currentSecretCode.purchasesLimit != null) details.push(`Purchase limit: ${currentSecretCode.purchasesLimit} (used: ${currentSecretCode.used||0})`);
  document.getElementById('secretModeDetails').textContent = details.join(' • ');
  secretInfo.style.display = 'block';
}

function clearSecretMode(){
  currentSecretCode = null;
  updateSecretUI();
  renderShopItems();
}

// small message helper (unchanged)
function showTempMessage(text, timeout=3000){
  const container = document.getElementById('messageContainer');
  const box = document.createElement('div');
  box.style.background = "black"; box.style.padding = "12px"; box.style.borderRadius = "10px"; box.style.wordWrap = "break-word"; box.style.textAlign = "center"; box.style.maxWidth = "100%";
  box.innerHTML = escapeHtml(text);
  container.appendChild(box);
  setTimeout(()=> box.remove(), timeout);
}
</script>

<!-- legacy compat scripts left for messages section as you had them (not required by the above module) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // compat initialization and enhanced message + discord-forwarder logic
  const firebaseConfigCompat = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
  };
  firebase.initializeApp(firebaseConfigCompat);
  const dbCompat = firebase.database();

  /* ----------------- messages UI with delete button ----------------- */
  const seen = new Set(JSON.parse(localStorage.getItem("seenMsgs") || "[]"));
  const container = document.getElementById("messageContainer");

  // keep a map from message id -> element, so child_removed can remove element
  const msgEls = {};

  // When a message added, show it with a Delete button
  dbCompat.ref("messages").on("child_added", snap => {
    const data = snap.val(); const msgId = snap.key;
    if(seen.has(msgId)) return;
    seen.add(msgId);
    localStorage.setItem("seenMsgs", JSON.stringify(Array.from(seen)));

    const box = document.createElement("div");
    box.dataset.msgId = msgId;
    box.style.background = "black"; box.style.padding = "12px"; box.style.borderRadius = "10px"; box.style.wordWrap = "break-word"; box.style.textAlign = "center"; box.style.maxWidth = "100%";
    box.style.position = "relative";

    const inner = document.createElement("div");
    inner.innerHTML = `<strong>${escapeHtml(data.name||'Message')}</strong>${data.withImage? ' <img src="roblox.png" alt="icon" style="height:20px;vertical-align:middle;">':''}: ${escapeHtml(data.message||'')}`;
    box.appendChild(inner);

    // delete button (visible)
    const delBtn = document.createElement("button");
    delBtn.className = "tiny-del";
    delBtn.textContent = "Delete";
    delBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if(!confirm("Delete this message?")) return;
      try {
        await dbCompat.ref(`messages/${msgId}`).remove();
      } catch(err) {
        console.error('Failed to delete message', err);
        alert('Failed to delete message');
      }
    });
    box.appendChild(delBtn);

    container.appendChild(box);
    msgEls[msgId] = box;

    // auto-remove after duration if provided (still keep delete button available)
    const duration = Number(data.duration || 5);
    if(duration > 0) {
      setTimeout(()=> {
        if(box.parentNode) box.remove();
        delete msgEls[msgId];
      }, duration * 1000);
    }
  });

  // When a message removed in DB, remove its element if present
  dbCompat.ref("messages").on("child_removed", snap => {
    const id = snap.key;
    const el = msgEls[id];
    if(el && el.parentNode) el.remove();
    delete msgEls[id];
  });

  /* -------------- Discord forwarder for notifications (client-side) --------------
     NOTE: Posts only the single content "you got a notification" to the mapped webhook.
     Reminder: exposing webhooks in client JS is public. For security, move to server/Cloud Function.
  */
  const recipientWebhooks = {
    "zezo": "https://discord.com/api/webhooks/1413868799488295105/I1FCcBev6fYbZkXMrsaUHqm41mWRQdMv8JGwVIjYFdhpli9eT-efJUXNRF-RjvrHMyzS",
    "layan": "https://discord.com/api/webhooks/1413869557310820454/D13si1VaoBiNphj_91EcBOH-vjoS3yHxDNFEMbieJ1ujsFKaxHME5VE4xcKRNuC7Zgtf",
    "asser": "https://discord.com/api/webhooks/1413869668522790922/i6ATTYdvpLjbjtYJDAS0vzqlbu4gTrjbSqKQFAml30_jbIoZWgNH9xyQoxwSnm7Jy7bX"
  };

  // Listen for new notifications. When one is created, if it targets a mapped recipient,
  // forward a minimal message "you got a notification" to the webhook, then mark as forwarded.
  dbCompat.ref('notifications').on('child_added', async snap => {
    try {
      const id = snap.key;
      const n = snap.val();
      if(!n) return;
      // avoid re-forwarding
      if(n.discordSent) return;
      const to = (n.to || '').toString().trim().toLowerCase();
      const webhookUrl = recipientWebhooks[to];
      if(!webhookUrl) return;

      // Only send the single text the user requested
      const payload = { content: "you got a notification" };

      const res = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if(res.ok){
        // mark notification as forwarded to discord
        await dbCompat.ref(`notifications/${id}`).update({ discordSent: true, discordSentAt: Date.now() });
        console.log('Forwarded notification', id, '->', to);
      } else {
        const txt = await res.text().catch(()=>'<no body>');
        console.warn('Discord webhook non-ok', res.status, txt);
      }
    } catch (err) {
      console.error('Error forwarding notification to Discord:', err);
    }
  });

</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<style>
  /* keep the same small styles used before */
  .bottom-dock { position: fixed; right: 14px; bottom: 18px; left: 14px; z-index: 100001; display:flex; justify-content:space-between; gap:8px; max-width:700px; margin: 0 auto; pointer-events: auto; }
  .dock-btn { flex:1 1 0; padding: 12px; border-radius: 12px; background:#ffffff; color:#2b4c7e; border:1px solid #cfd8e3; font-weight:700; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); cursor:pointer; }
  .dock-btn.primary { background: #2b4c7e; color: white; }
  .create-modal, .watch-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100002; background: rgba(0,0,0,0.6); padding: 20px; }
  .create-modal.show, .watch-modal.show { display:flex; }
  .modal-card { width: 100%; max-width: 760px; max-height: 90vh; overflow:auto; background: white; border-radius: 12px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
  .modal-header { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .watch-scroll { display:flex; flex-direction:column; gap:12px; padding: 12px 0; }
  .short-item { background:#111; color: #fff; border-radius:10px; overflow:hidden; position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height: 300px; }
  .short-media { width:100%; max-height:720px; object-fit:cover; display:block; background:black; }
  .short-meta { padding: 10px; width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px; box-sizing:border-box; }
  .short-controls { display:flex; gap:8px; align-items:center; }
  .short-controls button { background: rgba(255,255,255,0.08); border: none; color: white; padding: 8px 10px; border-radius: 8px; font-weight:700; cursor:pointer; }
  .comments-panel { margin-top:8px; background: rgba(0,0,0,0.06); padding:8px; border-radius:8px; max-height:200px; overflow:auto; width:100%; box-sizing:border-box; color:#111; background:#fff; }
  .comment-item { padding:6px 8px; border-bottom:1px solid rgba(0,0,0,0.06); }
  .like-count { font-weight:700; margin-left:6px; color:inherit; }
  @media(max-width:520px){ .short-item { min-height: 520px; } .dock-btn { padding: 14px; } }
</style>

<div class="bottom-dock" aria-hidden="false">
  <button id="dockHome" class="dock-btn">🏠 Home</button>
  <button id="dockCreate" class="dock-btn">➕ Create</button>
  <button id="dockWatch" class="dock-btn primary">▶ Watch</button>
</div>

<div id="createModal" class="create-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-label="Create short">
    <div class="modal-header">
      <h3 style="margin:0">Create Video / Photo</h3>
      <button id="closeCreate" class="dock-btn" style="flex:0 0 auto;background:#eee;color:#2b4c7e;border-radius:8px;padding:8px 10px;">Close</button>
    </div>
    <div style="margin-top:10px;">
      <label>Title (required)</label>
      <input id="shortTitle" placeholder="Short title" />
      <label>Description (optional)</label>
      <input id="shortDescription" placeholder="Description (optional)" />
      <label style="margin-top:8px">Choose media (photo or video) (required)</label>
      <input id="shortMedia" type="file" accept="image/*,video/*" />
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button id="postShort" class="dock-btn primary" style="flex:1;">Post</button>
        <div id="uploadProgress" style="min-width:160px;font-size:0.95rem;"></div>
      </div>
      <div id="createStatus" style="margin-top:8px; font-size:0.9rem;"></div>
    </div>
  </div>
</div>

<div id="watchModal" class="watch-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-label="Watch shorts">
    <div class="modal-header">
      <h3 style="margin:0">Shorts</h3>
      <div style="display:flex; gap:8px;">
        <button id="closeWatch" class="dock-btn" style="flex:0 0 auto;background:#eee;color:#2b4c7e;border-radius:8px;padding:8px 10px;">Close</button>
        <button id="refreshShorts" class="dock-btn" style="flex:0 0 auto;background:#fff;color:#2b4c7e;border-radius:8px;padding:8px 10px;">Refresh</button>
      </div>
    </div>

    <div id="shortsContainer" style="margin-top:12px;">
      <div id="shortsList" class="watch-scroll">Loading shorts...</div>
    </div>
  </div>
</div>

<script>
/*
  Storage-backed Shorts snippet (compat)
  - Upload media to Firebase Storage at: shorts-media/{shortId}/{filename}
  - Save metadata to Realtime DB at: shorts/{shortId} containing { user, title, description, mediaURL, mediaType, timestamp }
  - Comments & likes continue to live under shorts/{shortId}/comments and /likes
  - Uses existing compat firebase namespace (firebase) and dbCompat (firebase.database())
*/

// fallback small helpers
function _escapeHtml(s){ if(window.escapeHtml) return window.escapeHtml(s); if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]; }); }
function _getLoggedUserFromStorage(){ try{ const raw = localStorage.getItem('loginData') || sessionStorage.getItem('loginData'); if(!raw) return null; const { username } = JSON.parse(raw); return username || null; }catch(e){ return null; } }

// DOM refs
const createModal = document.getElementById('createModal');
const watchModal = document.getElementById('watchModal');
const dockHome = document.getElementById('dockHome');
const dockCreate = document.getElementById('dockCreate');
const dockWatch = document.getElementById('dockWatch');
const closeCreate = document.getElementById('closeCreate');
const closeWatch = document.getElementById('closeWatch');
const postShortBtn = document.getElementById('postShort');
const shortMediaInput = document.getElementById('shortMedia');
const shortTitleInput = document.getElementById('shortTitle');
const shortDescInput = document.getElementById('shortDescription');
const createStatus = document.getElementById('createStatus');
const uploadProgress = document.getElementById('uploadProgress');
const shortsListEl = document.getElementById('shortsList');
const refreshShortsBtn = document.getElementById('refreshShorts');

dockHome.addEventListener('click', ()=> location.reload());
dockCreate.addEventListener('click', ()=> openCreateModal());
dockWatch.addEventListener('click', ()=> openWatchModal());
closeCreate.addEventListener('click', ()=> closeCreateModal());
closeWatch.addEventListener('click', ()=> closeWatchModal());
refreshShortsBtn.addEventListener('click', ()=> loadShorts(true));

function openCreateModal(){ createModal.classList.add('show'); createModal.setAttribute('aria-hidden','false'); }
function closeCreateModal(){ createModal.classList.remove('show'); createModal.setAttribute('aria-hidden','true'); shortTitleInput.value=''; shortDescInput.value=''; shortMediaInput.value=''; createStatus.innerText=''; uploadProgress.innerText=''; }
function openWatchModal(){ watchModal.classList.add('show'); watchModal.setAttribute('aria-hidden','false'); loadShorts(); }
function closeWatchModal(){ watchModal.classList.remove('show'); watchModal.setAttribute('aria-hidden','true'); }

// short helper to show status
function setCreateStatus(text, isError=false){ createStatus.textContent = text; createStatus.style.color = isError ? 'crimson' : 'green'; }

// POST (upload to storage then save metadata)
postShortBtn.addEventListener('click', async ()=>{
  const user = (window.currentUser || _getLoggedUserFromStorage());
  if(!user){ alert('Please login to post a short.'); return; }

  const title = (shortTitleInput.value || '').trim();
  const desc = (shortDescInput.value || '').trim();
  const file = (shortMediaInput.files && shortMediaInput.files[0]) || null;
  if(!title) return alert('Title is required.');
  if(!file) return alert('Please choose an image or video file.');

  setCreateStatus('Preparing upload...');
  uploadProgress.textContent = '';

  try{
    // simple large file check
    if(file.size > (500 * 1024 * 1024)){ // 500MB hard cap
      if(!confirm('File > 500MB. Continue?')){ setCreateStatus('Upload cancelled'); return; }
    }

    // create DB record first to reserve an id
    const newRef = dbCompat.ref('shorts').push(); // returns a ref with key
    const shortId = newRef.key;
    const filename = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
    const storagePath = `shorts-media/${shortId}/${filename}`;
    const storageRef = firebase.storage().ref(storagePath);

    // start upload
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed', snapshot => {
      const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
      uploadProgress.textContent = `Uploading: ${pct}%`;
    }, error => {
      console.error('Upload error', error);
      setCreateStatus('Upload failed: ' + (error.message || error), true);
      uploadProgress.textContent = '';
      // clean up DB node if needed
      dbCompat.ref(`shorts/${shortId}`).remove().catch(()=>{});
    }, async () => {
      // completed
      try{
        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
        const mediaType = file.type.startsWith('video/') ? 'video' : 'image';
        const payload = {
          user,
          title,
          description: desc || '',
          mediaURL: downloadURL,
          mediaType,
          storagePath,
          timestamp: Date.now()
        };
        await newRef.set(payload); // write metadata only
        setCreateStatus('Posted successfully!');
        uploadProgress.textContent = 'Upload complete';
        shortTitleInput.value = ''; shortDescInput.value = ''; shortMediaInput.value = '';
        // refresh view if open
        loadShorts(true);
        setTimeout(()=> { setCreateStatus(''); uploadProgress.textContent = ''; }, 1800);
      }catch(err){
        console.error('Failed to finalize post', err);
        setCreateStatus('Failed to finalize post: ' + (err.message || err), true);
        uploadProgress.textContent = '';
      }
    });
  }catch(err){
    console.error(err);
    setCreateStatus('Error: ' + (err.message || err), true);
    uploadProgress.textContent = '';
  }
});

// LOAD & RENDER (reads mediaURL)
let shortsCache = {};
let shortsListener = null;
function loadShorts(force){
  if(shortsListener && typeof shortsListener.off === 'function'){
    try{ shortsListener.off(); }catch(e){}
  }
  shortsListener = dbCompat.ref('shorts');
  shortsListener.on('value', snap => {
    const raw = snap.exists() ? snap.val() : {};
    const arr = Object.entries(raw).map(([id,v]) => ({ id, ...(v||{}) }));
    shortsCache = raw;
    renderShorts(arr);
  });
}

function renderShorts(items){
  items.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
  if(items.length === 0){ shortsListEl.innerHTML = '<div style="padding:12px;">No shorts yet — post the first!</div>'; return; }
  shortsListEl.innerHTML = '';
  items.forEach(item => {
    const wrap = document.createElement('div');
    wrap.className = 'short-item';

    if(!item.mediaURL){
      // skip invalid entries
      return;
    }

    let mediaEl;
    if(item.mediaType === 'video'){
      mediaEl = document.createElement('video');
      mediaEl.setAttribute('playsinline','');
      mediaEl.setAttribute('webkit-playsinline','');
      mediaEl.muted = true;
      mediaEl.controls = false;
      mediaEl.loop = false;
      mediaEl.className = 'short-media';
      mediaEl.src = item.mediaURL;
    } else {
      mediaEl = document.createElement('img');
      mediaEl.className = 'short-media';
      mediaEl.src = item.mediaURL;
      mediaEl.alt = item.title || '';
    }
    wrap.appendChild(mediaEl);

    // meta
    const meta = document.createElement('div'); meta.className = 'short-meta';
    const left = document.createElement('div'); left.style.flex='1';
    left.innerHTML = `<div style="font-weight:700">${_escapeHtml(item.user||'unknown')}</div>
                     <div style="font-weight:700">${_escapeHtml(item.title||'')}</div>
                     ${item.description?'<div style="font-size:0.9rem;opacity:0.9;">'+_escapeHtml(item.description)+'</div>':''}`;
    meta.appendChild(left);

    const right = document.createElement('div'); right.className='short-controls';
    // like button
    const likeBtn = document.createElement('button');
    const likesObj = item.likes || {};
    const likeCount = Object.keys(likesObj||{}).length;
    likeBtn.innerHTML = `❤️ <span class="like-count">${likeCount}</span>`;
    likeBtn.title = 'Like';
    const logged = (window.currentUser || _getLoggedUserFromStorage());
    if(logged && likesObj && likesObj[logged]) likeBtn.style.background = 'rgba(255,255,255,0.18)';
    likeBtn.addEventListener('click', async ()=>{
      const user = (window.currentUser || _getLoggedUserFromStorage());
      if(!user){ alert('Login to like.'); return; }
      const likeRef = dbCompat.ref(`shorts/${item.id}/likes/${user}`);
      try{
        const snap = await likeRef.get();
        if(!snap.exists()) {
          await likeRef.set(true);
        } else {
          await likeRef.remove();
        }
      }catch(err){ console.error(err); alert('Failed to toggle like'); }
    });
    right.appendChild(likeBtn);

    // comment button
    const commentBtn = document.createElement('button');
    commentBtn.textContent = '💬';
    commentBtn.title = 'Comments';
    commentBtn.addEventListener('click', ()=> openCommentsPanel(item, wrap));
    right.appendChild(commentBtn);

    // timestamp
    const timeSpan = document.createElement('div');
    timeSpan.style.fontSize='0.8rem';
    timeSpan.style.opacity='0.85';
    timeSpan.textContent = new Date(item.timestamp||Date.now()).toLocaleString();
    right.appendChild(timeSpan);

    meta.appendChild(right);
    wrap.appendChild(meta);

    // comments wrapper
    const commentsWrapper = document.createElement('div');
    commentsWrapper.className = 'comments-panel';
    commentsWrapper.style.display = 'none';
    wrap.appendChild(commentsWrapper);

    shortsListEl.appendChild(wrap);
  });

  // autoplay videos when in view
  const videos = shortsListEl.querySelectorAll('video');
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      const v = en.target;
      if(en.isIntersecting) { v.muted = true; v.play().catch(()=>{}); }
      else v.pause();
    });
  }, { threshold: 0.6 });
  videos.forEach(v => io.observe(v));
}

// comments panel UI + posting
async function openCommentsPanel(item, shortDiv){
  const commentsPanel = shortDiv.querySelector('.comments-panel');
  commentsPanel.innerHTML = ''; commentsPanel.style.display = 'block';
  const commentsRef = dbCompat.ref(`shorts/${item.id}/comments`);
  const snap = await commentsRef.get();
  const comments = snap.exists() ? snap.val() : {};
  const commentsArr = Object.entries(comments||{}).map(([id, v]) => ({ id, ...(v||{}) })).sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
  commentsArr.forEach(c => {
    const cd = document.createElement('div'); cd.className='comment-item';
    cd.innerHTML = `<strong>${_escapeHtml(c.user||'unknown')}</strong> <div style="display:inline;margin-left:6px">${_escapeHtml(c.text||'')}</div>
                     <div style="font-size:0.8rem;opacity:0.7">${new Date(c.timestamp||Date.now()).toLocaleString()}</div>`;
    commentsPanel.appendChild(cd);
  });
  // input
  const form = document.createElement('div'); form.style.display='flex'; form.style.gap='8px'; form.style.marginTop='8px';
  const input = document.createElement('input'); input.placeholder = 'Write a comment...'; input.style.flex='1';
  const send = document.createElement('button'); send.textContent = 'Send'; send.className='dock-btn'; send.style.flex='0 0 100px';
  send.addEventListener('click', async ()=>{
    const user = (window.currentUser || _getLoggedUserFromStorage());
    if(!user){ alert('Login to comment.'); return; }
    const text = (input.value||'').trim();
    if(!text) return;
    const newRef = dbCompat.ref(`shorts/${item.id}/comments`).push();
    try{
      await newRef.set({ user, text, timestamp: Date.now() });
      input.value = '';
      openCommentsPanel(item, shortDiv);
    }catch(err){ console.error(err); alert('Failed to post comment'); }
  });
  form.appendChild(input); form.appendChild(send);
  commentsPanel.appendChild(form);
}
</script>

</body>
</html>
