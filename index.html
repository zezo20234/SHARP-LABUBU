<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Login, Report, Shop & Credits Sender with Dynamic Island + Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b4c7e">
<link rel="apple-touch-icon" href="LABUBU3.jpg">

<style>
  .pointcoin {
  width: 50px;   /* adjust size */
  height: 50px;
  vertical-align: middle; /* aligns with text if inline */
}

  /* local time + welcome styling */
.island-time .label,
.island-welcome .label { font-size:0.75rem; opacity:0.9; color: var(--island-text); margin-right:6px; }
.island-time .value,
.island-welcome .value { font-weight:700; font-size:1rem; color: var(--island-text); min-width:70px; text-align:right; }

#islandWelcome { transition: opacity 220ms ease, transform 220ms cubic-bezier(.2,.9,.3,1); }
#islandWelcome.hidden { opacity: 0; transform: translateY(-6px); pointer-events: none; }

:root{
  --island-bg: #000;
  --island-text: #fff;
  --island-radius: 28px;
  --island-padding: 10px 14px;
}
body {
  font-family: Arial, sans-serif;
  max-width: 700px;
  margin: 30px auto;
  padding: 10px;
  background: linear-gradient(135deg, #f0f4f9, #d9e4f5);
  color: #333;
  font-size: 1rem;
  line-height: 1.4;
}
@media (max-width: 700px) {
  body { max-width: 100%; margin: 10px; padding: 10px 15px; }
}

h2, h3 { color: #2b4c7e; margin-bottom: 10px; }

button, input, select { width: 100%; max-width: 100%; padding: 12px; margin-top: 6px; font-size: 1.1rem; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; touch-action: manipulation; }
button { background: #2b4c7e; color: white; cursor: pointer; user-select: none; }
button:hover { background: #1f3557; }

img[src$="EGP.png"], .coin-icon, .island-icon {
  width: 25px !important;
  height: 25px !important;
  vertical-align: middle;
}
.coin-icon { display: inline-block; }

/* --- Dynamic Island (top middle) --- */
#dynamic-island {
  position: fixed;
  left: 50%;
  top: 8px;
  transform: translateX(-50%);
  z-index: 99999;
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--island-bg);
  color: var(--island-text);
  padding: var(--island-padding);
  border-radius: var(--island-radius);
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  min-width: 180px;
  max-width: 92vw;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  cursor: pointer;
  user-select: none;
  transition: width 260ms cubic-bezier(.2,.9,.3,1), border-radius 200ms ease, background 180ms ease;
}

#notifyDot { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius:50%; background: transparent; box-shadow: 0 0 6px rgba(0,0,0,0.3); pointer-events: none; }
#notifyDot.active { background: red; box-shadow: 0 0 10px rgba(255,0,0,0.9); animation: notify-blink 1.6s infinite; }
@keyframes notify-blink { 0% { opacity: 1; } 50% { opacity: 0.35; } 100% { opacity: 1; } }

.island-display { display:flex; align-items:center; gap:8px; min-width:160px; }
.island-metric { display:flex; align-items:center; gap:8px; white-space:nowrap; }
.island-metric .label { font-size:0.75rem; opacity:0.9; color: var(--island-text); }
.island-metric .value { font-weight:700; font-size:1rem; color: var(--island-text); }
.island-icon { display:inline-block; vertical-align:middle; }

#islandMenuBtn { background: rgba(255,255,255,0.06); color: inherit; border: none; border-radius: 10px; padding: 6px 8px; cursor:pointer; }
#islandMenuBtn:active { transform: scale(0.98); }

#islandMenu {
  position: fixed;
  z-index: 99998;
  background: var(--island-bg);
  color: var(--island-text);
  border-radius: 18px;
  box-shadow: 0 14px 40px rgba(0,0,0,0.3);
  transform-origin: top center;
  overflow: hidden;
  transition: transform 220ms ease, opacity 200ms ease, height 250ms ease, top 200ms ease, left 200ms ease;
  opacity: 0;
  transform: scaleY(0.95);
  pointer-events: none;
}
#islandMenu.open { opacity: 1; transform: scaleY(1); pointer-events: auto; }
#islandMenu .menu-inner { padding: 12px; display: flex; flex-direction: column; gap: 10px; }

.menu-actions { display:flex; gap:8px; }
.menu-actions button {
  flex:1;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--island-text);
  padding: 10px;
  border-radius: 10px;
  font-weight: 700;
}
.menu-actions button.active { outline: 2px solid rgba(255,255,255,0.15); }

.menu-panel { display:none; background: transparent; color: var(--island-text); }
.menu-panel.show { display:block; }

.menu-panel .panel-inner {
  margin-top: 8px;
  background: rgba(255,255,255,0.02);
  padding: 10px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.2);
}
.menu-panel label { color: var(--island-text); font-weight:600; display:block; margin-bottom:6px; }
.menu-panel input, .menu-panel select { background: rgba(255,255,255,0.03); color: var(--island-text); border: 1px solid rgba(255,255,255,0.06); }
.menu-panel button { background: rgba(255,255,255,0.06); color: var(--island-text); border:1px solid rgba(255,255,255,0.06); }

.notification-item { padding: 8px; border-radius:8px; margin-bottom:8px; background: rgba(255,255,255,0.03); border:1px solid rgba(0,0,0,0.06); cursor:pointer; }
.notification-item.unread { border-left: 4px solid #ff4b4b; }
.notification-meta { font-size:0.85rem; opacity:0.85; margin-top:6px; }
.notification-actions { display:flex; gap:8px; margin-top:8px; }
.notification-actions button { flex:0 0 auto; padding:8px 10px; }

#islandMenu .menu-inner { max-height: 70vh; overflow:auto; }

#login-form, #report-form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
label { font-weight: bold; margin-top: 15px; display: block; }
.rules-list { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #fafafa; }
.rule-item { padding: 8px; border-radius: 5px; cursor: pointer; transition: background 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
.rule-item:hover { background: #e6f0ff; }
.rule-item.selected { background: #2b4c7e; color: white; }
.rule-details { font-size: 0.9rem; color: inherit; margin-top: 4px; flex-basis: 100%; }
.rule-qty { width: 50px; margin-left: 10px; font-size: 1rem; }

#eventsSection { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
.event-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; background: #f9f9f9; }

@media (max-width: 420px) {
  .menu-actions { flex-wrap: wrap; }
  .menu-actions button { font-size: 0.9rem; padding: 8px; }
  #dynamic-island { padding: 8px 10px; }
}
</style>
</head>
<body>

<div id="welcomeOverlay" style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100000;">
  <div id="welcomeText" style="color:white; font-weight:700; font-size:1.2rem;"></div>
  <small style="color:white; display:block; margin-top:8px;">Click to continue</small>
</div>
<audio id="welcomeAudio" src="header-39344.mp3"></audio>

<div id="dynamic-island" role="region" aria-label="User status island" title="Tap to open">
  <div class="island-display" id="islandDisplay">
  
    <div id="islandTime" class="island-metric island-time" aria-hidden="false">
  <span class="label">Local time</span>
  <span class="value" id="islandLocalTime">--:--:--</span>
</div>
    <div class="island-metric" data-type="days">
      <span class="label">Days</span>
      <span class="value" id="days-count">0</span>
    </div>
    <div class="island-metric" data-type="credits">
      <span class="label"><img src="EGP.png" alt="coin" class="island-icon coin-icon"></span>
      <span class="value" id="credits-count">0</span>
    </div>
    <div class="island-metric" data-type="points">
      <span class="label"><img src="POINTS.png" alt="POINTS" class="pointcoin"></span>
      <span class="value" id="points-count">0</span>
    </div>
    <div class="island-metric" data-type="sig">
      <span class="label">Signature</span>
      <span class="value" id="sig-days-left">0</span>
    </div>
  </div>
  <button id="islandMenuBtn" aria-hidden="true">≡</button>
  <span id="notifyDot" aria-hidden="true"></span>
</div>

<div id="islandMenu" aria-hidden="true" role="dialog" aria-label="Island menu">
  <div class="menu-inner">
    <div class="menu-actions" role="tablist" aria-label="Island actions">
      <button id="menuLogoutBtn">Logout</button>
      <button id="menuShopBtn">Shop</button>
      <button id="menuSendCreditsBtn">Send <img src="EGP.png" alt="coin" class="coin-icon"></button>
      <button id="menuExchangeBtn">Exchange</button>
      <button id="menuSendPointsBtn">Send <img src="POINTS.png" alt="POINTS" class="pointcoin"></button>
      <button id="menuCustomizeBtn">Customize</button>
      <button id="menuNotificationsBtn">Notifications</button>
      <button id="menuSendNotificationBtn">Send Notification</button>
      <!-- SCAN BUTTON ADDED -->
      <button id="menuScanBtn">Scan</button>
    </div>

    <div id="panelShop" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Days Shop (Spend <img src="EGP.png" alt="coin" class="coin-icon"> to remove days)</h4>
        <div id="shopItems"></div>
      </div>
    </div>

    <div id="panelSendCredits" class="menu-panel">
      <div class="panel-inner">
        <label>Send to:</label>
        <select id="sendToUser"></select>
        <label>Amount:</label>
        <input type="number" id="sendAmount" min="1" />
        <button id="sendBtn">Send <img src="EGP.png" alt="coin" class="coin-icon"></button>
      </div>
    </div>

    <div id="panelExchange" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;"><img src="POINTS.png" alt="POINTS" class="pointcoin">
 Exchange</h4>
        <div id="pointsExchangeItems"></div>
      </div>
    </div>

    <div id="panelSendPoints" class="menu-panel">
      <div class="panel-inner">
        <label>Send <img src="POINTS.png" alt="POINTS" class="pointcoin"> to:</label>
        <select id="sendPointsToUser"></select>
        <label><img src="POINTS.png" alt="POINTS" class="pointcoin"> amount:</label>
        <input type="number" id="sendPointsAmount" min="1" />
        <button id="sendPointsBtn">Send <img src="POINTS.png" alt="POINTS" class="pointcoin"></button>
      </div>
    </div>

    <div id="panelNotifications" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Your Notifications</h4>
        <div id="notificationsList">No notifications.</div>
      </div>
    </div>

    <div id="panelSendNotification" class="menu-panel">
      <div class="panel-inner">
        <h4 style="margin:0 0 8px 0;">Send Notification</h4>
        <label>To:</label>
        <select id="notifyToUser"><option disabled selected>Select user</option></select>
        <label>Title</label>
        <input id="notifyTitle" placeholder="Short title" />
        <label>Description</label>
        <input id="notifyDescription" placeholder="Longer description" />
        <button id="sendNotificationBtn">Send Notification</button>
      </div>
    </div>

    <div id="panelCustomize" class="menu-panel">
      <div class="panel-inner" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-weight:700;">Choose island color</div>
        <div class="palette" id="colorPalette" style="display:flex; gap:8px; flex-wrap:wrap;">
          <div class="sw" data-color="black" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#000,#000);cursor:pointer;"></div>
          <div class="sw" data-color="red" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff4b4b,#c0392b);cursor:pointer;"></div>
          <div class="sw" data-color="orange" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff8a00,#ff5e00);cursor:pointer;"></div>
          <div class="sw" data-color="yellow" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ffd54a,#ffb300);cursor:pointer;"></div>
          <div class="sw" data-color="purple" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#9b59b6,#6a2a89);cursor:pointer;"></div>
          <div class="sw" data-color="pink" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#ff7eb6,#ff4d94);cursor:pointer;"></div>
          <div class="sw" data-color="green" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#2ecc71,#27ae60);cursor:pointer;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="login-form">
<h2>Login</h2>
<input type="text" id="username" placeholder="Username" />
<input type="password" id="password" placeholder="Password" />
<label><input type="checkbox" id="keepSignedIn"> Keep me signed in</label>
<button id="loginBtn">Login</button>
</div>

<div id="report-form" style="display:none;">
<h2>Report Form</h2>
<form id="reportForm">
<label>Your Username</label>
<input type="text" id="reporter" readonly />
<label>Who is this report on?</label>
<select id="reportedUser" required ></select>
<label>Rules broken:</label>
<div class="rules-list" id="rulesList"></div>
<div id="total-days">Total Days Penalty: 0</div>
<button type="submit" style="margin-top:20px;">Submit Report</button>
</form>
</div>

<hr>
<div id="eventsSection">
<h2>Events</h2>
<div id="eventsList">Loading events...</div>
</div>

<audio id="saveSignatureAudio" src="welcome.mp3" preload="auto"></audio>
<audio id="applePayAudio" src="applepay.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
  authDomain: "sharplabubu.firebaseapp.com",
  databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
  projectId: "sharplabubu",
  storageBucket: "sharplabubu.firebasestorage.app",
  messagingSenderId: "596148393481",
  appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
  measurementId: "G-4M25R3BF08"
};

let app;
try { app = getApp(); } catch (e) { app = initializeApp(firebaseConfig); }
const db = getDatabase(app);

// === GLOBALS ===
let currentUser = null, currentUserData = null;
const daysSpan = document.getElementById("days-count");
const creditsSpan = document.getElementById("credits-count");
const pointsSpan = document.getElementById("points-count");
const sigDaysLeftSpan = document.getElementById("sig-days-left");
const reportedUserSelect = document.getElementById("reportedUser");
const sendToUserSelect = document.getElementById("sendToUser");
const sendPointsToUserSelect = document.getElementById("sendPointsToUser");
const notifyToUserSelect = document.getElementById("notifyToUser");
const reporterInput = document.getElementById("reporter");
const welcomeOverlay = document.getElementById("welcomeOverlay");
const welcomeText = document.getElementById("welcomeText");
const welcomeAudio = document.getElementById("welcomeAudio");
const notifyDot = document.getElementById('notifyDot');

// ------------------- island clock + one-time welcome -------------------
const islandLocalTimeEl = document.getElementById('islandLocalTime');
const islandWelcomeEl = document.getElementById('islandWelcome');
const islandUserNameEl = document.getElementById('islandUserName');

let _islandClockInterval = null;

function startIslandClock() {
  function render() {
    const now = new Date();
    islandLocalTimeEl.textContent = now.toLocaleTimeString();
  }
  render();
  if (_islandClockInterval) clearInterval(_islandClockInterval);
  _islandClockInterval = setInterval(render, 1000);
}
function stopIslandClock() { if (_islandClockInterval) { clearInterval(_islandClockInterval); _islandClockInterval = null; } }

function showWelcomeOnce(name, durationMs = 6000) {
  if (!name) return;
  islandUserNameEl.textContent = name;
  islandWelcomeEl.hidden = false;
  islandWelcomeEl.classList.remove('hidden');
  setTimeout(() => {
    islandWelcomeEl.classList.add('hidden');
    setTimeout(() => islandWelcomeEl.hidden = true, 240);
  }, durationMs);
}

startIslandClock();

// === DATA ARRAYS ===
const rules = [
  { id: 'no_hit', title: 'No hit', days: 1, points: 12.5, details: 'Do not physically hurt anyone, as a joke is ok +1 days.' },
  { id: 'no_scream', title: 'No scream', days: 5, points: 12.5, details: 'Speak calmly, only when you are excited or angry +5 days.' },
  { id: 'no_cry', title: 'No cry', days: 1, points: 12.5, details: 'Crying is not allowed +1 days.' },
  { id: 'zeyad_devices', title: 'Zeyad can no longer make you play with devices when you have days.', days: 20, points: 15, details: 'If Zeyad makes you play with devices when you have days, +20 days to Zeyad!' },
  { id: 'no_fetn', title: 'No fetn', days: 25, points: 15, details: "Don't make FETN. If someone tells you “blip” please don’t tell or repeat it to anyone. +25 days." },
  { id: 'no_bother', title: 'No bother', days: 5, points: 12.5, details: 'Respect others. Don’t annoy them. +5 days.' },
  { id: 'respect', title: 'You have to respect', days: 10, points: 12.5, details: 'Treat everyone kindly and with respect, always. +10 days.' },
  { id: 'no_listen', title: 'No listen', days: 25, points: 15, details: 'You have to listen! If not, +25 days.' },
  { id: 'play_zezo', title: 'Play with Zezo', days: 25, points: 15, details: 'You must play with Zezo. If not, +25 days.' },
  { id: 'no_sad', title: 'No sad', days: 10, points: 12.5, details: 'Don’t be sad or +10 days.' },
  { id: 'no_devices', title: 'No devices when u have days = 5 days', days: 5, points: 12.5, details: 'When you have days, don’t use devices. Each minute = +5 days!' },
  { id: 'no_copy', title: 'No copy', days: 10, points: 15, details: 'You need proof (note, message) that someone gave you permission to copy them.' },
  { id: 'no_angry', title: 'No angry', days: 5, points: 12.5, details: 'Don’t be mad +5 days.' },
  { id: 'no_askzezo', title: 'dont asks zezo', days: 15, points: 12.5, details: 'Don’t ask zezo about any events or discord all instructions are put +15 days.' },
  { id: 'dont_ask_zeyad', title: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS', days: 25, points: 15, details: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS +50 DAYS' },
  { id: 'no_lie', title: 'No lie', days: 25, points: 15, details: 'Do not lie, always tell the truth. +25 days.' },
  { id: 'no_pause', title: 'No pause', days: 10, points: 12.5, details: 'No pauses. +10 days.' },
  { id: 'no_funny', title: 'No funny', days: -1, points: 1, details: 'No funny' },
  { id: 'no_shetema', title: 'No shetema', days: 10, points: 12.5, details: 'No shetema. +10 days.' },
  { id: 'no_pullhair', title: 'No pull hair', days: 10, points: 12.5, details: 'No pull hair. +10 days.' },
  { id: 'no_pinch', title: 'No pinch', days: 15, points: 12.5, details: 'No pinch. +15 days.' },
  { id: 'no_push', title: 'No push', days: 10, points: 12.5, details: 'No push. +10 days.' },
  { id: 'no_scare', title: 'No scare', days: 10, points: 12.5, details: 'No scare. +10 days.' },
  { id: 'no_dumb', title: 'No dumb', days: 15, points: 15, details: 'No dumb. +15 days.' },
  { id: 'no_discord', title: 'no discord', days: 25, points: 12.5, details: 'if you dont see discord labubu messgaes +25 days.' },
  { id: 'no_3ADY', title: 'No 3ADY', days: 25, points: 15, details: 'No 3ADY or he can reort on you 3ADY. +25 days.' }
];

const shopItems = [{cost:100,days:1},{cost:450,days:5},{cost:1450,days:15},{cost:2450,days:25},{cost:3450,days:35},{cost:4450,days:45},{cost:5450,days:55},{cost:6450,days:65},{cost:7450,days:75},{cost:8950,days:85,points:60},{cost:10450,days:100,points:75}];

const pointsExchangeItems = [{points:100,credits:500},{points:300,credits:2000},{points:500,credits:5500},{points:1000,credits:12000},{points:2000,credits:24000},{points:3000,credits:37000},{points:4000,credits:50000}];

function renderRules() {
  const container = document.getElementById('rulesList');
  container.innerHTML = '';
  rules.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'rule-item';
    div.dataset.id = r.id; div.dataset.days = r.days; div.dataset.points = r.points;
    const textContainer = document.createElement('div'); textContainer.style.flex = '1'; textContainer.innerHTML = `<strong>${r.title}</strong><div class="rule-details">${r.details}</div>`;
    const qtyInput = document.createElement('input'); qtyInput.type='number'; qtyInput.min=0; qtyInput.value=0; qtyInput.className='rule-qty'; qtyInput.addEventListener('input', updateTotalDays);
    div.appendChild(textContainer); div.appendChild(qtyInput);
    div.addEventListener('click',(e)=>{ if(e.target.tagName.toLowerCase() !== 'input'){ div.classList.toggle('selected'); if(div.classList.contains('selected') && qtyInput.value==0) qtyInput.value = 1; else if(!div.classList.contains('selected')) qtyInput.value = 0; updateTotalDays(); } });
    container.appendChild(div);
    if(i < rules.length -1){ const hr = document.createElement('hr'); hr.style.margin='5px 0'; container.appendChild(hr); }
  });
}
renderRules();

function updateTotalDays(){ let total = 0; document.querySelectorAll('.rule-item').forEach(item=>{ const qty = parseInt(item.querySelector('input').value)||0; const daysPer = parseInt(item.dataset.days); total += daysPer * qty; }); document.getElementById('total-days').textContent = `Total Days Penalty: ${total}`; }

async function loadUsersDropdowns(){
  const snap = await get(ref(db, "users"));
  if(snap.exists()){
    reportedUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    sendToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    sendPointsToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    notifyToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
    Object.keys(snap.val()).forEach(user=>{
      reportedUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
      if(user !== currentUser) {
        sendToUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
        sendPointsToUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
        notifyToUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
      }
    });
  }
}

async function login(username, password, keep, isAutoLogin = false){
  const userRef = ref(db, `users/${username}`);
  const snap = await get(userRef);
  if(!snap.exists()) return alert("User not found");
  const data = snap.val();
  if(data.password !== password) return alert("Incorrect password");

  currentUser = username; currentUserData = data;

  const signature = data.signature || null; const expiry = signature?.expiry || 0;
  if(!signature || expiry <= Date.now()){
    await update(userRef, { days: 0, credits: 0, points: 0, signature: null, lastLogin: Date.now() });
    alert("Your signature expired or not found. You need to create a new signature now.");
    window.location.href = "signature.html?user=" + encodeURIComponent(username);
    return;
  }

  const now = new Date(); const lastLogin = data.lastLogin || 0;
  function getMidnight(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  const nowMidnight = getMidnight(now); const lastLoginMidnight = getMidnight(new Date(lastLogin));
  const msPerDay = 1000*60*60*24; let daysPassed = 0;
  if(lastLogin) daysPassed = Math.floor((nowMidnight - lastLoginMidnight) / msPerDay);
  let updatedDays = (data.days || 0) - daysPassed; if(updatedDays < 0) updatedDays = 0;
  const msLeft = expiry - Date.now(); const sigDaysLeft = Math.ceil(msLeft / msPerDay); const displayDaysLeft = sigDaysLeft > 0 ? sigDaysLeft : 0;

  await update(userRef, { days: updatedDays, lastLogin: Date.now() });
  currentUserData.days = updatedDays; currentUserData.lastLogin = Date.now();

  if(!isAutoLogin){
    welcomeText.textContent = `Welcome back, ${username}!`;
    welcomeOverlay.style.display = "flex";
    await new Promise(resolve=>{ function onClick(){ welcomeOverlay.removeEventListener('click', onClick); welcomeAudio.play(); welcomeOverlay.style.transition = 'opacity 0.7s ease'; welcomeOverlay.style.opacity = 0; setTimeout(()=>{ welcomeOverlay.style.display = 'none'; welcomeOverlay.style.opacity = 1; resolve(); },700); } welcomeOverlay.addEventListener('click', onClick); });
  }

  document.getElementById("login-form").style.display = "none";
  document.getElementById("report-form").style.display = "block";
  reporterInput.value = username;
  daysSpan.textContent = updatedDays;
  creditsSpan.textContent = data.credits || 0;
  pointsSpan.textContent = data.points || 0;
  sigDaysLeftSpan.textContent = displayDaysLeft;

  await loadUsersDropdowns();

  listenToNotifications();
}

function logout(){ currentUser = null; currentUserData = null; localStorage.removeItem('loginData'); sessionStorage.removeItem('loginData'); document.getElementById('login-form').style.display='block'; document.getElementById('report-form').style.display='none'; closeIslandMenu(); updateNotifyDot(0); }

function renderShopItems(){
  const shopContainer = document.getElementById('shopItems');
  shopContainer.innerHTML = '';
  shopItems.forEach(item=>{
    shopContainer.innerHTML += `<button onclick="buyItem(${item.cost}, ${item.days})">Buy: ${item.cost} <img src="EGP.png" class="coin-icon" alt="coin"> → Remove ${item.days} days</button><br>`;
  });
}
renderShopItems();

function renderPointsExchangeItems(){
  const exchangeContainer = document.getElementById('pointsExchangeItems');
  exchangeContainer.innerHTML = '';
  pointsExchangeItems.forEach(item=>{
    exchangeContainer.innerHTML += `<button onclick="exchangePoints(${item.points}, ${item.credits})">Exchange ${item.points} Points → ${item.credits} <img src="EGP.png" class="coin-icon" alt="coin"></button><br>`;
  });
}
renderPointsExchangeItems();

const islandEl = document.getElementById('dynamic-island');
const islandMenu = document.getElementById('islandMenu');

function positionIslandMenu(){
  const rect = islandEl.getBoundingClientRect();
  let maxAllowed = Math.min(window.innerWidth - 20, 520);
  if(window.innerWidth <= 420) maxAllowed = Math.min(window.innerWidth - 20, 380);
  const menuWidth = Math.max(Math.min(maxAllowed, 520), 320);
  const left = Math.round((window.innerWidth - menuWidth) / 2);
  const top = Math.round(rect.bottom + 8);

  islandMenu.style.left = `${left}px`;
  islandMenu.style.top = `${top}px`;
  islandMenu.style.width = `${menuWidth}px`;

  islandMenu.style.borderTopLeftRadius = `20px`;
  islandMenu.style.borderTopRightRadius = `20px`;
  islandMenu.style.borderBottomLeftRadius = `22px`;
  islandMenu.style.borderBottomRightRadius = `22px`;

  return menuWidth;
}

let islandOpen = false;
function openIslandMenu(){
  const rect = islandEl.getBoundingClientRect();
  const closedWidth = rect.width;
  islandEl.dataset.closedWidth = closedWidth;

  const menuWidth = positionIslandMenu();

  islandEl.style.width = `${menuWidth}px`;
  islandEl.style.borderBottomLeftRadius = `14px`;
  islandEl.style.borderBottomRightRadius = `14px`;

  const bg = getComputedStyle(document.documentElement).getPropertyValue('--island-bg');
  islandEl.style.background = bg;
  islandMenu.style.background = bg;

  islandMenu.classList.add('open');
  islandMenu.setAttribute('aria-hidden', 'false');
  islandOpen = true;
  showMenuPanel('panelShop', 'menuShopBtn');
}

function closeIslandMenu(){
  islandMenu.classList.remove('open');
  islandMenu.setAttribute('aria-hidden', 'true');
  islandOpen = false;

  const closedWidth = islandEl.dataset.closedWidth || '';
  if(closedWidth){
    islandEl.style.width = `${closedWidth}px`;
    islandEl.style.borderBottomLeftRadius = '';
    islandEl.style.borderBottomRightRadius = '';
    const reset = () => { islandEl.style.width = ''; islandEl.removeEventListener('transitionend', reset); };
    islandEl.addEventListener('transitionend', reset);
    setTimeout(()=>{ if(islandEl.style.width !== ''){ islandEl.style.width = ''; } }, 400);
  }

  document.querySelectorAll('.menu-actions button').forEach(b => b.classList.remove('active'));
}

islandEl.addEventListener('click', (e)=>{
  if(islandOpen && islandMenu.contains(e.target)) return;
  if(!islandOpen) openIslandMenu(); else closeIslandMenu();
});

window.addEventListener('resize', ()=>{ if(islandOpen) positionIslandMenu(); });
window.addEventListener('scroll', ()=>{ if(islandOpen) positionIslandMenu(); });

document.addEventListener('click', (e)=>{
  if(!islandEl.contains(e.target) && !islandMenu.contains(e.target)) closeIslandMenu();
});

function showMenuPanel(panelId, buttonId){
  document.querySelectorAll('.menu-panel').forEach(p => p.classList.remove('show'));
  const panel = document.getElementById(panelId);
  if(panel) panel.classList.add('show');
  document.querySelectorAll('.menu-actions button').forEach(b => b.classList.remove('active'));
  if(buttonId) document.getElementById(buttonId).classList.add('active');
  positionIslandMenu();
}

document.getElementById('menuShopBtn').addEventListener('click', ()=> showMenuPanel('panelShop','menuShopBtn'));
document.getElementById('menuSendCreditsBtn').addEventListener('click', ()=> showMenuPanel('panelSendCredits','menuSendCreditsBtn'));
document.getElementById('menuExchangeBtn').addEventListener('click', ()=> showMenuPanel('panelExchange','menuExchangeBtn'));
document.getElementById('menuSendPointsBtn').addEventListener('click', ()=> showMenuPanel('panelSendPoints','menuSendPointsBtn'));
document.getElementById('menuCustomizeBtn').addEventListener('click', ()=> showMenuPanel('panelCustomize','menuCustomizeBtn'));
document.getElementById('menuNotificationsBtn').addEventListener('click', ()=> showMenuPanel('panelNotifications','menuNotificationsBtn'));
document.getElementById('menuSendNotificationBtn').addEventListener('click', ()=> showMenuPanel('panelSendNotification','menuSendNotificationBtn'));

const colorPalette = document.getElementById('colorPalette');
colorPalette.querySelectorAll('.sw').forEach(sw=>{
  sw.addEventListener('click', ()=>{
    const c = sw.dataset.color;
    applyIslandColor(c);
    localStorage.setItem('islandColor', c);
  });
});

function applyIslandColor(name){
  let css = '';
  switch(name){
    case 'black': css = '#000'; break;
    case 'red': css = 'linear-gradient(90deg,#ff4b4b,#c0392b)'; break;
    case 'orange': css = 'linear-gradient(90deg,#ff8a00,#ff5e00)'; break;
    case 'yellow': css = 'linear-gradient(90deg,#ffd54a,#ffb300)'; break;
    case 'purple': css = 'linear-gradient(90deg,#9b59b6,#6a2a89)'; break;
    case 'pink': css = 'linear-gradient(90deg,#ff7eb6,#ff4d94)'; break;
    case 'green': css = 'linear-gradient(90deg,#2ecc71,#27ae60)'; break;
    default: css = '#000';
  }
  document.documentElement.style.setProperty('--island-bg', css);
  islandEl.style.background = css;
  islandMenu.style.background = css;
}
const savedColor = localStorage.getItem('islandColor'); if(savedColor) applyIslandColor(savedColor);

function hideAllPanels(){ document.querySelectorAll('.menu-panel').forEach(el => el.classList.remove('show')); }
window.togglePanel = (id) => { const el = document.getElementById(id); if(!el) return; el.classList.toggle('show'); }

async function buyItem(cost, daysToRemove){ if(!currentUser) return alert('Please login first.'); if((currentUserData.credits||0) < cost) return alert('Not enough credits.'); if((currentUserData.days||0) < daysToRemove) return alert(`You don't have enough days to remove (${daysToRemove} required).`);
  try{ const applePayAudio = document.getElementById('applePayAudio'); try{ await applePayAudio.play(); }catch(e){}
    const bankAmount = Math.floor(cost * 0.90); const zezoAmount = cost - bankAmount;
    const userRef = ref(db, `users/${currentUser}`); const bankRef = ref(db, `users/bank`); const zezoRef = ref(db, `users/zezo`);
    const [bankSnap,zezoSnap] = await Promise.all([ get(bankRef), get(zezoRef) ]);
    const bankData = bankSnap.exists()?bankSnap.val():{credits:0}; const zezoData = zezoSnap.exists()?zezoSnap.val():{credits:0};
    const updates = {};
    updates[`users/${currentUser}/credits`] = (currentUserData.credits||0) - cost;
    updates[`users/${currentUser}/days`] = (currentUserData.days||0) - daysToRemove;
    updates[`users/bank/credits`] = (bankData.credits||0) + bankAmount;
    updates[`users/zezo/credits`] = (zezoData.credits||0) + zezoAmount;
    await update(ref(db), updates);
    currentUserData.credits -= cost; currentUserData.days -= daysToRemove; creditsSpan.textContent = currentUserData.credits; daysSpan.textContent = currentUserData.days;
    alert(`Bought item for ${cost} credits. Removed ${daysToRemove} days. 90% went to Bank and remainder to Zezo.`);
  }catch(err){ console.error(err); alert('Failed to complete purchase: '+err.message); }
}
window.buyItem = buyItem;

async function exchangePoints(pointsToExchange, creditsToReceive){ if(!currentUser) return alert('Please login first.'); if((currentUserData.points||0) < pointsToExchange) return alert('Not enough points to make this exchange.');
  const newPoints = (currentUserData.points||0) - pointsToExchange; const newCredits = (currentUserData.credits||0) + creditsToReceive;
  try{ const userRef = ref(db, `users/${currentUser}`); await update(userRef, { points: newPoints, credits: newCredits }); currentUserData.points = newPoints; currentUserData.credits = newCredits; pointsSpan.textContent = currentUserData.points; creditsSpan.textContent = currentUserData.credits; alert(`Exchanged ${pointsToExchange} points for ${creditsToReceive} credits!`); }catch(err){ console.error(err); alert('Failed to complete exchange.'); }
}
window.exchangePoints = exchangePoints;

async function sendCredits(){ if(!currentUser) return alert('Please login first.'); const toUser = sendToUserSelect.value; const amount = parseInt(document.getElementById('sendAmount').value); if(!toUser) return alert('Select a user to send credits to.'); if(!amount || amount<=0) return alert('Enter a valid amount.'); if((currentUserData.credits||0) < amount) return alert('Not enough credits.');
  const senderRef = ref(db, `users/${currentUser}`); const receiverRef = ref(db, `users/${toUser}`);
  try{ const receiverSnap = await get(receiverRef); if(!receiverSnap.exists()) return alert('Receiver user not found.'); const receiverCredits = receiverSnap.val().credits||0; const updates = {};
    updates[`users/${currentUser}/credits`] = (currentUserData.credits||0) - amount;
    updates[`users/${toUser}/credits`] = receiverCredits + amount;
    await update(ref(db), updates);
    currentUserData.credits -= amount; creditsSpan.textContent = currentUserData.credits; alert(`Sent ${amount} credits to ${toUser}.`);
  }catch(err){ console.error(err); alert('Failed to send credits.'); }
}
window.sendCredits = sendCredits;

async function sendPoints(){ if(!currentUser) return alert('Please login first.'); const toUser = sendPointsToUserSelect.value; const amount = parseInt(document.getElementById('sendPointsAmount').value); if(!toUser) return alert('Select a user to send points to.'); if(!amount || amount<=0) return alert('Enter a valid amount.'); if((currentUserData.points||0) < amount) return alert('Not enough points.');
  const senderRef = ref(db, `users/${currentUser}`); const receiverRef = ref(db, `users/${toUser}`);
  try{
    const receiverSnap = await get(receiverRef); if(!receiverSnap.exists()) return alert('Receiver user not found.');
    const receiverPoints = receiverSnap.val().points||0;
    const updates = {};
    updates[`users/${currentUser}/points`] = (currentUserData.points||0) - amount;
    updates[`users/${toUser}/points`] = receiverPoints + amount;
    await update(ref(db), updates);
    currentUserData.points -= amount; pointsSpan.textContent = currentUserData.points; alert(`Sent ${amount} points to ${toUser}.`);
  }catch(err){ console.error(err); alert('Failed to send points.'); }
}
window.sendPoints = sendPoints;

async function sendNotification(){
  if(!currentUser) return alert('Please login first.');
  const to = notifyToUserSelect.value; const title = document.getElementById('notifyTitle').value.trim(); const description = document.getElementById('notifyDescription').value.trim();
  if(!to) return alert('Select a recipient'); if(!title) return alert('Enter a title');
  const nref = push(ref(db, 'notifications'));
  const notif = { from: currentUser, to, title, description, timestamp: Date.now(), read: false };
  try{ await update(nref, notif); document.getElementById('notifyTitle').value=''; document.getElementById('notifyDescription').value=''; alert('Notification sent'); }catch(err){ console.error(err); alert('Failed to send notification'); }
}

document.getElementById('sendNotificationBtn').addEventListener('click', sendNotification);

let notificationsCache = {};

function listenToNotifications(){
  const notificationsRef = ref(db, 'notifications');
  onValue(notificationsRef, (snap)=>{
    const all = snap.exists() ? snap.val() : {};
    const myNotifs = [];
    Object.entries(all).forEach(([id, n])=>{
      if(n && n.to === currentUser){ myNotifs.push({ id, ...n }); }
    });
    myNotifs.sort((a,b)=> b.timestamp - a.timestamp);
    notificationsCache = {};
    myNotifs.forEach(n => notificationsCache[n.id] = n);
    renderNotificationsList(myNotifs);
    const unread = myNotifs.filter(n=>!n.read).length;
    updateNotifyDot(unread);
  });
}

function updateNotifyDot(count){ if(count && count > 0){ notifyDot.classList.add('active'); } else { notifyDot.classList.remove('active'); } }

function formatWhen(ts){ const d = new Date(ts); return d.toLocaleString(); }

function renderNotificationsList(list){
  const container = document.getElementById('notificationsList');
  if(!list || list.length === 0){ container.innerHTML = 'No notifications.'; return; }
  container.innerHTML = '';
  list.forEach(n=>{
    const div = document.createElement('div');
    div.className = 'notification-item' + (n.read? '' : ' unread');
    div.dataset.id = n.id;
    div.innerHTML = `<strong>${escapeHtml(n.title)}</strong><div class="notification-meta">From: ${escapeHtml(n.from)} • ${formatWhen(n.timestamp)}</div>`;
    div.addEventListener('click', ()=> showNotificationDetails(n.id));
    container.appendChild(div);
  });
}

async function showNotificationDetails(id){
  const n = notificationsCache[id]; if(!n) return alert('Notification not found');
  const details = `From: ${n.from}\nTitle: ${n.title}\nWhen: ${formatWhen(n.timestamp)}\n\n${n.description || ''}`;
  alert(details);
  if(!n.read){ try{ const nr = ref(db, `notifications/${id}`); await update(nr, { read: true }); }catch(err){ console.error(err); } }
}

async function deleteNotification(id){ if(!confirm('Delete this notification?')) return; try{ await remove(ref(db, `notifications/${id}`)); alert('Deleted'); }catch(err){ console.error(err); alert('Failed to delete'); } }

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]; }); }

function formatCountdown(msLeft){ if(msLeft <= 0) return 'Expired'; const totalSeconds = Math.floor(msLeft/1000); const days = Math.floor(totalSeconds/(24*3600)); const hours = Math.floor((totalSeconds%(24*3600))/3600); const minutes = Math.floor((totalSeconds%3600)/60); const seconds = totalSeconds%60; let parts = []; if(days>0) parts.push(`${days}d`); if(hours>0||days>0) parts.push(`${hours}h`); if(minutes>0||hours>0||days>0) parts.push(`${minutes}m`); parts.push(`${seconds}s`); return parts.join(' '); }
const eventsRef = ref(db, 'events');
function renderEvents(events){ const eventsListEl = document.getElementById('eventsList'); eventsListEl.innerHTML = ''; const now = Date.now(); let hasEvents = false; Object.entries(events||{}).forEach(([eventId,ev])=>{
  if(!ev.endTime || now > ev.endTime){ remove(ref(db, `events/${eventId}`)); return; }
  hasEvents = true;
  const div = document.createElement('div'); div.className = 'event-item';
  const titleEl = document.createElement('h4'); titleEl.textContent = ev.title; div.appendChild(titleEl);
  const detailsEl = document.createElement('p'); detailsEl.textContent = ev.description; div.appendChild(detailsEl);
  const countdownEl = document.createElement('p'); countdownEl.className = 'countdown'; div.appendChild(countdownEl);
  function updateCountdown(){ const msLeft = ev.endTime - Date.now(); if(msLeft <= 0){ countdownEl.textContent = 'Time left: Expired'; remove(ref(db, `events/${eventId}`)); return; } countdownEl.textContent = `Time left: ${formatCountdown(msLeft)}`; }
  updateCountdown(); setInterval(updateCountdown,1000);
  eventsListEl.appendChild(div);
});
if(!hasEvents) eventsListEl.textContent = 'No active events at this time.'; }
onValue(eventsRef, (snapshot)=>{ renderEvents(snapshot.val()); });

document.getElementById('reportForm').onsubmit = async e => {
  e.preventDefault(); if(!currentUser) return alert('Please login first.'); const reportedUser = reportedUserSelect.value; if(!reportedUser) return alert('Please select the user you want to report.');
  const selectedRules = []; let totalDays = 0; let totalPoints = 0;
  document.querySelectorAll('.rule-item').forEach(item=>{ const qty = parseInt(item.querySelector('input').value)||0; if(qty>0){ const daysPer = parseInt(item.dataset.days); const pointsPer = parseInt(item.dataset.points); selectedRules.push({ id: item.dataset.id, title: item.querySelector('strong').textContent, qty, daysPerOffense: daysPer, pointsPerOffense: pointsPer }); totalDays += daysPer * qty; totalPoints += pointsPer * qty; } });
  if(selectedRules.length === 0) return alert('Please select at least one rule broken.');
  const report = { reporter: currentUser, reportedUser, rules: selectedRules, totalDays, totalPoints, timestamp: Date.now() };

  try{
    const autoAcceptSnap = await get(ref(db, 'settings/autoAcceptReports'));
    const autoAccept = autoAcceptSnap.exists() && autoAcceptSnap.val() === true;

    if(autoAccept){
      const reportedUserRef = ref(db, `users/${reportedUser}`);
      const reporterUserRef = ref(db, `users/${currentUser}`);
      const [reportedUserSnap, reporterUserSnap] = await Promise.all([ get(reportedUserRef), get(reporterUserRef) ]);
      const reportedUserData = reportedUserSnap.val(); const reporterUserData = reporterUserSnap.val();
      const newReportedDays = (Number(reportedUserData.days||0) + Number(totalDays));
      const newReporterPoints = (Number(reporterUserData.points||0) + Number(totalPoints));
      const updates = {};
      updates[`users/${reportedUser}/days`] = newReportedDays;
      updates[`users/${currentUser}/points`] = newReporterPoints;
      await update(ref(db), updates);
      currentUserData.points = newReporterPoints; pointsSpan.textContent = currentUserData.points;
      alert(`Report auto accepted: ${totalDays} days added to ${reportedUser}, and you received ${totalPoints} points.`);
    } else {
      const newReportRef = push(ref(db, 'reports'));
      await update(newReportRef, report);
      alert('Report submitted for manual approval. You will receive points upon approval.');
    }

    document.getElementById('reportForm').reset(); renderRules(); updateTotalDays();
  }catch(error){ console.error('Error submitting report:', error); alert('Failed to submit report: ' + error.message); }
}

const metrics = ['days','credits','points','sig'];
let metricIndex = 0;
const islandDisplay = document.getElementById('islandDisplay');
function showMetric(index){ 
  const items = islandDisplay.querySelectorAll('.island-metric');
  items.forEach(it=> it.style.display = 'none');
  const m = items[index % items.length]; if(m) m.style.display = 'flex';
}
showMetric(metricIndex);
setInterval(()=>{ metricIndex = (metricIndex + 1) % metrics.length; showMetric(metricIndex); }, 1500);

window.addEventListener('load', ()=>{
  let saved = localStorage.getItem('loginData') || sessionStorage.getItem('loginData');
  if(saved){ try{ const { username, password } = JSON.parse(saved); login(username, password, true, true); }catch(e){ console.error('Failed to parse saved login:', e); } }
});

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const keep = document.getElementById('keepSignedIn').checked;
  if(!u||!p) return alert('Enter username and password');
  if(keep) localStorage.setItem('loginData', JSON.stringify({ username: u, password: p })); else sessionStorage.setItem('loginData', JSON.stringify({ username: u, password: p }));
  await login(u,p,keep,false);
});

document.getElementById('sendBtn').addEventListener('click', ()=> sendCredits());
document.getElementById('sendPointsBtn').addEventListener('click', ()=> sendPoints());

window.logout = logout;

</script>
<script>
document.getElementById("reportForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const webhookURL = "https://discordapp.com/api/webhooks/1404606217346875483/XRsgBkh2jdg7NgOgH77wnmDB5sxtYwEHzMRMy-SDHeC1x-NX8n4y2pv1Y3mZvK92a9LL";
    const reporter = document.getElementById("reporter").value.trim();
    const reportedUser = document.getElementById("reportedUser").value.trim();
    const totalDaysText = document.getElementById("total-days").textContent;
    const totalDays = totalDaysText.match(/\d+/)[0] || "0";

    const brokenRules = [];
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        if (qty > 0) {
            const title = item.querySelector('strong').textContent;
            const daysPer = parseInt(item.dataset.days);
            brokenRules.push(`- ${title} (x${qty}) for ${qty * daysPer} days`);
        }
    });
    const rulesList = brokenRules.join('\n') || "No rules specified.";

    const mentionMap = {
        "layan": "<@1367185737446985738>",
        "zezo": "<@1388958062500647064>",
        "asser": "<@1367187821542117558>"
    };

    const mention = mentionMap[reportedUser.toLowerCase()] || "";

    const message = `📢 **New Report Submitted**\n`
                  + `**Reporter:** ${reporter}\n`
                  + `**Reported User:** ${reportedUser} ${mention}\n`
                  + `**Broken Rules:**\n${rulesList}\n`
                  + `**Total Days:** ${totalDays}`;

    fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: message })
    })
    .then(res => {
        if (res.ok) {
            alert("Report sent successfully!");
        } else {
            alert("Failed to send report.");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error sending report.");
    });
});
document.getElementById('menuLogoutBtn').addEventListener('click', () => {
  logout();
});
</script>
<style>
  @keyframes disco {
    0% {color: red;}
    16% {color: orange;}
    33% {color: yellow;}
    50% {color: green;}
    66% {color: blue;}
    83% {color: purple;}
    100% {color: red;}
  }
  .disco {
    animation: disco 2s infinite;
  }
  .gold {
    background: linear-gradient(90deg, #ffd700, #ffae00, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
  }
</style>

<div id="messageContainer" 
     style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
            display:flex;flex-direction:column;align-items:center;gap:10px;
            z-index:9999;max-width:80%;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const seen = new Set(JSON.parse(localStorage.getItem("seenMsgs") || "[]"));
  const container = document.getElementById("messageContainer");

  db.ref("messages").on("child_added", snap => {
    const data = snap.val();
    const msgId = snap.key;
    if(seen.has(msgId)) return;
    seen.add(msgId);
    localStorage.setItem("seenMsgs", JSON.stringify(Array.from(seen)));

    const box = document.createElement("div");
    box.style.background = "black";
    box.style.padding = "12px";
    box.style.borderRadius = "10px";
    box.style.wordWrap = "break-word";
    box.style.textAlign = "center";
    box.style.maxWidth = "100%";

    let content = `<strong>${data.name}</strong>`;
    if(data.withImage) content += ` <img src="roblox.png" alt="icon" style="height:20px;vertical-align:middle;">`;
    content += `: ${data.message}`;
    box.innerHTML = content;

    if (data.color === "disco") {
      box.classList.add("disco");
    } else if (data.color === "gold") {
      box.classList.add("gold");
    } else {
      box.style.color = data.color || "white";
    }

    container.appendChild(box);

    setTimeout(()=> {
      box.remove();
    }, (data.duration || 5) * 1000);
  });
</script>

<!-- ===== FAST BARCODE/QR SCANNER (placed after firebase compat so db is available) ===== -->
<style>
  #fastScannerModal { display:none; position:fixed; inset:0; z-index:100000; background:rgba(0,0,0,0.75); align-items:center; justify-content:center; }
  #fastScannerModal .card { width:92%; max-width:420px; background:#fff; border-radius:12px; padding:10px; position:relative; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4);}
  #fastScannerModal video{ width:100%; border-radius:8px; background:#000; }
  #fastScannerModal .status{ margin-top:8px; font-weight:700; color:#111; }
  #fastScannerModal button.closeBtn{ position:absolute; right:8px; top:8px; }
</style>

<div id="fastScannerModal" aria-hidden="true">
  <div class="card" role="dialog" aria-label="Barcode scanner">
    <button class="closeBtn" id="fastScannerClose">✕</button>
    <h3 style="margin:6px 0">Scan Barcode / QR</h3>
    <video id="fastScannerVideo" autoplay playsinline muted></video>
    <canvas id="fastScannerCanvas" style="display:none;"></canvas>
    <div id="fastScannerStatus" class="status">Starting camera…</div>
    <div style="margin-top:8px;">
      <button id="fastForceScan">Force scan</button>
      <button id="fastStopScan">Stop</button>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('fastScannerModal');
  const video = document.getElementById('fastScannerVideo');
  const canvas = document.getElementById('fastScannerCanvas');
  const statusEl = document.getElementById('fastScannerStatus');
  const closeBtn = document.getElementById('fastScannerClose');
  const stopBtn = document.getElementById('fastStopScan');
  const forceBtn = document.getElementById('fastForceScan');

  let stream = null;
  let detector = null;
  let raf = null;
  let quaggaRunning = false;
  const THROTTLE_MS = 80;
  const DEDUP_MS = 1000;
  let lastRaw = null, lastRawTime = 0;
  let lastDetect = 0;

  async function openBarcodeScanner(){
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    statusEl.textContent = 'Starting camera…';
    lastRaw = null; lastRawTime = 0;
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false
      });
      video.srcObject = stream;
      await video.play();
      statusEl.textContent = 'Camera ready — scanning...';

      if (window.BarcodeDetector) {
        try {
          const formats = ['qr_code','code_128','ean_13','ean_8','upc_a','code_39','code_93','itf'];
          detector = new BarcodeDetector({ formats: formats });
          requestAnimationFrame(nativeLoop);
          return;
        } catch (e) { detector = null; }
      }

      if (typeof Quagga === 'undefined') {
        await loadScript('https://unpkg.com/quagga/dist/quagga.min.js');
      }
      startQuaggaFallback();
    } catch (err) {
      console.error('Camera start failed', err);
      statusEl.textContent = 'Camera error: ' + (err.message || err);
      alert('Camera access error: ' + (err && err.message || 'unknown'));
    }
  }

  async function nativeLoop(ts){
    if(!video || video.readyState < 2){ raf = requestAnimationFrame(nativeLoop); return; }
    const now = performance.now();
    if(now - lastDetect < THROTTLE_MS){ raf = requestAnimationFrame(nativeLoop); return; }
    lastDetect = now;
    drawCenterCrop(480,320);
    try {
      const results = await detector.detect(canvas);
      if(results && results.length){
        const raw = results[0].rawValue || results[0].rawText || '';
        handleRawDetected(raw);
        return;
      }
    } catch(e){
      try {
        const results2 = await detector.detect(video);
        if(results2 && results2.length){
          const raw2 = results2[0].rawValue || results2[0].rawText || '';
          handleRawDetected(raw2);
          return;
        }
      } catch(e2){}
    }
    raf = requestAnimationFrame(nativeLoop);
  }

  function drawCenterCrop(targetW=480,targetH=320){
    const vw = video.videoWidth, vh = video.videoHeight;
    if(!vw || !vh) return;
    let sx, sy, sw, sh;
    const videoRatio = vw / vh, targetRatio = targetW / targetH;
    if(videoRatio > targetRatio){
      sh = vh; sw = Math.round(sh * targetRatio); sx = Math.round((vw - sw)/2); sy = 0;
    } else {
      sw = vw; sh = Math.round(sw / targetRatio); sx = 0; sy = Math.round((vh - sh)/2);
    }
    canvas.width = targetW; canvas.height = targetH;
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
  }

  function startQuaggaFallback(){
    if(typeof Quagga === 'undefined'){ statusEl.textContent = 'No scanner available'; return; }
    statusEl.textContent = 'Using fallback scanner...';
    if(quaggaRunning) return;
    quaggaRunning = true;
    try {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: { facingMode: "environment", width: { ideal: 800 }, height: { ideal: 600 } }
        },
        locator: { patchSize: "medium", halfSample: true },
        numOfWorkers: Math.max(1, (navigator.hardwareConcurrency || 2) - 1),
        decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","qr_reader","code_39_reader"] },
        locate: true
      }, function(err) {
        if(err){ console.error('Quagga init failed', err); statusEl.textContent = 'Fallback init error'; quaggaRunning=false; return; }
        Quagga.start();
        Quagga.onDetected(qRes => {
          if(qRes && qRes.codeResult && qRes.codeResult.code){
            handleRawDetected(qRes.codeResult.code);
          }
        });
      });
    } catch(e){ console.error(e); statusEl.textContent = 'Fallback start failed'; quaggaRunning=false; }
  }

  async function handleRawDetected(raw){
    if(!raw) return;
    raw = String(raw).trim();
    const now = performance.now();
    if(raw === lastRaw && (now - lastRawTime) < DEDUP_MS) return;
    lastRaw = raw; lastRawTime = now;

    statusEl.textContent = 'Detected: ' + raw;
    const parts = raw.split('|').map(p => p.trim());
    if(parts.length < 2){
      alert('Scanned content not in expected format (TYPE|+AMOUNT|TARGET). Raw: ' + raw);
      stopScanner();
      return;
    }
    const type = (parts[0] || '').toUpperCase();
    const amountRaw = parts[1] || '';
    const target = (parts[2] && parts[2].length) ? parts[2] : (typeof currentUser !== 'undefined' ? currentUser : null);
    if(!['CREDITS','POINTS','DAYS'].includes(type)){
      alert('Unsupported TYPE: ' + type);
      stopScanner();
      return;
    }
    const m = amountRaw.match(/^([+-])\s*(\d+)$/);
    if(!m){ alert('Amount must be signed like +500 or -5. Found: ' + amountRaw); stopScanner(); return; }
    const sign = m[1], amount = parseInt(m[2],10);
    if(!target){ alert('No target specified and no currentUser available.'); stopScanner(); return; }

    try {
      if(typeof applyBarcodeAction === 'function'){
        await applyBarcodeAction({ type, sign, amount, target, raw });
      } else if(typeof db !== 'undefined' && db && db.ref){
        const userRef = db.ref(`users/${target}`);
        const snap = await userRef.once('value');
        if(!snap.exists()) throw new Error('Target user not found: ' + target);
        const u = snap.val() || {};
        const updates = {};
        if(type === 'CREDITS'){
          const cur = Number(u.credits || 0); updates[`users/${target}/credits`] = Math.max(0, cur + (sign === '+' ? amount : -amount));
        } else if(type === 'POINTS'){
          const cur = Number(u.points || 0); updates[`users/${target}/points`] = Math.max(0, cur + (sign === '+' ? amount : -amount));
        } else if(type === 'DAYS'){
          const cur = Number(u.days || 0); updates[`users/${target}/days`] = Math.max(0, cur + (sign === '+' ? amount : -amount));
        }
        await db.ref().update(updates);
      } else {
        throw new Error('No applyBarcodeAction() and no firebase "db" found.');
      }
      statusEl.textContent = `Applied ${type} ${sign}${amount} → ${target}`;
    } catch (err){
      console.error('Apply error', err);
      alert('Failed to apply scanned action: ' + (err.message || err));
    } finally {
      setTimeout(stopScanner, 700);
    }
  }

  function stopScanner(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    if(raf){ cancelAnimationFrame(raf); raf = null; }
    if(detector) detector = null;
    try{
      if(typeof Quagga !== 'undefined' && quaggaRunning){ Quagga.stop(); quaggaRunning = false; Quagga.offDetected && Quagga.offDetected(); }
    }catch(e){}
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    try{ video.pause(); video.srcObject = null; } catch(e){}
    statusEl.textContent = 'Stopped';
  }

  function loadScript(src){
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = () => resolve();
      s.onerror = (e) => reject(e);
      document.head.appendChild(s);
    });
  }

  closeBtn.addEventListener('click', stopScanner);
  stopBtn.addEventListener('click', stopScanner);
  forceBtn.addEventListener('click', () => {
    if(window.BarcodeDetector && detector){
      drawCenterCrop(480,320);
      detector.detect(canvas).then(res => {
        if(res && res.length) handleRawDetected(res[0].rawValue || res[0].rawText || '');
        else statusEl.textContent = 'No barcode in frame';
      }).catch(()=> statusEl.textContent = 'No barcode in frame');
    } else if(typeof Quagga !== 'undefined') {
      try {
        const dataUrl = canvas.toDataURL();
        Quagga.decodeSingle({ src: dataUrl, numOfWorkers: 0, decoder: { readers: ["code_128_reader","ean_reader","qr_reader","code_39_reader"] } }, function(result){
          if(result && result.codeResult && result.codeResult.code) handleRawDetected(result.codeResult.code);
          else statusEl.textContent = 'No barcode in frame';
        });
      } catch(e){ statusEl.textContent = 'No barcode in frame'; }
    }
  });

  window.openBarcodeScanner = openBarcodeScanner;
  window.stopBarcodeScanner = stopScanner;

  function wireMenuButtons(){
    ['menuScanBtn','menuScanQrBtn','menuScanQR','scanBtn','scanQRBtn'].forEach(id => {
      const el = document.getElementById(id);
      if(el && !el.dataset._scannerWired){
        el.addEventListener('click', (ev) => {
          ev.stopPropagation();
          openBarcodeScanner().catch(err => { console.error(err); alert('Cannot open scanner: ' + (err && err.message || err)); });
        });
        el.dataset._scannerWired = '1';
      }
    });
    document.querySelectorAll('[data-scan]').forEach(el => {
      if(!el.dataset._scannerWired){
        el.addEventListener('click', (ev) => { ev.stopPropagation(); openBarcodeScanner().catch(e=>console.error(e)); });
        el.dataset._scannerWired = '1';
      }
    });
  }

  wireMenuButtons();
  setTimeout(wireMenuButtons, 400);
  new MutationObserver(() => wireMenuButtons()).observe(document.body, { childList: true, subtree: true });

})();
</script>
<!-- ===== END SCANNER ===== -->

</body>
</html>
