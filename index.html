<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Login, Report, Shop & Credits Sender with Signature</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2b4c7e" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<style>
body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 30px auto;
    padding: 10px;
    background: linear-gradient(135deg, #f0f4f9, #d9e4f5);
    color: #333;
}
h2, h3 { color: #2b4c7e; margin-bottom: 10px; }
button, input, select {
    width: 100%; padding: 10px; margin-top: 6px;
    font-size: 1rem; box-sizing: border-box;
    border-radius: 6px; border: 1px solid #ccc;
}
button {
    background: #2b4c7e; color: white; cursor: pointer;
}
button:hover { background: #1f3557; }

#user-info {
    position: fixed; top: 10px; left: 10px;
    background: white; padding: 10px 15px; border-radius: 8px;
    font-weight: bold; display: none; z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
#logoutBtn { background: #e74c3c; margin-top: 8px; }
#logoutBtn:hover { background: #c0392b; }

#login-form, #report-form {
    background: white; padding: 20px; border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}
label { font-weight: bold; margin-top: 15px; display: block; }

.rules-list {
    margin-top: 10px; max-height: 250px; overflow-y: auto;
    border: 1px solid #ccc; padding: 10px; border-radius: 6px;
    background: #fafafa;
}
.rule-item {
    padding: 8px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.rule-item:hover { background: #e6f0ff; }
.rule-item.selected { background: #2b4c7e; color: white; }
.rule-details { font-size: 0.9rem; color: inherit; margin-top: 4px; flex-basis: 100%; }
.rule-qty {
    width: 50px;
    margin-left: 10px;
}

.action-buttons { margin-top: 20px; text-align: center; }
.action-buttons button {
    width: auto; padding: 10px 15px; margin: 5px;
    border-radius: 25px; font-weight: bold;
}
.action-buttons button:nth-child(1) { background: #27ae60; }
.action-buttons button:nth-child(1):hover { background: #1e8449; }
.action-buttons button:nth-child(2) { background: #2980b9; }
.action-buttons button:nth-child(2):hover { background: #1f6391; }

#shopContainer, #creditsSenderContainer {
    border: 1px solid #ccc; padding: 15px; margin-top: 15px;
    border-radius: 8px; background: white;
    max-height: 0; overflow: hidden; opacity: 0;
    transform: scaleY(0.9);
    transition: all 0.4s ease;
}
#shopContainer.show, #creditsSenderContainer.show {
    max-height: 800px; opacity: 1; transform: scaleY(1);
}
</style>
</head>
<body>

<div id="user-info">
    Days: <span id="days-count">0</span> | Credits: <span id="credits-count">0</span> | Signature Days Left: <span id="sig-days-left">0</span>
    <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="login-form">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <label><input type="checkbox" id="keepSignedIn"> Keep me signed in</label>
    <button id="loginBtn">Login</button>
</div>

<div id="report-form" style="display:none;">
    <h2>Report Form</h2>
    <form id="reportForm">
        <label>Your Username</label>
        <input type="text" id="reporter" readonly />
        <label>Who is this report on?</label>
        <select id="reportedUser" required></select>
        <label>Rules broken:</label>
        <div class="rules-list" id="rulesList"></div>
        <div id="total-days">Total Days Penalty: 0</div>
        <button type="submit" style="margin-top:20px;">Submit Report</button>
    </form>
</div>

<div class="action-buttons" id="action-buttons" style="display:none;">
    <hr>
    <button onclick="togglePanel('shopContainer')">Toggle Shop</button>
    <button onclick="togglePanel('creditsSenderContainer')">Toggle Send Credits</button>
</div>

<div id="shopContainer">
    <h3>- Days Shop</h3>
    <button onclick="buyItem(1000, -5)">Buy: 1000 credits → -5 days</button><br>
    <button onclick="buyItem(2000, -15)">Buy: 2000 credits → -15 days</button><br>
</div>

<div id="creditsSenderContainer">
    <h3>Send Credits</h3>
    <label>Send to:</label>
    <select id="sendToUser"></select>
    <label>Amount:</label>
    <input type="number" id="sendAmount" min="1">
    <button onclick="sendCredits()">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null, currentUserData = null;
const daysSpan = document.getElementById("days-count");
const creditsSpan = document.getElementById("credits-count");
const sigDaysLeftSpan = document.getElementById("sig-days-left");
const reportedUserSelect = document.getElementById("reportedUser");
const sendToUserSelect = document.getElementById("sendToUser");
const reporterInput = document.getElementById("reporter");
const logoutBtn = document.getElementById("logoutBtn");

const rules = [
    { id: 'no_hit', title: 'No hit', days: 1, details: 'Do not physically hurt anyone, as a joke is ok +1 days.' },
    { id: 'no_scream', title: 'No scream', days: 5, details: 'Speak calmly, only when you are excited or angry +5 days.' },
    { id: 'no_cry', title: 'No cry', days: 1, details: 'Crying is not allowed +1 days.' },
    { id: 'zeyad_devices', title: 'Zeyad can no longer make you play with devices when you have days.', days: 20, details: 'If Zeyad makes you play with devices when you have days, +20 days to Zeyad!' },
    { id: 'no_fetn', title: 'No fetn', days: 100, details: 'Don\'t make FETN. If someone tells you “blip” please don’t tell or repeat it to anyone. +100 days.' },
    { id: 'no_bother', title: 'No bother', days: 5, details: 'Respect others. Don’t annoy them. +5 days.' },
    { id: 'respect', title: 'You have to respect', days: 10, details: 'Treat everyone kindly and with respect, always. +10 days.' },
    { id: 'cute', title: 'CUTE +50 DAYS', days: 50, details: 'Be cute for 5 minutes = +50 days!' },
    { id: 'no_listen', title: 'No listen', days: 50, details: 'You have to listen! If not, +50 days.' },
    { id: 'play_zezo', title: 'Play with Zezo', days: 50, details: 'You must play with Zezo. If not, +50 days.' },
    { id: 'no_sad', title: 'No sad', days: 10, details: 'Don’t be sad or +10 days.' },
    { id: 'no_devices', title: 'No devices when u have days each minute = 5 days', days: 5, details: 'When you have days, don’t use devices. Each minute = +5 days!' },
    { id: 'no_copy', title: 'No copy', days: 100, details: 'You need proof (note, message) that someone gave you permission to copy them.' },
    { id: 'no_angry', title: 'No angry', days: 5, details: 'Don’t be mad +5 days.' },
    { id: 'dont_ask_zeyad', title: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS', days: 50, details: 'DONT ASK ZEYAD TO MAKE YOU PLAY WITH DEVICES IF YOU HAVE DAYS +50 DAYS' },
];

// Render rules list
function renderRules() {
    const container = document.getElementById('rulesList');
    container.innerHTML = '';
    rules.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'rule-item';
        div.dataset.id = r.id;
        div.dataset.days = r.days;

        const textContainer = document.createElement('div');
        textContainer.style.flex = "1";
        textContainer.innerHTML = `<strong>${r.title}</strong><div class="rule-details">${r.details}</div>`;

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.min = 0;
        qtyInput.value = 0;
        qtyInput.className = 'rule-qty';
        qtyInput.addEventListener('input', updateTotalDays);

        div.appendChild(textContainer);
        div.appendChild(qtyInput);

        div.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'input') {
                div.classList.toggle('selected');
                if (div.classList.contains('selected') && qtyInput.value == 0) qtyInput.value = 1;
                else if (!div.classList.contains('selected')) qtyInput.value = 0;
                updateTotalDays();
            }
        });

        container.appendChild(div);
        if (i < rules.length - 1) container.appendChild(document.createElement('hr'));
    });
}

renderRules();

function updateTotalDays() {
    let total = 0;
    document.querySelectorAll('.rule-item').forEach(item => {
        const qty = parseInt(item.querySelector('input').value) || 0;
        const daysPerOffense = parseInt(item.dataset.days);
        total += daysPerOffense * qty;
    });
    document.getElementById('total-days').textContent = `Total Days Penalty: ${total}`;
}

async function loadUsersDropdowns() {
    const snap = await get(ref(db, "users"));
    if (snap.exists()) {
        reportedUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
        sendToUserSelect.innerHTML = `<option disabled selected>Select user</option>`;
        Object.keys(snap.val()).forEach(user => {
            reportedUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
            if (user !== currentUser) sendToUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
        });
    }
}

async function login(username, password, keep) {
    const snap = await get(ref(db, `users/${username}`));
    if (!snap.exists()) return alert("User not found");
    const data = snap.val();
    if (data.password !== password) return alert("Incorrect password");

    // Check signature
    const sig = data.signature;
    let now = Date.now();
    let sigExpired = true;
    let daysLeft = 0;

    if (sig && sig.expiry) {
        const expiry = sig.expiry;
        if (expiry > now) {
            sigExpired = false;
            daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        }
    }

    if (sigExpired) {
        // Reset user (clear days, credits, signature)
        await update(ref(db, `users/${username}`), {
            days: 0,
            credits: 0,
            signature: null
        });
        alert("Your signature expired or not found. You need to create a new signature now.");
        window.location.href = "signature.html?user=" + encodeURIComponent(username);
        return;
    }

    currentUser = username;
    currentUserData = data;
    daysSpan.textContent = data.days || 0;
    creditsSpan.textContent = data.credits || 0;
    sigDaysLeftSpan.textContent = daysLeft;

    document.getElementById("user-info").style.display = "block";
    document.getElementById("login-form").style.display = "none";
    document.getElementById("report-form").style.display = "block";
    document.getElementById("action-buttons").style.display = "block";
    logoutBtn.style.display = "inline-block";
    reporterInput.value = username;

    await loadUsersDropdowns();

    // Prompt renewal if 5 or fewer days left
    if (daysLeft <= 5) {
        if(confirm(`Your signature expires in ${daysLeft} day(s). Do you want to renew your signature now?`)) {
            window.location.href = "signature.html?user=" + encodeURIComponent(username);
            return;
        }
    }
}

document.getElementById("loginBtn").addEventListener("click", () => {
    const u = username.value.trim().toLowerCase(), p = password.value, keep = keepSignedIn.checked;
    if (!u || !p) return alert("Enter username and password");
    login(u, p, keep);
});

logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("savedUser");
    localStorage.removeItem("savedPass");
    location.reload();
});

window.addEventListener("load", () => {
    const u = localStorage.getItem("savedUser"), p = localStorage.getItem("savedPass");
    if (u && p) login(u, p, true);
});

window.togglePanel = function(id) {
    document.getElementById(id).classList.toggle("show");
};

window.buyItem = async function(price, dayChange) {
    if (!currentUserData) return;
    if ((currentUserData.credits || 0) < price) return alert("Not enough credits");
    currentUserData.credits -= price; currentUserData.days = (currentUserData.days || 0) + dayChange;
    await update(ref(db, `users/${currentUser}`), { credits: currentUserData.credits, days: currentUserData.days });
    creditsSpan.textContent = currentUserData.credits; daysSpan.textContent = currentUserData.days;
    alert(`Purchased! Days changed by ${dayChange}`);
};

window.sendCredits = async function() {
    const toUser = sendToUserSelect.value;
    const amount = parseInt(sendAmount.value);
    if (!toUser) return alert("Select a user");
    if (!amount || amount <= 0) return alert("Enter valid amount");

    // Refresh latest credits
    const selfSnap = await get(ref(db, `users/${currentUser}`));
    if (!selfSnap.exists()) return alert("Your account could not be found");
    currentUserData = selfSnap.val();

    if ((currentUserData.credits || 0) < amount) {
        alert("Not enough credits");
        return;
    }

    const toSnap = await get(ref(db, `users/${toUser}`));
    if (!toSnap.exists()) return alert("Recipient not found");
    const toData = toSnap.val();

    await update(ref(db, `users/${currentUser}`), { credits: currentUserData.credits - amount });
    await update(ref(db, `users/${toUser}`), { credits: (toData.credits || 0) + amount });
    currentUserData.credits -= amount;
    creditsSpan.textContent = currentUserData.credits;

    alert(`Sent ${amount} credits to ${toUser}`);
};

// Report form submit
document.getElementById("reportForm").addEventListener("submit", async e => {
    e.preventDefault();
    if (!currentUser) return alert("Login first");
    const target = reportedUserSelect.value;
    if (!target) return alert("Select user reported");

    // Collect selected rules with quantity
    const penalties = [];
    let totalDays = 0;
    document.querySelectorAll(".rule-item").forEach(item => {
        if (item.classList.contains("selected")) {
            const qty = parseInt(item.querySelector("input").value) || 1;
            penalties.push({ id: item.dataset.id, qty });
            totalDays += qty * parseInt(item.dataset.days);
        }
    });

    if (totalDays === 0) return alert("Select at least one rule violation");

    // Push report
    const reportsRef = ref(db, "reports");
    await push(reportsRef, {
        reporter: currentUser,
        reported: target,
        penalties,
        totalDays,
        timestamp: Date.now()
    });

    // Add days to reported user
    const targetRef = ref(db, `users/${target}`);
    const targetSnap = await get(targetRef);
    if (!targetSnap.exists()) return alert("Reported user not found");
    const targetData = targetSnap.val();
    const newDays = (targetData.days || 0) + totalDays;
    await update(targetRef, { days: newDays });
    alert(`Report submitted. ${totalDays} days added to ${target}.`);
    updateTotalDays();
    // Reset form
    document.querySelectorAll(".rule-item.selected").forEach(item => {
        item.classList.remove("selected");
        item.querySelector("input").value = 0;
    });
    reportedUserSelect.value = "";
});

// Disable forms on logout
function resetForm() {
    document.getElementById("user-info").style.display = "none";
    document.getElementById("login-form").style.display = "block";
    document.getElementById("report-form").style.display = "none";
    document.getElementById("action-buttons").style.display = "none";
    logoutBtn.style.display = "none";
    currentUser = null;
    currentUserData = null;
    username.value = "";
    password.value = "";
    reportedUserSelect.innerHTML = "";
    sendToUserSelect.innerHTML = "";
}

</script>
</body>
</html>
