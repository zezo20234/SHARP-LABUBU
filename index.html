<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3-Team Tournament — Stylish</title>
  <style>
    :root{--accent:#0ea5a4;--muted:#6b7280;--card:#ffffff;--glass:rgba(15,23,42,0.04)}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:#ffffff;color:#0f1724}

    /* layout */
    .container{max-width:1200px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:22px}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px}}

    /* main card */
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.06);border:1px solid rgba(15,23,42,0.04)}
    h1{font-size:22px;margin:0 0 6px}
    .lead{color:var(--muted);margin:0 0 14px}

    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:transparent;cursor:pointer}
    .btn.primary{background:var(--accent);color:white;border:none}
    .btn.ghost{background:transparent}

    /* matches list */
    .matches{display:flex;flex-direction:column;gap:12px;margin-top:14px}
    .match{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,0.04);background:linear-gradient(180deg,rgba(14,165,164,0.02),transparent)}
    .teams{display:flex;gap:12px;align-items:center}
    .teamBadge{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:120px;padding:8px;border-radius:10px;background:rgba(15,23,42,0.02);font-weight:700}
    .meta{color:var(--muted);font-size:13px;margin-right:8px}

    /* modal */
    .modalBack{position:fixed;inset:0;background:rgba(2,6,23,0.52);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width:420px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.2)}
    .scores{display:flex;gap:10px;align-items:center}
    input[type=number]{width:84px;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}

    /* right column / leaderboard */
    .rightCol{display:flex;flex-direction:column;gap:16px}
    .leaderboardCard{padding:14px;border-radius:14px}
    .lbTitle{display:flex;align-items:center;justify-content:space-between}
    .pill{display:flex;align-items:center;gap:12px;padding:10px;border-radius:999px;background:linear-gradient(90deg,rgba(14,165,164,0.08),rgba(99,102,241,0.02));border:1px solid rgba(15,23,42,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    .pill img{width:64px;height:64px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,255,255,0.5)}
    .pill .info{flex:1}
    .pill .info .name{font-weight:700}
    .pill .stats{min-width:120px;text-align:right}
    .statRow{font-size:13px;color:var(--muted)}

    .notice{padding:10px;border-radius:10px;background:#fffbeb;border:1px solid #fef3c7;color:#92400e}

    footer{margin-top:16px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <main class="card">
      <h1>3-Team Tournament</h1>
      <p class="lead">Round-robin group: each team plays 2 matches. After all group matches are completed, the Final is automatically scheduled between the top 2 teams.</p>

      <div class="controls">
        <button id="resetBtn" class="btn">Reset Tournament</button>
        <button id="manualFinal" class="btn ghost">Create Final Now</button>
      </div>

      <div id="noticeHolder" style="margin-top:12px"></div>

      <div class="matches" id="matches"></div>

      <footer>Click "Add score" to record goals. Win = 3 pts, Draw = 1 pt, Loss = 0 pts.</footer>
    </main>

    <aside class="rightCol">
      <div class="card leaderboardCard">
        <div class="lbTitle">
          <div>
            <div style="font-weight:800">Leaderboard</div>
            <div style="font-size:13px;color:var(--muted)">Best → Worst (auto-sorted)</div>
          </div>
          <div style="font-size:13px;color:var(--muted);align-self:flex-start">Teams</div>
        </div>

        <div style="height:12px"></div>
        <div id="leaderboardList" style="display:flex;flex-direction:column;gap:10px"></div>
      </div>

      <div class="card" style="padding:14px">
        <div style="font-weight:700">Tournament Snapshot</div>
        <div style="height:10px"></div>
        <div id="snapshot" style="color:var(--muted)"></div>
      </div>
    </aside>
  </div>

  <!-- Modal to add score -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3 id="modalTitle">Add Score</h3>
      <div style="height:10px"></div>
      <div class="scores">
        <div style="flex:1;text-align:center">
          <div id="t1name" style="font-weight:700;color:var(--muted)"></div>
          <input type="number" id="t1score" min="0" value="0">
        </div>
        <div style="padding:0 6px;color:var(--muted);font-weight:700">—</div>
        <div style="flex:1;text-align:center">
          <div id="t2name" style="font-weight:700;color:var(--muted)"></div>
          <input type="number" id="t2score" min="0" value="0">
        </div>
      </div>
      <div style="height:14px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="cancelModal" class="btn">Cancel</button>
        <button id="saveScore" class="btn primary">Save score</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config (from user)
    const firebaseConfig = {
      apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
      authDomain: "sharplabubu.firebaseapp.com",
      databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
      projectId: "sharplabubu",
      storageBucket: "sharplabubu.firebasestorage.app",
      messagingSenderId: "596148393481",
      appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
      measurementId: "G-4M25R3BF08"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const dbRef = db.ref('tourney3');

    // --- default state with picture field for each team ---
    const defaultState = {
      teams: {
        A: {name:'Team A', pic:'https://via.placeholder.com/160x160.png?text=A', pts:0, gf:0, ga:0, played:0, wins:0, draws:0, losses:0},
        B: {name:'Team B', pic:'https://via.placeholder.com/160x160.png?text=B', pts:0, gf:0, ga:0, played:0, wins:0, draws:0, losses:0},
        C: {name:'Team C', pic:'https://via.placeholder.com/160x160.png?text=C', pts:0, gf:0, ga:0, played:0, wins:0, draws:0, losses:0}
      },
      matches: [
        {id:'m1', t1:'A', t2:'B', s1:null, s2:null, stage:'group'},
        {id:'m2', t1:'A', t2:'C', s1:null, s2:null, stage:'group'},
        {id:'m3', t1:'B', t2:'C', s1:null, s2:null, stage:'group'}
      ],
      final: null
    }

    let state = JSON.parse(JSON.stringify(defaultState))

    // load or create
    async function initState(){
      try{
        const snap = await dbRef.get()
        if(snap.exists()) state = snap.val()
        else { await dbRef.set(defaultState); state = JSON.parse(JSON.stringify(defaultState)) }
      }catch(e){ console.error('Firebase error, using default', e); state = JSON.parse(JSON.stringify(defaultState)) }
    }

    // realtime update
    dbRef.on('value', (snap)=>{
      if(snap.exists()){
        state = snap.val()
        renderAll()
      }
    })

    async function saveState(){
      try{ await dbRef.set(state) }catch(e){console.error('Save failed',e)}
    }

    // --- UI rendering ---
    const matchesEl = document.getElementById('matches')
    const leaderboardList = document.getElementById('leaderboardList')
    const snapshotEl = document.getElementById('snapshot')
    const noticeHolder = document.getElementById('noticeHolder')

    function formatMatchRow(m){
      const div = document.createElement('div');div.className='match'
      const teams = document.createElement('div');teams.className='teams'
      const a = state.teams[m.t1]; const b = state.teams[m.t2]
      const t1 = document.createElement('div');t1.className='teamBadge';t1.innerHTML=`<div style="font-size:13px;color:var(--muted)">`+a.name+`</div>`
      const t2 = document.createElement('div');t2.className='teamBadge';t2.innerHTML=`<div style="font-size:13px;color:var(--muted)">`+b.name+`</div>`
      teams.appendChild(t1);teams.appendChild(t2)

      const right = document.createElement('div');right.style.display='flex';right.style.alignItems='center';right.style.gap='10px'
      const meta = document.createElement('div');meta.className='meta';meta.textContent = m.stage === 'group' ? 'Group' : 'Final'
      const score = document.createElement('div');score.style.fontWeight='700'
      score.textContent = (m.s1===null) ? '- : -' : `${m.s1} : ${m.s2}`
      const btn = document.createElement('button');btn.className='btn';btn.textContent='Add score';btn.onclick=()=>openModal(m.id)

      right.appendChild(meta);right.appendChild(score);right.appendChild(btn)
      div.appendChild(teams);div.appendChild(right)
      return div
    }

    function renderMatches(){
      matchesEl.innerHTML=''
      const all = [...state.matches]
      if(state.final) all.push(state.final)
      all.forEach(m=>matchesEl.appendChild(formatMatchRow(m)))
    }

    function calcStandings(){
      Object.keys(state.teams).forEach(k=>{
        const t = state.teams[k]
        t.pts=0;t.gf=0;t.ga=0;t.played=0;t.wins=0;t.draws=0;t.losses=0
      })
      const all = [...state.matches]
      all.forEach(m=>{
        if(m.s1===null) return
        const a = state.teams[m.t1]
        const b = state.teams[m.t2]
        a.gf += m.s1; a.ga += m.s2; a.played++
        b.gf += m.s2; b.ga += m.s1; b.played++
        if(m.s1>m.s2){a.wins++; a.pts+=3; b.losses++}
        else if(m.s2>m.s1){b.wins++; b.pts+=3; a.losses++}
        else {a.draws++; b.draws++; a.pts+=1; b.pts+=1}
      })
    }

    function getSortedTable(){
      calcStandings()
      const arr = Object.entries(state.teams).map(([k,v])=>({key:k,...v}))
      arr.sort((x,y)=>{
        if(y.pts!==x.pts) return y.pts-x.pts
        const gdx = x.gf - x.ga; const gdy = y.gf - y.ga
        if(gdy!==gdx) return gdy-gdx
        if(y.gf!==x.gf) return y.gf-x.gf
        return x.key.localeCompare(y.key)
      })
      return arr
    }

    function renderLeaderboard(){
      const sorted = getSortedTable()
      leaderboardList.innerHTML=''
      sorted.forEach((t,i)=>{
        const pill = document.createElement('div');pill.className='pill'
        const img = document.createElement('img');img.src = t.pic || 'https://via.placeholder.com/160x160.png?text=?'; img.alt = t.name
        const info = document.createElement('div');info.className='info'
        const name = document.createElement('div');name.className='name';name.textContent = `${i+1}. ${t.name}`
        const meta = document.createElement('div');meta.className='statRow';meta.textContent = `${t.pts} pts • ${t.gf} GF • ${t.ga} GA`;
        info.appendChild(name);info.appendChild(meta)
        const stats = document.createElement('div');stats.className='stats';stats.innerHTML = `<div style=\"font-weight:700\">GD: ${t.gf - t.ga}</div><div class=\"statRow\">Played: ${t.played}</div>`
        pill.appendChild(img);pill.appendChild(info);pill.appendChild(stats)
        leaderboardList.appendChild(pill)
      })
    }

    function renderSnapshot(){
      const arr = getSortedTable()
      let txt = ''
      arr.forEach((t,i)=>{
        txt += `${i+1}. ${t.name} — ${t.pts} pts, ${t.gf} GF, ${t.ga} GA` + '
'
      })
      snapshotEl.textContent = txt
    }

    function renderAll(){
      renderMatches(); renderLeaderboard(); renderSnapshot(); renderNotice();
    }

    // --- modal logic ---
    const modalBack = document.getElementById('modalBack')
    const t1name = document.getElementById('t1name')
    const t2name = document.getElementById('t2name')
    const t1score = document.getElementById('t1score')
    const t2score = document.getElementById('t2score')
    let currentMatchId = null

    function openModal(matchId){
      currentMatchId = matchId
      const m = (state.matches.find(x=>x.id===matchId) || (state.final && state.final.id===matchId && state.final))
      if(!m) return
      t1name.textContent = state.teams[m.t1].name
      t2name.textContent = state.teams[m.t2].name
      t1score.value = m.s1===null?0:m.s1
      t2score.value = m.s2===null?0:m.s2
      document.getElementById('modalTitle').textContent = (m.stage==='group'?'Record group score':'Record final score')
      modalBack.style.display='flex'
    }
    document.getElementById('cancelModal').onclick = ()=>{modalBack.style.display='none';currentMatchId=null}
    document.getElementById('saveScore').onclick = async ()=>{
      const s1 = Math.max(0,parseInt(t1score.value)||0)
      const s2 = Math.max(0,parseInt(t2score.value)||0)
      let m = state.matches.find(x=>x.id===currentMatchId)
      if(!m && state.final && state.final.id===currentMatchId) m = state.final
      if(!m) return
      m.s1 = s1; m.s2 = s2
      await saveState(); modalBack.style.display='none'; currentMatchId=null
      // after save, check for final creation will be handled by realtime listener but also call check
      // small delay to allow state to settle
    }

    // --- final auto-create logic ---
    async function checkAndCreateFinal(){
      const allGroupPlayed = state.matches.every(m=>m.s1!==null)
      if(allGroupPlayed && !state.final){
        const sorted = getSortedTable()
        const t1 = sorted[0].key; const t2 = sorted[1].key
        state.final = {id:'final', t1, t2, s1:null, s2:null, stage:'final'}
        await saveState()
        // notification will come from realtime listener; also show quick notice
        showNotice(`Final scheduled automatically: ${state.teams[t1].name} vs ${state.teams[t2].name}`)
      }
    }

    // manual final creation button (overrides)
    document.getElementById('manualFinal').onclick = async ()=>{
      const sorted = getSortedTable();
      const t1 = sorted[0].key; const t2 = sorted[1].key
      state.final = {id:'final', t1, t2, s1:null, s2:null, stage:'final'}
      await saveState();
      showNotice(`Final scheduled: ${state.teams[t1].name} vs ${state.teams[t2].name}`)
    }

    // reset
    document.getElementById('resetBtn').onclick = async ()=>{
      if(!confirm('Reset tournament? This clears scores.')) return
      state = JSON.parse(JSON.stringify(defaultState))
      await saveState()
    }

    // notices
    function showNotice(msg, timeout=4500){
      noticeHolder.innerHTML = `<div class=\"notice\">${msg}</div>`
      setTimeout(()=>{ if(noticeHolder.innerHTML) noticeHolder.innerHTML = '' }, timeout)
    }

    function renderNotice(){
      // if final scheduled show small info
      if(state.final){
        const m = state.final
        const status = (m.s1===null) ? `Scheduled: ${state.teams[m.t1].name} vs ${state.teams[m.t2].name}` : `Final result: ${m.s1} : ${m.s2}`
        noticeHolder.innerHTML = `<div style=\"padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(14,165,164,0.06),transparent);border:1px solid rgba(15,23,42,0.04)\">${status}</div>`
      } else {
        // if all group played but final null, inform that system will auto-create
        const allGroupPlayed = state.matches.every(x=>x.s1!==null)
        if(allGroupPlayed) noticeHolder.innerHTML = `<div style=\"padding:10px;border-radius:10px;background:#eef2ff;border:1px solid rgba(15,23,42,0.04)\">All group matches done — final will be created automatically.</div>`
        else noticeHolder.innerHTML = ''
      }
    }

    // watch for changes and run final check after updates
    dbRef.on('value', (snap)=>{
      if(snap.exists()){
        state = snap.val(); renderAll();
        // small safety: try create final if needed
        checkAndCreateFinal().catch(e=>console.error(e))
      }
    })

    // initial boot
    (async ()=>{ await initState(); renderAll(); checkAndCreateFinal(); })()
  </script>
</body>
</html>
